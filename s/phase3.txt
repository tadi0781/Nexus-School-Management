===== PHASE 3: DASHBOARDS & ROLE VIEWS =====
-e 

===== templates/government/dashboard.html =====

{% extends "layout/base.html" %}

{# Macros - ideally in _macros.html, but defined here for now #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Key Actions & Reports</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-journal-arrow-down me-2"></i>Recent Submissions/Updates</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-file-earmark-text') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View Document <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-inbox fs-1 mb-2"></i>
                <p>No recent submissions or updates to display.</p>
            </div>
        {% endif %}
    </div>
    {# <a href="#" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Submissions <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a> #}
</div>
{% endmacro %}

{% block page_title %}Government Oversight Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-bank2 me-2 text-primary"></i>Government Oversight Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-person-fill-gear me-1"></i> My Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-secondary text-white"> {# Different color for this role #}
                <div class="card-body">
                    <h4 class="card-title font-heading">Compliance & Oversight Portal, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Access key institutional data, review compliance reports, and manage Tier 3 requests.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {# card_url for viewing student aggregate data if available (not currently passed for this card) #}
        {{ render_stat_card(
            card_title="Total Enrolled Students",
            card_value=total_students | default(0),
            card_icon="bi-person-bounding-box",
            card_color_class="text-primary"
        ) }}

        {# card_url for viewing teacher aggregate data if available (not currently passed for this card) #}
        {{ render_stat_card(
            card_title="Total Active Teachers",
            card_value=total_teachers | default(0),
            card_icon="bi-person-video",
            card_color_class="text-success"
        ) }}

        {# Gov can view all assets list #}
        {{ render_stat_card(
            card_title="Total School Assets",
            card_value=total_assets_count | default(0),
            card_icon="bi-building-check",
            card_color_class="text-info",
            card_url=url_for('list_all_assets')
        ) }}

        {# Backend should provide count of Tier 3 requests for this user #}
        {{ render_stat_card(
            card_title="Tier 3 Requests Pending",
            card_value=requests_inbox_count | default(0),
            card_icon="bi-file-earmark-ruled-fill",
            card_color_class="text-warning",
            card_url=url_for('requests_inbox')
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Compliance Status #}
        <div class="col-lg-4 col-xl-3">
            {% set gov_quick_links = [
                {'url': url_for('requests_inbox'), 'text': 'Review Tier 3 Requests', 'icon': 'bi-card-checklist', 'color_class': 'text-primary'},
                {'url': "#", 'text': 'View Compliance Reports', 'icon': 'bi-shield-fill-check', 'color_class': 'text-success'},
                {'url': "#", 'text': 'School Performance Data', 'icon': 'bi-graph-up', 'color_class': 'text-info'},
                {'url': url_for('export_analytics_data', export_type='demographics'), 'text': 'Export Demographics', 'icon': 'bi-download', 'color_class': 'text-secondary'}
            ] %}
            {{ render_quick_links(gov_quick_links) }}

            {# Compliance Status Placeholder #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-check-circle-fill me-2 text-success"></i>Compliance Status</h5>
                </div>
                <div class="card-body">
                     <ul class="list-unstyled">
                        <li class="d-flex justify-content-between mb-2"><span>Accreditation:</span> <span class="badge bg-success-subtle text-success-emphasis p-2">Current</span></li>
                        <li class="d-flex justify-content-between mb-2"><span>Safety Audit:</span> <span class="badge bg-warning-subtle text-warning-emphasis p-2">Due Soon</span></li>
                        <li class="d-flex justify-content-between"><span>Financial Reporting:</span> <span class="badge bg-success-subtle text-success-emphasis p-2">Submitted</span></li>
                    </ul>
                </div>
            </div>
        </div>

        {# Right Column: Key Data Reports & Recent Submissions to Government #}
        <div class="col-lg-8 col-xl-9">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-file-earmark-bar-graph-fill me-2"></i>Key Institutional Reports</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-folder2-open fs-1 mb-2"></i>
                    <p>Links to key institutional reports (e.g., annual performance, financial statements) will be available here.</p>
                </div>
            </div>

            <div class="mt-4">
             {{ render_recent_activity(recent_gov_submissions) }} {# Assuming recent_gov_submissions is passed #}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any Government dashboard specific JS
        console.log('Government Dashboard JS loaded.');
    });
</script>
{% endblock %}

-e 

===== templates/hr_ceo/pending_assets.html =====
{% extends "layout/base.html" %}

{% block page_title %}Assets Pending Review{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-hourglass-split me-2 text-warning"></i>Assets Pending Review
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('list_all_assets') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-boxes me-1"></i> View All Assets
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">New Assets Awaiting Your Approval</h5>
        </div>
        <div class="card-body p-0"> {# Remove padding for full-width table #}
            {% if pending_assets and pending_assets | length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Added By</th>
                                <th scope="col">Date Added</th>
                                <th scope="col">Qty</th>
                                <th scope="col">Suggested Category</th>
                                <th scope="col">Suggested Lab</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in pending_assets %}
                            <tr>
                                <td>{{ asset.id }}</td>
                                <td class="fw-medium">
                                    <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="text-decoration-none">
                                        {{ asset.name | truncate(40) }}
                                    </a>
                                </td>
                                <td>{{ asset.added_by_user.full_name or asset.added_by_user.username if asset.added_by_user else 'N/A' }}</td>
                                <td>{{ asset.created_at | dateformat if asset.created_at else (asset.reports[0].report_date | dateformat if asset.reports else 'N/A') }}</td> {# Assuming created_at for new assets #}
                                <td>{{ asset.quantity }}</td>
                                <td>
                                    {% if asset.category %}
                                        <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ asset.category.name }}</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">None Suggested</span>
                                    {% endif %}
                                </td>
                                 <td>
                                    {% if asset.lab %}
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ asset.lab.name }}</span>
                                    {% elif asset.location_description %}
                                        <span class="text-muted fst-italic">{{ asset.location_description | truncate(20) }}</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">None Suggested</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="btn btn-sm btn-primary" title="Review and Edit Asset">
                                        <i class="bi bi-pencil-square me-1"></i> Review
                                    </a>
                                    {# Optional: Quick Approve/Reject if simple cases exist, but edit_asset is safer #}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted p-5">
                    <i class="bi bi-check2-all display-3 mb-3 text-success"></i>
                    <h4 class="font-heading">All Clear!</h4>
                    <p>There are no new assets currently pending review.</p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if the list can be very long #}
        {# {% if paginated_assets and (paginated_assets.has_prev or paginated_assets.has_next) %} ... {% endif %} #}
    </div>
</div>
{% endblock %}-e 

===== templates/hr_ceo/manage_categories.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage Asset Categories{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-tags-fill me-2 text-primary"></i>Manage Asset Categories
        </h1>
        <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Left Column: List Existing Categories #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Existing Asset Categories</h5>
                </div>
                <div class="card-body p-0"> {# No padding for full-width table #}
                    {% if categories and categories | length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Description</th>
                                        <th scope="col" class="text-center">Assets Linked</th>
                                        <th scope="col" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in categories %}
                                    <tr>
                                        <td>{{ category.id }}</td>
                                        <td class="fw-medium">{{ category.name }}</td>
                                        <td>{{ category.description | truncate(60) if category.description else '-' }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">
                                                {{ category.assets.count() }} {# Assuming 'assets' is a dynamic relationship #}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a href="{{ url_for('edit_asset_category', category_id=category.id) }}" class="btn btn-sm btn-outline-primary p-1 me-1" title="Edit Category">
                                                <i class="bi bi-pencil-fill fs-6"></i>
                                            </a>
                                            {# Delete button triggers a modal confirmation #}
                                            <button type="button" class="btn btn-sm btn-outline-danger p-1"
                                                    data-bs-toggle="modal" data-bs-target="#deleteCategoryModal"
                                                    data-category-id="{{ category.id }}" data-category-name="{{ category.name }}"
                                                    title="Delete Category"
                                                    {% if category.assets.count() > 0 %}disabled{% endif %}> {# MODIFIED: Removed 'or category.channels.count() > 0' #}
                                                <i class="bi bi-trash-fill fs-6"></i>
                                            </button>
                                            {% if category.assets.count() > 0 %} {# MODIFIED: Removed 'or category.channels.count() > 0' #}
                                                <small class="d-block text-muted" style="font-size: 0.7rem;">(Reassign assets to enable delete)</small> {# MODIFIED: Text updated #}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-tag-fill display-3 mb-3"></i>
                            <h4 class="font-heading">No Categories Found</h4>
                            <p>Start by adding a new asset category using the form.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Right Column: Add New Category Form #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success-subtle text-success-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-plus-circle-dotted me-2"></i>Add New Category</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('add_asset_category') }}" novalidate>
                        {{ add_form.hidden_tag() if add_form.hidden_tag }} {# CSRF Token for add_form #}

                        <div class="mb-3">
                            {{ add_form.name.label(class="form-label fw-medium") }}
                            {{ add_form.name(class="form-control" + (" is-invalid" if add_form.name.errors else ""), placeholder="e.g., IT Hardware, Furniture") }}
                            {% if add_form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in add_form.name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ add_form.description.label(class="form-label fw-medium") }}
                            {{ add_form.description(class="form-control" + (" is-invalid" if add_form.description.errors else ""), rows="3", placeholder="Optional brief description") }}
                            {% if add_form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in add_form.description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            {{ add_form.submit(class="btn btn-success", value="Add Category") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Delete Category Confirmation Modal #}
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title font-heading" id="deleteCategoryModalLabel"><i class="bi bi-trash3-fill me-2"></i>Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the category: <strong id="categoryNameToDelete"></strong>?</p>
                    <p class="text-danger"><small>This action cannot be undone. Ensure no assets are linked to this category.</small></p> {# MODIFIED: Text updated #}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteCategoryForm" method="POST" action=""> {# Action will be set by JS #}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                        <button type="submit" class="btn btn-danger">Yes, Delete Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteCategoryModal = document.getElementById('deleteCategoryModal');
        if (deleteCategoryModal) {
            deleteCategoryModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const categoryId = button.getAttribute('data-category-id');
                const categoryName = button.getAttribute('data-category-name');

                const modalTitle = deleteCategoryModal.querySelector('.modal-title');
                const categoryNameSpan = deleteCategoryModal.querySelector('#categoryNameToDelete');
                const deleteForm = deleteCategoryModal.querySelector('#deleteCategoryForm');

                categoryNameSpan.textContent = categoryName;
                // Dynamically set the form action URL for deletion
                deleteForm.action = `/hr_ceo/asset_category/${categoryId}/delete`; // Matches your Flask route
            });
        }
        console.log('Manage Asset Categories JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/manage_tc_leader.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage System TC Leader{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-workspace me-2 text-primary"></i>Manage System Talent Club Leader
        </h1>
        <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to HR Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Current Leader & Election Status Column #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-check-fill me-2"></i>Current System TC Leader</h5>
                </div>
                <div class="card-body">
                    {% if current_leader %}
                        <div class="d-flex align-items-center">
                            {% set leader_avatar = url_for('static', filename=(current_leader.profile_photo_url if current_leader.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                            <img src="{{ leader_avatar }}" alt="{{ current_leader.username }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                            <div>
                                <h6 class="font-heading mb-0">{{ current_leader.full_name or current_leader.username }}</h6>
                                <small class="text-muted">{{ current_leader.username }} | {{ current_leader.role.name | title if current_leader.role }}</small>
                            </div>
                        </div>
                        <form action="{{ url_for('hr_ceo_demote_tc_leader', user_id=current_leader.id) }}" method="POST" class="mt-3">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100 confirm-demote-leader">
                                <i class="bi bi-person-fill-down me-1"></i> Demote Current Leader
                            </button>
                        </form>
                    {% else %}
                        <p class="text-muted text-center py-3">No system-wide Talent Club Leader is currently assigned.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-archive-fill me-2"></i>Past Elections</h5>
                </div>
                <div class="list-group list-group-flush" style="max-height: 300px; overflow-y:auto;">
                    {% if past_elections and past_elections | length > 0 %}
                        {% for election in past_elections %}
                            <div class="list-group-item">
                                <small class="d-block">
                                    <strong>Concluded:</strong> {{ election.concluded_at | dateformat }}
                                    {% if election.elected_leader %}
                                        | <strong>Winner:</strong> {{ election.elected_leader.full_name or election.elected_leader.username }}
                                    {% else %}
                                        | <span class="text-muted">No winner declared</span>
                                    {% endif %}
                                </small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item text-muted text-center p-3">No past election records.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Active Election Management Column #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-bounding-box me-2"></i>Talent Club Leader Election</h5>
                </div>
                <div class="card-body">
                    {% if active_election %}
                        <h6 class="font-heading">Active Election (ID: {{ active_election.id }})</h6>
                        <p class="text-muted">Initiated on: {{ active_election.initiated_at | datetimeformat }}</p>
                        <p><strong>Total Votes Cast:</strong> <span class="badge bg-info rounded-pill fs-09rem">{{ total_votes_in_active_election }}</span></p>

                        <h6 class="mt-3 font-heading">Candidate Votes:</h6>
                        {% if candidate_vote_counts %}
                            <ul class="list-group list-group-numbered mb-3">
                                {% for candidate_id, votes in candidate_vote_counts.items() | sort(attribute='1', reverse=True) %}
                                    {% set cand = eligible_candidates | selectattr('id', 'equalto', candidate_id) | first %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ cand.full_name or cand.username if cand else 'Unknown Candidate' }}
                                        <span class="badge bg-primary rounded-pill">{{ votes }} vote{{'s' if votes != 1 else ''}}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No votes cast yet in this election.</p>
                        {% endif %}

                        <form action="{{ url_for('hr_ceo_conclude_tc_leader_election', election_id=active_election.id) }}" method="POST" class="mt-3">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-success w-100 confirm-conclude-election">
                                <i class="bi bi-flag-fill me-1"></i> Conclude Election & Declare Winner
                            </button>
                        </form>
                        {# Optional: Cancel election button #}

                    {% else %}
                        <p class="text-muted">No election is currently active.</p>
                        {% if eligible_candidates and eligible_candidates | length > 0 %}
                        <form action="{{ url_for('hr_ceo_initiate_tc_leader_election') }}" method="POST">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-megaphone-fill me-1"></i> Initiate New Election
                            </button>
                        </form>
                        {% else %}
                            <div class="alert alert-warning small" role="alert">
                                <i class="bi bi-exclamation-circle-fill me-1"></i> Cannot initiate an election: No eligible Talent Club members found to be candidates/voters.
                            </div>
                        {% endif %}
                    {% endif %}

                    <hr class="my-4">
                    <h6 class="font-heading">Eligible Candidates/Voters (Active TC Members)</h6>
                    {% if eligible_candidates and eligible_candidates | length > 0 %}
                        <ul class="list-unstyled list-group- DGGGGGGGGGG" style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">
                            {% for candidate in eligible_candidates %}
                                <li class="list-group-item list-group-item-light py-1 px-2 d-flex align-items-center">
                                     {% set cand_avatar = url_for('static', filename=(candidate.profile_photo_url if candidate.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                                    <img src="{{ cand_avatar }}" alt="{{ candidate.username }}" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                                    {{ candidate.full_name or candidate.username }}
                                    <small class="text-muted ms-auto">{{candidate.username}}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small">No active Talent Club members found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Confirmation for demoting leader
        document.querySelectorAll('.confirm-demote-leader').forEach(button => {
            button.addEventListener('click', function(event) {
                if (!confirm('Are you sure you want to demote the current Talent Club Leader? This action cannot be undone easily.')) {
                    event.preventDefault();
                }
            });
        });
        // Confirmation for concluding election
         document.querySelectorAll('.confirm-conclude-election').forEach(button => {
            button.addEventListener('click', function(event) {
                if (!confirm('Are you sure you want to conclude this election? The candidate(s) with the most votes will be declared the winner. This cannot be undone.')) {
                    event.preventDefault();
                }
            });
        });
        console.log('Manage System TC Leader JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/hr_ceo/dashboard.html =====
{% extends "layout/base.html" %}

{# DEFINE MACROS FIRST, AFTER EXTENDS #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity to display.</p>
            </div>
        {% endif %}
    </div>
    {% if activities and activities | length > 5 %}
    <a href="{{ url_for('view_notifications') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Activity <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>
{% endmacro %}
{# END OF MACRO DEFINITIONS #}


{% block page_title %}HR & Academics Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-briefcase-fill me-2 text-primary"></i>HR & Academics Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('create_task') }}" class="btn btn-sm btn-success me-2">
                 <i class="bi bi-plus-square-dotted me-1"></i> Create New Task
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-primary text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Welcome, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Oversee school operations, manage staff and student affairs, and track key performance indicators.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {{ render_stat_card(
            card_title="Total Students",
            card_value=student_count | default(0),
            card_icon="bi-people-fill",
            card_color_class="text-info",
            card_url=url_for('student_database_index')
        ) }}

        {# Link to teacher management page if exists #}
        {{ render_stat_card(
            card_title="Total Teachers",
            card_value=teacher_count | default(0),
            card_icon="bi-person-video3",
            card_color_class="text-success",
            card_url="#"
        ) }}

        {{ render_stat_card(
            card_title="Student Leaders",
            card_value=student_leader_count | default(0),
            card_icon="bi-person-check-fill",
            card_color_class="text-primary",
            card_url=url_for('manage_student_leaders')
        ) }}

        {{ render_stat_card(
            card_title="Pending Assets",
            card_value=pending_assets | default(0),
            card_icon="bi-box-seam-fill",
            card_color_class="text-warning",
            card_url=url_for('list_pending_assets')
        ) }}

        {{ render_stat_card(
            card_title="Open Asset Reports",
            card_value=reports_open | default(0),
            card_icon="bi-flag-fill",
            card_color_class="text-danger",
            card_url=url_for('list_asset_reports')
        ) }}

        {# Backend needs to provide this count #}
        {{ render_stat_card(
            card_title="Tasks Assigned by You",
            card_value=my_assigned_tasks_count | default(0),
            card_icon="bi-card-checklist",
            card_color_class="text-secondary",
            card_url=url_for('my_assigned_tasks')
        ) }}

        {# Backend needs to provide this count #}
        {{ render_stat_card(
            card_title="Requests Inbox",
            card_value=requests_inbox_count | default(0),
            card_icon="bi-envelope-paper-fill",
            card_color_class="text-info",
            card_url=url_for('requests_inbox')
        ) }}

        {% set unread_notif_val = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Notifications",
            card_value=unread_notif_val,
            card_icon="bi-bell-fill",
            card_color_class="text-warning",
            card_url=url_for('view_notifications')
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Pending Reviews #}
        <div class="col-lg-4 col-xl-3">
            {% set hr_ceo_quick_links = [
                {'url': url_for('list_pending_assets'), 'text': 'Review Pending Assets', 'icon': 'bi-box-arrow-in-down', 'color_class': 'text-primary'},
                {'url': url_for('list_asset_reports'), 'text': 'Manage Asset Reports', 'icon': 'bi-tools', 'color_class': 'text-danger'},
                {'url': url_for('manage_student_leaders'), 'text': 'Manage Student Leaders', 'icon': 'bi-person-badge-fill', 'color_class': 'text-success'},
                {'url': url_for('manage_asset_categories'), 'text': 'Manage Asset Categories', 'icon': 'bi-tags-fill', 'color_class': 'text-info'},
                {'url': url_for('my_assigned_tasks'), 'text': 'View Tasks You Assigned', 'icon': 'bi-card-list', 'color_class': 'text-secondary'},
                {'url': url_for('hr_ceo_initiate_request'), 'text': 'Initiate Request (Tier 2)', 'icon': 'bi-send-plus-fill', 'color_class': 'text-warning'},
                {'url': url_for('manage_system_tc_leader'), 'text': 'Manage TC System Leader', 'icon': 'bi-trophy-fill', 'color_class': 'text-primary'}
            ] %}
            {{ render_quick_links(hr_ceo_quick_links) }}

             {# Analytics Quick Links #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-pie-chart-fill me-2"></i>Analytics</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" onclick="fetchAndDisplayAnalytics('attendance', 'Attendance Overview', 'attendanceChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-calendar3-event me-2 text-success"></i>Attendance Data</a>
                    <a href="#" onclick="fetchAndDisplayAnalytics('performance', 'Performance Averages', 'performanceChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-graph-up-arrow me-2 text-info"></i>Performance Data</a>
                    <a href="#" onclick="fetchAndDisplayAnalytics('demographics', 'Student Demographics', 'demographicsChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-gender-ambiguous me-2 text-warning"></i>Demographics Data</a>
                </div>
            </div>
        </div>

        {# Right Column: Analytics Charts & Recent Activity #}
        <div class="col-lg-8 col-xl-9">
            <div class="row g-4">
                <div class="col-xl-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading"><i class="bi bi-calendar3-event me-2"></i>Attendance Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="attendanceChartContainer">
                                <canvas id="attendanceChart"></canvas> {# Chart.js will target this #}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading"><i class="bi bi-graph-up-arrow me-2"></i>Performance Averages</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="performanceChartContainer">
                               <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
             {{ render_recent_activity(recent_activities) }} {# Assuming recent_activities is passed #}
            </div>
        </div>
    </div>
</div>
{% endblock %} {# This is the end of the content block #}

{% block body_scripts %}
{# utils.js should be loaded before this in base.html #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('HR/CEO Dashboard JS (using global analytics) loaded.');
        if (typeof fetchAndDisplayAnalytics === 'function') {
            fetchAndDisplayAnalytics('attendance', 'Attendance Overview', 'attendanceChartContainer', 'doughnut');
            fetchAndDisplayAnalytics('performance', 'Performance Averages', 'performanceChartContainer', 'bar');
            // For demographics if you add a canvas for it:
            // fetchAndDisplayAnalytics('demographics', 'Student Demographics', 'demographicsChartContainer', 'pie');
        } else {
            console.error("fetchAndDisplayAnalytics function not found. Ensure utils.js is loaded.");
        }
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/edit_category.html =====
{% extends "layout/base.html" %}

{% set page_title = "Edit Category: " + (category.name if category else "New Category") %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-pencil-square me-2 text-primary"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('manage_asset_categories') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Categories
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">Category Details</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('edit_asset_category', category_id=category.id if category else 0) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token for the edit form #}

                        <div class="mb-3">
                            {{ form.name.label(class="form-label fw-medium") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), placeholder="e.g., IT Hardware, Furniture") }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4", placeholder="Optional brief description of the category") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('manage_asset_categories') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Save Changes") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/hr_ceo/resolve_report.html =====
{% extends "layout/base.html" %}

{% set page_title = "Resolve Report ID: " + (report.id | string) %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-check-circle-fill text-success me-2"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('list_asset_reports') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to All Reports
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Report Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Report ID:</dt>
                        <dd class="col-sm-9">{{ report.id }}</dd>

                        <dt class="col-sm-3">Asset Reported:</dt>
                        <dd class="col-sm-9">
                            {% if report.asset %}
                                <a href="{{ url_for('edit_asset', asset_id=report.asset.id) }}" class="text-decoration-none">{{ report.asset.name }} (ID: {{ report.asset.id }})</a>
                            {% else %}
                                <span class="fst-italic text-muted">General Report (Not linked to a specific asset)</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Reported By:</dt>
                        <dd class="col-sm-9">{{ report.reporter.full_name or report.reporter.username if report.reporter else 'N/A' }}</dd>

                        <dt class="col-sm-3">Report Date:</dt>
                        <dd class="col-sm-9">{{ report.report_date | datetimeformat }}</dd>

                        <dt class="col-sm-3">Issue Description:</dt>
                        <dd class="col-sm-9">{{ report.damage_description }}</dd>

                        {% if report.date_of_damage %}
                        <dt class="col-sm-3">Date of Damage:</dt>
                        <dd class="col-sm-9">{{ report.date_of_damage | dateformat }}</dd>
                        {% endif %}

                        <dt class="col-sm-3">Quantity Damaged:</dt>
                        <dd class="col-sm-9">{{ report.quantity_damaged }}</dd>

                        <dt class="col-sm-3">Current Status:</dt>
                        <dd class="col-sm-9">
                             {% if report.status == 'Pending' %}
                                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'In Progress' %}
                                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'Resolved' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'Rejected' %}
                                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% else %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% endif %}
                        </dd>

                        {% if report.resolver %}
                        <dt class="col-sm-3">Resolved/Rejected By:</dt>
                        <dd class="col-sm-9">{{ report.resolver.full_name or report.resolver.username }}</dd>
                        {% endif %}
                        {% if report.resolved_date %}
                        <dt class="col-sm-3">Resolved/Rejected Date:</dt>
                        <dd class="col-sm-9">{{ report.resolved_date | datetimeformat }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {% if report.status not in ['Resolved', 'Rejected'] %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-pencil-fill me-2"></i>Update Report Status & Resolution</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}
                    <form method="POST" action="{{ url_for('resolve_asset_report', report_id=report.id) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.status.label(class="form-label fw-medium") }}
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.resolution_notes.label(class="form-label fw-medium") }}
                            {{ form.resolution_notes(class="form-control" + (" is-invalid" if form.resolution_notes.errors else ""), rows="4", placeholder="Enter notes regarding the resolution, actions taken, or reasons for rejection...") }}
                            {% if form.resolution_notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.resolution_notes.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {# Optional: Field to link a general report to an asset - More complex UI needed #}
                        {# {% if not report.asset_id and form.link_to_asset_id %}
                        <div class="mb-3">
                            {{ form.link_to_asset_id.label(class="form-label fw-medium") }}
                            {{ form.link_to_asset_id(class="form-select tom-select" + (" is-invalid" if form.link_to_asset_id.errors else "")) }}
                            <small class="form-text text-muted">If this general report pertains to a specific asset, link it here.</small>
                            {% if form.link_to_asset_id.errors %}<div class="invalid-feedback">{% for e in form.link_to_asset_id.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>
                        {% endif %} #}

                        <hr class="my-4">
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('list_asset_reports') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Update Report") }}
                        </div>
                    </form>
                </div>
            </div>
            {% elif report.resolution_notes %} {# Show notes if already resolved/rejected #}
             <div class="card shadow-sm">
                <div class="card-header bg-light-subtle">
                     <h5 class="mb-0 font-heading"><i class="bi bi-card-text me-2"></i>Resolution Notes</h5>
                </div>
                <div class="card-body">
                    <p class="fst-italic">{{ report.resolution_notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect if link_to_asset_id field is present and needs it
        // const assetLinkSelect = document.getElementById('{{ form.link_to_asset_id.id if form.link_to_asset_id else '' }}');
        // if (assetLinkSelect) {
        //     new TomSelect(assetLinkSelect, {
        //         create: false,
        //         placeholder: 'Search and select an asset...'
        //         // Add remote loading options if needed for asset search
        //     });
        // }
        console.log('Resolve Asset Report page JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/student_leaders.html =====
{% extends "layout/base.html" %}

{% block page_title %}{{ title or "Manage Student Leaders" }}{% endblock %}

{% block content_header %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="page-title font-heading mb-0">
        <i class="bi bi-person-badge-fill me-2 text-primary"></i>Manage Student Leaders & Assignments
    </h1>
    <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Left Column: Assign Students Form & Current Leaders List (Optional) #}
        <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-plus-fill me-2"></i>Assign Students to Leader</h5>
                </div>
                <div class="card-body p-3">
                    {% if form and form.leader.choices and form.leader.choices[0][0] != 0 %} {# Check if leaders exist for form #}
                        <form method="POST" action="{{ url_for('manage_student_leaders') }}" novalidate>
                            {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}
                            <div class="mb-3">
                                {{ form.leader.label(class="form-label fw-medium") }}
                                {{ form.leader(class="form-select tom-select" + (" is-invalid" if form.leader.errors else "")) }}
                                {% if form.leader.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.leader.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Select an active student leader who has a grade and section assigned.</small>
                            </div>
                            <p class="fw-medium">Select students below (from the main list) to assign to this leader.</p>
                            <div class="d-grid">
                                {{ form.submit(class="btn btn-primary", value="Assign Selected Students") }}
                            </div>
                            <small class="form-text text-muted mt-2 d-block">Note: Students will only be assigned if they are in the same grade and section as the selected leader.</small>
                        </form>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-person-x-fill fs-3 mb-2"></i><br>
                            No active student leaders with assigned grade/sections found. Promote a student to leader first to enable assignment.
                        </p>
                    {% endif %}
                </div>
            </div>

            {% if current_leaders %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-star-fill me-2 text-warning"></i>Current Student Leaders</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for leader_user in current_leaders %}
                        <a href="#block-{{ leader_user.grade }}-{{ leader_user.section }}" class="list-group-item list-group-item-action">
                            {{ leader_user.full_name or leader_user.username }}
                            <small class="d-block text-muted">Grade {{ leader_user.grade }} - Section {{ leader_user.section }}</small>
                        </a>
                    {% else %}
                        <div class="list-group-item text-muted">No student leaders currently assigned.</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Right Column: Student Blocks by Grade/Section #}
        <div class="col-lg-8 col-xl-9">
            {% if students_by_grade_section %}
                {% for key, data in students_by_grade_section.items() %}
                    {% set grade, section = key %}
                    <div class="card shadow-sm mb-4" id="block-{{ grade }}-{{ section }}">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading">
                                <i class="bi bi-collection-fill me-2"></i>Grade {{ grade }} - Section {{ section }}
                                {% if data.leader %}
                                    <small class="text-muted fw-normal ms-2">(Leader: <span class="text-success">{{ data.leader.full_name or data.leader.username }}</span>)</small>
                                {% else %}
                                    <small class="text-danger fw-normal ms-2">(No Leader Assigned)</small>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if not data.leader and not data.followers and not data.unassigned_students %}
                                <p class="text-muted text-center m-0 py-3">No students found in this block.</p>
                            {% else %}
                                <form method="POST" action="{{ url_for('manage_student_leaders') }}"> {# Target for student selection checkboxes #}
                                    {{ form.hidden_tag() if form.hidden_tag }} {# CSRF for the main assignment form #}
                                    
                                    <h6 class="font-heading text-muted mb-2">
                                        {% if data.leader %}
                                            Leader & Followers ({{ (data.followers or []) | length + 1 }})
                                        {% else %}
                                            Unassigned Students (Potential Leaders) ({{ (data.unassigned_students or []) | length }})
                                        {% endif %}
                                    </h6>
                                    <ul class="list-group list-group-flush mb-3">
                                        {# Display Leader (if exists for this block) #}
                                        {% if data.leader %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2">
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ data.leader.id }}" id="student-{{ data.leader.id }}" form="assignStudentsFormId"> {# Add form attribute if assign form is outside this one #}
                                                    <label class="form-check-label fw-bold text-success" for="student-{{ data.leader.id }}">
                                                        {{ data.leader.full_name or data.leader.username }} (Current Leader <i class="bi bi-star-fill text-warning"></i>)
                                                    </label>
                                                </div>
                                                <form method="POST" action="{{ url_for('toggle_student_leader_status', student_id=data.leader.id) }}" class="d-inline">
                                                     <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger p-1" title="Demote Leader">
                                                        <i class="bi bi-person-x-fill fs-6"></i> Demote
                                                    </button>
                                                </form>
                                            </li>
                                        {% endif %}

                                        {# Display Followers (if leader exists) #}
                                        {% if data.leader and data.followers %}
                                            {% for student in data.followers %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2 ps-4"> {# Indent followers #}
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ student.id }}" id="student-{{ student.id }}" form="assignStudentsFormId">
                                                    <label class="form-check-label" for="student-{{ student.id }}">
                                                        {{ student.full_name or student.username }}
                                                        <small class="text-muted ms-1">(Following {{ data.leader.username }})</small>
                                                    </label>
                                                </div>
                                                {# Action for follower - e.g., Unassign (handled by re-assigning to no one or another leader) #}
                                            </li>
                                            {% endfor %}
                                        {% endif %}

                                        {# Display Unassigned Students (or potential leaders if no leader for block) #}
                                        {% for student in data.unassigned_students %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2">
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ student.id }}" id="student-{{ student.id }}" form="assignStudentsFormId">
                                                    <label class="form-check-label" for="student-{{ student.id }}">
                                                        {{ student.full_name or student.username }}
                                                        {% if student.leader %}<small class="text-muted ms-1">(Assigned to: {{ student.leader.username }})</small>{% endif %}
                                                    </label>
                                                </div>
                                                <form method="POST" action="{{ url_for('toggle_student_leader_status', student_id=student.id) }}" class="d-inline">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-success p-1" title="Promote to Leader">
                                                        <i class="bi bi-person-check-fill fs-6"></i> Promote
                                                    </button>
                                                </form>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </form> {# End of the checkbox form for assignments #}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">No student blocks found. Please ensure students have grades and sections assigned.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect for the leader selection dropdown if it exists
        const leaderSelect = document.querySelector('.tom-select'); // Target the class if dynamically added
        if (leaderSelect) {
            new TomSelect(leaderSelect, {
                placeholder: 'Search or select a leader...',
                allowEmptyOption: true // If you have a "--- Select Leader ---" option
            });
        }

        // Optional: Add JS to handle dynamic checkbox selection and update hidden field for Assign Students form
        // This depends on how the form in the left column is structured relative to checkboxes in the right column.
        // For simplicity, the template above assumes the checkboxes are part of the same form, or `form="assignStudentsFormId"` is used.
        // If they are separate, JS would be needed to collect checked student IDs and populate a hidden field.
        console.log('Manage Student Leaders JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/list_reports.html =====
{% extends "layout/base.html" %}

{% block page_title %}All Asset Reports{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-flag-fill text-danger me-2"></i>All Asset Reports
        </h1>
        {# Optional: Add filter controls or a "Report General Issue" button here if needed #}
        <a href="{{ url_for('report_asset_general') }}" class="btn btn-sm btn-outline-warning">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Report General Issue
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="card shadow-sm">
        <div class="card-header bg-light-subtle">
            <h5 class="mb-0 font-heading">List of Asset Reports</h5>
            {# Add search/filter form here if you implement those features in the route #}
        </div>
        <div class="card-body p-0">
            {% if reports %}
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-3">ID</th>
                            <th scope="col">Asset Name</th>
                            <th scope="col">Reported By</th>
                            <th scope="col">Report Date</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="text-end pe-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report_item in reports %} {# Iterate through 'reports' (plural) #}
                        <tr>
                            <td class="ps-3"><strong>#{{ report_item.id }}</strong></td>
                            <td>
                                {% if report_item.asset %}
                                    <a href="{{ url_for('edit_asset', asset_id=report_item.asset.id) }}" class="text-decoration-none" title="View Asset Details">{{ report_item.asset.name }}</a>
                                    <small class="d-block text-muted">Category: {{ report_item.asset.category.name if report_item.asset.category else 'N/A' }}</small>
                                {% else %}
                                    <span class="fst-italic text-muted">General Report</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ report_item.reporter.full_name or report_item.reporter.username if report_item.reporter else 'N/A' }}
                                <small class="d-block text-muted">{{ report_item.reporter.role.name.replace('_', ' ').title() if report_item.reporter and report_item.reporter.role else '' }}</small>
                            </td>
                            <td>
                                {{ report_item.report_date | datetimeformat('%b %d, %Y %I:%M %p') }}
                                <small class="d-block text-muted">({{ report_item.report_date | humanize_time_diff }})</small>
                            </td>
                            <td>
                                {% if report_item.status == 'Pending' %}
                                    <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'In Progress' %}
                                    <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'Resolved' %}
                                    <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'Rejected' %}
                                    <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-3">
                                <a href="{{ url_for('resolve_asset_report', report_id=report_item.id) }}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-search me-1"></i> View/Resolve
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-inbox fs-1 mb-2"></i>
                <p class="mb-0">No asset reports found.</p>
            </div>
            {% endif %}
        </div>
        {# Optional: Add pagination controls here if you implement pagination in the route #}
        {# {% if pagination and pagination.pages > 1 %}
            <div class="card-footer text-center">
                ... pagination links ...
            </div>
        {% endif %} #}
    </div>
</div>
{% endblock %}
-e 

===== templates/librarian/list_checkouts.html =====
{% extends "layout/base.html" %}

{% block page_title %}All Book Checkouts{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-journals me-2 text-primary"></i>Manage Book Checkouts
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('checkout_book') }}" class="btn btn-sm btn-success me-2">
                <i class="bi bi-journal-plus me-1"></i> New Checkout
            </a>
            <a href="{{ url_for('librarian_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                 <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {# Filters and Search Section #}
    <div class="card shadow-sm mb-4">
        <div class="card-body bg-light-subtle">
            <form method="GET" action="{{ url_for('list_checkouts') }}" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="statusFilter" class="form-label fw-medium text-muted small">Status:</label>
                    <select name="status" id="statusFilter" class="form-select form-select-sm tom-select-filter">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Checkouts</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active (Not Returned)</option>
                        <option value="overdue" {% if status_filter == 'overdue' %}selected{% endif %}>Active & Overdue</option>
                        <option value="returned" {% if status_filter == 'returned' %}selected{% endif %}>Returned</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="searchFilter" class="form-label fw-medium text-muted small">Search (Book/User):</label>
                    <input type="text" name="search" id="searchFilter" class="form-control form-control-sm" value="{{ search_query or '' }}" placeholder="Book title, borrower name/username...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search me-1"></i>Filter</button>
                </div>
            </form>
        </div>
    </div>

    {# Checkout Listing #}
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">
                {% if status_filter == 'active' %}Active Checkouts
                {% elif status_filter == 'overdue' %}Overdue Checkouts
                {% elif status_filter == 'returned' %}Returned Books
                {% else %}All Checkouts{% endif %}
            </h5>
        </div>
        <div class="card-body p-0"> {# No padding for full-width list group #}
            {% if checkouts_paginated and checkouts_paginated.items %}
                <div class="list-group list-group-flush">
                    {% for checkout in checkouts_paginated.items %}
                        {# Use the _book_checkout_item.html partial #}
                        {% include 'partials/_book_checkout_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-journal-richtext display-3 mb-3"></i>
                    <h4 class="font-heading">No Checkouts Found</h4>
                    <p>There are no book checkouts matching your current filter criteria.</p>
                     <a href="{{ url_for('list_checkouts') }}" class="btn btn-outline-primary mt-2"><i class="bi bi-arrow-counterclockwise me-1"></i>Clear Filters</a>
                </div>
            {% endif %}
        </div>

        {# Pagination #}
        {% if checkouts_paginated and (checkouts_paginated.has_prev or checkouts_paginated.has_next) %}
            <div class="card-footer bg-light-subtle">
                <nav aria-label="Checkout pagination" class="d-flex justify-content-center">
                    <ul class="pagination shadow-sm mb-0">
                        <li class="page-item {{ 'disabled' if not checkouts_paginated.has_prev else '' }}">
                            <a class="page-link" href="{{ url_for('list_checkouts', page=checkouts_paginated.prev_num, status=status_filter, search=search_query) if checkouts_paginated.has_prev else '#' }}" aria-label="Previous">
                                <span aria-hidden="true">«</span>
                            </a>
                        </li>
                        {% for page_num in checkouts_paginated.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                            {% if page_num %}
                                <li class="page-item {{ 'active' if page_num == checkouts_paginated.page else '' }}">
                                    <a class="page-link" href="{{ url_for('list_checkouts', page=page_num, status=status_filter, search=search_query) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        <li class="page-item {{ 'disabled' if not checkouts_paginated.has_next else '' }}">
                            <a class="page-link" href="{{ url_for('list_checkouts', page=checkouts_paginated.next_num, status=status_filter, search=search_query) if checkouts_paginated.has_next else '#' }}" aria-label="Next">
                                <span aria-hidden="true">»</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect for the status filter dropdown
        const statusFilterSelect = document.getElementById('statusFilter');
        if (statusFilterSelect) {
            new TomSelect(statusFilterSelect, {
                create: false,
                allowEmptyOption: false // "All Checkouts" is a valid selection
            });
        }
        console.log('List Checkouts page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/librarian/take_attendance.html =====
{% extends "layout/base.html" %}

{% block title %}Library Attendance Kiosk{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Library Attendance Kiosk</h1>
            <p class="mb-0 text-muted">Quickly log student entry and exit.</p>
        </div>
        <div class="text-end">
            <span id="live-clock" class="h5 font-weight-bold"></span>
        </div>
    </div>

    <div class="row">
        <!-- Main Interaction Panel -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Find Student</h6>
                </div>
                <div class="card-body">
                    <form id="studentSearchForm" onsubmit="return false;">
                        <div class="input-group mb-3">
                            <input type="text" id="studentSearchInput" class="form-control form-control-lg" placeholder="Enter Student ID or Name..." autocomplete="off" autofocus>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i></button>
                        </div>
                    </form>
                    <div id="searchResults" class="list-group">
                        <!-- AJAX search results will be injected here -->
                        <div class="text-center p-3 text-muted" id="searchPlaceholder">
                            <i class="bi bi-person-bounding-box" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">Student details will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Activity Log -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Activity</h6>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    <ul class="list-group list-group-flush" id="activityLog">
                        <!-- Live log entries will be prepended here -->
                        <li class="list-group-item text-center text-muted" id="logPlaceholder">No activity yet.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element References ---
    const searchInput = document.getElementById('studentSearchInput');
    const searchResults = document.getElementById('searchResults');
    const searchPlaceholder = document.getElementById('searchPlaceholder');
    const activityLog = document.getElementById('activityLog');
    const logPlaceholder = document.getElementById('logPlaceholder');
    const clockElement = document.getElementById('live-clock');

    // --- CSRF Token for Secure POST Requests ---
    // The backend must provide a way to get the CSRF token.
    // Here we assume it's in a meta tag in the base layout.
    // e.g., <meta name="csrf-token" content="{{ csrf_token() }}">
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // --- Live Clock ---
    function updateClock() {
        if (!clockElement) return;
        clockElement.textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    updateClock();
    setInterval(updateClock, 1000);

    // --- Search Functionality ---
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const query = searchInput.value.trim();
        if (query.length < 2) {
            searchResults.innerHTML = ''; // Clear results if query is too short
            searchResults.appendChild(searchPlaceholder);
            return;
        }
        searchTimeout = setTimeout(() => {
            performSearch(query);
        }, 300); // Debounce requests by 300ms
    });

    async function performSearch(query) {
        searchResults.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        try {
            const response = await fetch(`/api/student-search?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
            const students = await response.json();
            displayResults(students);
        } catch (error) {
            console.error('Search failed:', error);
            searchResults.innerHTML = `<div class="alert alert-danger">Search failed. Please check the connection and try again.</div>`;
        }
    }

    function displayResults(students) {
        searchResults.innerHTML = '';
        if (students.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item text-center text-muted">No students found.</div>';
            return;
        }
        students.forEach(student => {
            const resultItem = document.createElement('div');
            resultItem.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            resultItem.innerHTML = `
                <div>
                    <h6 class="mb-0">${student.first_name} ${student.last_name}</h6>
                    <small class="text-muted">ID: ${student.student_id}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-success check-in" data-id="${student.id}" data-name="${student.first_name} ${student.last_name}">
                        <i class="bi bi-box-arrow-in-right"></i> Check In
                    </button>
                    <button class="btn btn-sm btn-warning check-out" data-id="${student.id}" data-name="${student.first_name} ${student.last_name}">
                        <i class="bi bi-box-arrow-right"></i> Check Out
                    </button>
                </div>
            `;
            searchResults.appendChild(resultItem);
        });
    }

    // --- Check-in/Check-out Functionality ---
    searchResults.addEventListener('click', function(e) {
        const target = e.target.closest('button');
        if (!target) return;

        const studentId = target.dataset.id;
        const studentName = target.dataset.name;
        const action = target.classList.contains('check-in') ? 'in' : 'out';
        
        logAttendance(studentId, studentName, action, target);
    });

    async function logAttendance(studentId, studentName, action, button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        try {
            const response = await fetch('/api/library-attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ student_id: studentId, action: action })
            });
            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'Failed to log attendance.');
            
            addLogEntry(studentName, action, new Date(result.timestamp));
            searchInput.value = '';
            searchResults.innerHTML = '';
            searchResults.appendChild(searchPlaceholder);
            searchInput.focus();

        } catch (error) {
            console.error('Log failed:', error);
            alert(`Error: ${error.message}`); // Simple error feedback
            button.disabled = false;
            button.innerHTML = action === 'in' ? '<i class="bi bi-box-arrow-in-right"></i> Check In' : '<i class="bi bi-box-arrow-right"></i> Check Out';
        }
    }
    
    function addLogEntry(studentName, action, timestamp) {
        if(logPlaceholder) {
            logPlaceholder.remove();
        }

        const logItem = document.createElement('li');
        const isCheckIn = action === 'in';
        logItem.className = `list-group-item d-flex justify-content-between align-items-center animate-fade-in`;
        
        logItem.innerHTML = `
            <div>
                <span class="fw-bold">${studentName}</span>
                <span class="badge ${isCheckIn ? 'bg-success-subtle text-success-emphasis' : 'bg-warning-subtle text-warning-emphasis'} ms-2">
                    Checked ${isCheckIn ? 'In' : 'Out'}
                </span>
            </div>
            <small class="text-muted">${timestamp.toLocaleTimeString()}</small>
        `;
        activityLog.prepend(logItem);

        // Keep the log from growing indefinitely
        while (activityLog.children.length > 50) {
            activityLog.lastElementChild.remove();
        }
    }
});
</script>

<style>
    .animate-fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}-e 

===== templates/librarian/student_profile.html =====
{% extends "layout/base.html" %}

{% set student_page_title = "Student Library Profile: " + (student.full_name or student.username if student else "N/A") %}
{% block page_title %}{{ student_page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0 text-truncate" style="max-width: 70%;">
            <i class="bi bi-person-badge-fill me-2 text-primary"></i>{{ student_page_title }}
        </h1>
        <a href="{{ request.referrer or url_for('librarian_attendance') if student and student.grade and student.section else url_for('librarian_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {% if student %}
    <div class="row g-4">
        {# Left Column: Student Info & Library Quick Actions #}
        <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm mb-4 text-center">
                <div class="card-body">
                    {% set student_avatar = url_for('static', filename=(student.profile_photo_url if student.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                    <img src="{{ student_avatar }}" alt="{{ student.username }}" class="rounded-circle mb-3 shadow-sm" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid var(--nexus-border-color);">
                    <h4 class="font-heading mb-1">{{ student.full_name or student.username }}</h4>
                    <p class="text-muted mb-0">{{ student.username }}</p>
                    <p class="text-muted"><small>Grade: {{ student.grade or 'N/A' }} | Section: {{ student.section or 'N/A' }}</small></p>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                 <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-info-circle-fill me-2"></i>Student Details</h5>
                </div>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item"><strong>Role:</strong> {{ student.role.name.replace('_',' ') | title if student.role else 'N/A' }}</li>
                    <li class="list-group-item"><strong>Email:</strong> {{ student.email or 'N/A' }}</li>
                    {# Add more relevant details if needed by librarian #}
                </ul>
            </div>

            {% set librarian_student_actions = [
                {'url': url_for('checkout_book', user_id_prefill=student.id), 'text': 'Checkout Book to Student', 'icon': 'bi-journal-plus', 'color_class': 'text-success'},
                {'url': url_for('universal_chat', target_user_id=student.id), 'text': 'Send Message', 'icon': 'bi-chat-dots-fill', 'color_class': 'text-primary'},
                {'url': "#", 'text': 'View Reading History', 'icon': 'bi-clock-history', 'color_class': 'text-info'} {# Placeholder for future feature #}
            ] %}
            {{ render_quick_links(librarian_student_actions, "Librarian Actions") }}
        </div>

        {# Right Column: Checkouts, Fines, Library Activity #}
        <div class="col-lg-8 col-xl-9">
            {# Current Book Checkouts Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 font-heading"><i class="bi bi-journal-arrow-up me-2"></i>Current Checkouts ({{ current_checkouts | length if current_checkouts else 0 }})</h5>
                    <a href="{{ url_for('checkout_book', user_id_prefill=student.id) }}" class="btn btn-sm btn-success"><i class="bi bi-plus-lg me-1"></i> New Checkout</a>
                </div>
                <div class="card-body p-0">
                     {% if current_checkouts and current_checkouts | length > 0 %}
                        <div class="list-group list-group-flush">
                            {% for checkout in current_checkouts %}
                                {# Reusing the _book_checkout_item partial #}
                                {% include 'partials/_book_checkout_item.html' %}
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center p-3">This student has no books currently checked out.</p>
                    {% endif %}
                </div>
            </div>

            {# Library Fines - Placeholder Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-cash-coin me-2 text-danger"></i>Outstanding Library Fines</h5>
                </div>
                 <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-receipt-cutoff fs-1 mb-2"></i>
                    <p>Fines information will be displayed here.</p>
                    <small>(Feature coming soon)</small>
                </div>
            </div>

            {# Recent Library Activity - Placeholder Section (could show past returns, holds, etc.) #}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-activity me-2"></i>Recent Library Activity</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-hourglass-split fs-1 mb-2"></i>
                    <p>A log of this student's recent library interactions (e.g., past returns, renewals) will appear here.</p>
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="alert alert-danger text-center" role="alert">
            <h4 class="alert-heading">Student Not Found</h4>
            <p>The requested student profile could not be loaded.</p>
        </div>
    {% endif %}
</div>

{# Re-define macros if not globally available or imported from _macros.html #}
{% macro render_quick_links(links, title="Quick Actions") %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>{{ title }}</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% endblock %}-e 

===== templates/librarian/dashboard.html =====
{% extends "layout/base.html" %}

{# Define Macros at the top so they are available to all blocks in this template #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                {# MODIFIED: Check if the link should be displayed based on its 'condition' attribute #}
                {% if link.condition is not defined or link.condition %}
                    <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                        <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                        <span class="fw-medium">{{ link.text | default('Link') }}</span>
                        <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity to display.</p>
            </div>
        {% endif %}
    </div>
    {% if activities and activities | length > 5 %}
    <a href="{{ url_for('view_notifications') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Activity <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>
{% endmacro %}


{% block page_title %}Librarian Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-bookshelf me-2 text-primary"></i>Librarian Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
             <a href="{{ url_for('add_asset') }}" class="btn btn-sm btn-success me-2">
                <i class="bi bi-plus-circle-fill me-1"></i> Add New Book/Asset
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-info text-white"> {# Changed color for variety #}
                <div class="card-body">
                    <h4 class="card-title font-heading">Library Overview, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Manage book checkouts, track inventory, and oversee student attendance.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {# MODIFIED: render_stat_card calls to be single line #}
        {{ render_stat_card(card_title="Total Books", card_value=total_books | default(0), card_icon="bi bi-journal-bookmark-fill", card_color_class="text-primary", card_url=url_for('list_all_assets', category='Books')) }}

        {{ render_stat_card(card_title="Available Books", card_value=available_books | default(0), card_icon="bi bi-journal-check", card_color_class="text-success", card_url=url_for('list_all_assets', category='Books', status='Available')) }}

        {{ render_stat_card(card_title="Books Checked Out", card_value=checked_out_books | default(0), card_icon="bi bi-journal-arrow-up", card_color_class="text-warning", card_url=url_for('list_checkouts', status='active')) }}

        {{ render_stat_card(card_title="Open Library Reports", card_value=open_library_reports | default(0), card_icon="bi bi-tools", card_color_class="text-danger", card_url=url_for('list_asset_reports')) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Overdue Books #}
        <div class="col-lg-4 col-xl-3">
            {% set librarian_quick_links = [
                {'url': url_for('checkout_book'), 'text': 'Checkout a Book', 'icon': 'bi-cart-plus-fill', 'color_class': 'text-primary'},
                {'url': url_for('list_checkouts'), 'text': 'Manage All Checkouts', 'icon': 'bi-journals', 'color_class': 'text-success'},
                {'url': url_for('librarian_attendance'), 'text': 'View Student Attendance', 'icon': 'bi-calendar3-week-fill', 'color_class': 'text-info'},
                {'url': url_for('my_tasks'), 'text': 'My Tasks', 'icon': 'bi-list-task', 'color_class': 'text-secondary'},
                {'url': url_for('submit_request'), 'text': 'Submit a Request', 'icon': 'bi-file-earmark-plus-fill', 'color_class': 'text-warning', 'condition': permissions and permissions.can_create_request }
            ] %}
            {# MODIFIED: Call render_quick_links without the selectattr filter now #}
            {{ render_quick_links(librarian_quick_links) }}

            {# Overdue Books Placeholder #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-hourglass-bottom me-2 text-danger"></i>Overdue Books</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder" id="overdueBooksContainer">
                     <i class="bi bi-search fs-1 mb-2"></i>
                    <p>Loading overdue books summary...</p>
                    {# This section could be populated by AJAX #}
                </div>
                 <a href="{{ url_for('list_checkouts', status='overdue') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
                    <small>View All Overdue <i class="bi bi-arrow-right-short ms-1"></i></small>
                </a>
            </div>
        </div>

        {# Right Column: Recent Activity & Library Usage Stats (Placeholder) #}
        <div class="col-lg-8 col-xl-9">
            {{ render_recent_activity(recent_activities) }} {# Assuming recent_activities is passed #}

            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-graph-up me-2"></i>Library Usage Statistics</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                     <i class="bi bi-pie-chart-fill fs-1 mb-2"></i>
                    <p>Charts on book popularity, checkout trends, etc., will appear here.</p>
                     <small>(Feature coming soon)</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any librarian dashboard specific JS
        // e.g., AJAX call to populate #overdueBooksContainer
        console.log('Librarian Dashboard JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/librarian/attendance_dashboard.html =====
{% extends "layout/base.html" %}

{% block title %}Library Attendance Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <h1 class="h3 mb-4 text-gray-800">Library Attendance Dashboard</h1>

    <!-- Stat Cards Row -->
    <!-- Backend should pass a 'stats' object with these values -->
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Students Currently in Library</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.current_occupancy }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people-fill h2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Total Visits Today</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_visits_today }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-door-open-fill h2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Peak Hour Today</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.peak_hour }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock-history h2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Average Visit Duration</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.avg_duration_str }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-hourglass-split h2 text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row: Charts and Tables -->
    <div class="row">
        <!-- Peak Hours Chart -->
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Hourly Library Traffic (Today)</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <!-- Recommendation: Use Chart.js to render a bar chart in this canvas -->
                        <!-- The backend must pass 'chart_data' in a JSON-serializable format -->
                        <canvas id="peakHoursChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Currently Present Students -->
        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Students Currently Present</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-group list-group-flush">
                        <!-- Backend should pass a list of 'present_students' -->
                        {% for student in present_students %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ student.user.first_name }} {{ student.user.last_name }}</span>
                            <small class="text-muted">Checked in at {{ student.check_in_time.strftime('%H:%M') }}</small>
                        </li>
                        {% else %}
                        <li class="list-group-item text-center text-muted">The library is currently empty.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include Chart.js from a CDN or local asset -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Peak Hours Chart Logic ---
    const ctx = document.getElementById('peakHoursChart');
    if (ctx) {
        // The backend should serialize 'chart_data' into the template.
        // It's safer and cleaner to put it in a data attribute or a script tag.
        const chartData = JSON.parse('{{ chart_data | tojson | safe }}');
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartData.labels, // e.g., ["8 AM", "9 AM", ...]
                datasets: [{
                    label: "Number of Students",
                    data: chartData.data, // e.g., [5, 12, ...]
                    backgroundColor: 'rgba(78, 115, 223, 0.8)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1,
                    hoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y + ' students';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}-e 

===== templates/parent/dashboard.html =====
{% extends "layout/base.html" %}

{# Macros - ideally in _macros.html and imported, but defined here as per teacher/dashboard.html pattern #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %} {# Example if parent quick links were needed #}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-link-45deg me-2"></i>Useful Links</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                 {# Check if the link should be displayed based on its 'condition' attribute (same as teacher dashboard) #}
                {% if link.condition is not defined or link.condition %}
                    <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                        <i class="bi {{ link.icon | default('bi-box-arrow-up-right') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                        <span class="fw-medium">{{ link.text | default('Link') }}</span>
                        <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}


{% block page_title %}Parent Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-bounding-box me-2 text-primary"></i>Parent Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Account Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-success text-white"> {# Unique color #}
                <div class="card-body">
                    <h4 class="card-title font-heading">Welcome, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Stay connected with your child's academic journey and school activities.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row - Focused on Parent's perspective #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4 mb-4">
        {% set unread_notif_val = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
        {{ render_stat_card(card_title="School Notifications", card_value=unread_notif_val, card_icon="bi-bell-fill", card_color_class="text-warning", card_url=url_for('view_notifications')) }}

        {% set unread_msg_val = unread_messages_count if unread_messages_count != "N/A" else 0 %}
        {{ render_stat_card(card_title="Messages from School", card_value=unread_msg_val, card_icon="bi-envelope-paper-heart-fill", card_color_class="text-info", card_url=url_for('contacts_list')) }}

        {{ render_stat_card(card_title="My Children", card_value=children | length if children else 0, card_icon="bi-people-fill", card_color_class="text-primary", card_url="#childrenList") }}
    </div>

    {# Children's Information Section #}
    <div class="row g-4" id="childrenList">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-hearts me-2"></i>My Children</h5>
                </div>
                <div class="card-body">
                    {% if children and children | length > 0 %}
                        <div class="row row-cols-1 row-cols-md-2 g-4">
                            {% for child in children %}
                                <div class="col">
                                    <div class="card h-100 child-info-card">
                                        <div class="card-body d-flex align-items-center">
                                            {% if child.profile_photo_url %}
                                                <img src="{{ url_for('static', filename=child.profile_photo_url) }}" alt="{{ child.full_name }}" class="rounded-circle me-3 shadow-sm" style="width: 60px; height: 60px; object-fit: cover;">
                                            {% else %}
                                                <i class="bi bi-person-circle fs-1 me-3 text-muted"></i>
                                            {% endif %}
                                            <div>
                                                <h6 class="card-title font-heading mb-1">{{ child.full_name or child.username }}</h6>
                                                <p class="card-text text-muted mb-1 small">
                                                    Grade: {{ child.grade or 'N/A' }} - Section: {{ child.section or 'N/A' }}
                                                </p>
                                                {# Add quick link to child's detailed view if available later #}
                                                <a href="{{ url_for('view_student_behavior_records', user_id=child.id) }}" class="btn btn-sm btn-outline-primary mt-2">
                                                    <i class="bi bi-clipboard2-pulse-fill me-1"></i> View Behavior
                                                </a>
                                                 {# Add link to view marks, attendance if parent has access #}
                                                 {# <a href="#" class="btn btn-sm btn-outline-info mt-2 ms-2"><i class="bi bi-graph-up me-1"></i> View Marks</a> #}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted p-4">
                            <i class="bi bi-person-x-fill fs-1 mb-2"></i>
                            <p>No children are currently linked to your account, or verification is pending.</p>
                            <p><small>If this is incorrect, please contact school administration.</small></p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    {# Recent Behavior Records for Children (if any) #}
    {% if recent_behavior_records and recent_behavior_records | length > 0 %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                 <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-journal-richtext me-2"></i>Recent Behavior Records (Children)</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% for record in recent_behavior_records %}
                    <li class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 font-heading">
                                {{ record.student.full_name or record.student.username }} -
                                <span class="fw-normal">{{ record.behavior_type }}</span>
                            </h6>
                            <small class="text-muted">{{ record.date | dateformat }}</small>
                        </div>
                        <p class="mb-1 text-small text-muted">{{ record.description | truncate(150) }}</p>
                        <small class="text-muted">Severity: {{ record.severity }}
                            | Resolved: <i class="bi {{ 'bi-check-circle-fill text-success' if record.is_resolved else 'bi-x-circle-fill text-danger' }}"></i>
                        </small>
                        {# <a href="{{ url_for('view_student_behavior_records', user_id=record.student_id) }}#record-{{record.id}}" class="float-end small">Details</a> #}
                    </li>
                    {% endfor %}
                </ul>
                {% if children and children | length == 1 %}
                 <a href="{{ url_for('view_student_behavior_records', user_id=children[0].id) }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
                    <small>View All Behavior Records for {{children[0].full_name}} <i class="bi bi-arrow-right-short ms-1"></i></small>
                </a>
                {% elif children and children | length > 1 %}
                 <div class="card-footer text-center text-muted bg-light-subtle">
                    <small>View individual child profiles for all behavior records.</small>
                 </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {# Quick Links - if any specific to parents #}
    {# {% set parent_quick_links = [
        {'url': "#", 'text': 'School Calendar', 'icon': 'bi-calendar-event-fill', 'color_class': 'text-info'},
        {'url': "#", 'text': 'Contact Teachers', 'icon': 'bi-envelope-at-fill', 'color_class': 'text-success'}
    ] %}
    <div class="row mt-4">
        <div class="col-md-6">
            {{ render_quick_links(parent_quick_links) }}
        </div>
    </div> #}

</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any Parent dashboard specific JS
        console.log('Parent Dashboard JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/school_exec/dashboard.html =====
{% extends "layout/base.html" %}

{# DEFINE MACROS FIRST, AFTER EXTENDS #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent High-Level Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('dark') }} p-2 rounded-circle"> {# Darker default for exec #}
                                <i class="bi {{ activity.icon | default('bi-clipboard-data') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View Details <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-archive fs-1 mb-2"></i>
                <p>No recent high-level activity to display.</p>
            </div>
        {% endif %}
    </div>
    {# <a href="#" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View Full Activity Log <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a> #}
</div>
{% endmacro %}
{# END OF MACRO DEFINITIONS #}


{% block page_title %}School Executive Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-building-gear me-2 text-primary"></i>School Executive Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('school_exec_initiate_request') }}" class="btn btn-sm btn-success me-2">
                 <i class="bi bi-send-plus-fill me-1"></i> Initiate Request (Tier 3)
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-info text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Executive Overview, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Monitor key school metrics, manage high-level requests, and track strategic initiatives.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {{ render_stat_card(
            card_title="Total Students",
            card_value=student_count | default(0),
            card_icon="bi-people-fill",
            card_color_class="text-primary",
            card_url=url_for('student_database_index')
        ) }}

        {# Link to staff directory or teacher management page if exists #}
        {{ render_stat_card(
            card_title="Total Staff (Teachers)",
            card_value=teacher_count | default(0),
            card_icon="bi-person-workspace",
            card_color_class="text-success",
            card_url="#"
        ) }}

        {{ render_stat_card(
            card_title="Total Assets",
            card_value=total_assets | default(0),
            card_icon="bi-archive-fill",
            card_color_class="text-info",
            card_url=url_for('list_all_assets')
        ) }}

        {# Backend to filter for Tier 2+ for this user #}
        {{ render_stat_card(
            card_title="Open High-Tier Requests",
            card_value=requests_inbox_count | default(0),
            card_icon="bi-envelope-exclamation-fill",
            card_color_class="text-warning",
            card_url=url_for('requests_inbox')
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Key Reports (Placeholder) #}
        <div class="col-lg-4 col-xl-3">
            {% set exec_quick_links = [
                {'url': url_for('requests_inbox'), 'text': 'Review Assigned Requests', 'icon': 'bi-folder-symlink-fill', 'color_class': 'text-primary'},
                {'url': "#", 'text': 'Budget Overview', 'icon': 'bi-piggy-bank-fill', 'color_class': 'text-success'},
                {'url': "#", 'text': 'Compliance Reports', 'icon': 'bi-file-earmark-check-fill', 'color_class': 'text-info'},
                {'url': "#", 'text': 'Strategic Initiatives', 'icon': 'bi-lightbulb-fill', 'color_class': 'text-warning'}
            ] %}
            {{ render_quick_links(exec_quick_links) }}

            {# Placeholder for Key Performance Indicators (KPIs) #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-graph-up-arrow me-2"></i>Key Performance Indicators</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-clipboard-data-fill fs-1 mb-2"></i>
                    <p>Summary of key school KPIs will be displayed here.</p>
                </div>
            </div>
        </div>

        {# Right Column: Recent High-Level Activity & Analytics (Placeholder) #}
        <div class="col-lg-8 col-xl-9">
            {{ render_recent_activity(recent_executive_activities if recent_executive_activities is defined else []) }}

            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-bar-chart-steps me-2"></i>School-Wide Analytics Snapshot</h5>
                </div>
                <div class="card-body">
                    {# Placeholder for multiple small charts or a summary #}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6 class="text-center text-muted font-heading">Enrollment Trends</h6>
                            <div class="chart-container" style="height: 200px;" id="enrollmentTrendChartContainer">
                                <canvas id="enrollmentTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6 class="text-center text-muted font-heading">Graduation Rates</h6>
                             <div class="chart-container" style="height: 200px;" id="graduationRateChartContainer">
                                <canvas id="graduationRateChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {# This is the end of the content block #}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('School Executive Dashboard JS (using global analytics) loaded.');
        if (typeof fetchAndDisplayAnalytics === 'function') {
            // Example: Assuming backend routes like /analytics/enrollment_trends and /analytics/graduation_rates
            fetchAndDisplayAnalytics('enrollment_trends', 'Enrollment Trends', 'enrollmentTrendChartContainer', 'line');
            fetchAndDisplayAnalytics('graduation_rates', 'Graduation Rates', 'graduationRateChartContainer', 'bar');
        } else {
            console.error("fetchAndDisplayAnalytics function not found. Ensure utils.js is loaded.");
        }
    });
</script>
{% endblock %}
-e 

===== templates/student/library_view.html =====
{% extends "layout/base.html" %}
{% block page_title %}My Borrowed Books{% endblock %}
{% block content_header %}
    <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0"><i class="bi bi-book-half me-2 text-primary"></i>My Borrowed Books</h1>
        <a href="{{ url_for('student_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
{% endblock %}
{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}
    <div class="card shadow-sm">
        <div class="card-body p-0">
            {% if checkouts and checkouts | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for checkout in checkouts %}
                        {% include 'partials/_book_checkout_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-journal-x display-3 mb-3"></i>
                    <h4 class="font-heading">No Books Borrowed</h4>
                    <p>You currently have no books checked out. <a href="{{ url_for('list_all_assets', category='Books') }}">Browse available books?</a></p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/student/dashboard.html =====
{% extends "layout/base.html" %}

{# DEFINE MACROS FIRST #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Links</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}
{# END OF MACRO DEFINITIONS #}


{% block page_title %}Student Dashboard{% endblock %}

{% block content_header %}
    {# ... content_header block content ... #}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-mortarboard-fill me-2 text-primary"></i>Student Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {% if current_user.is_tc_member %}
                <a href="{{ url_for('talent_club_dashboard') }}" class="btn btn-sm btn-outline-info me-2">
                    <i class="bi bi-trophy-fill me-1"></i> Talent Club Home
                </a>
            {% else %}
                 <form action="{{ url_for('join_talent_club') }}" method="POST" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ get_csrf_token_value() }}">
                    <button type="submit" class="btn btn-sm btn-outline-warning me-2">
                        <i class="bi bi-stars me-1"></i> Join Talent Club
                    </button>
                </form>
            {% endif %}
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message & Quick Stats Row #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-primary text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Welcome back, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Here's a quick overview of your academic status and activities.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {% set unread_notif_val = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Notifications",
            card_value=unread_notif_val,
            card_icon="bi-bell-fill",
            card_color_class="text-warning",
            card_url=url_for('view_notifications')
        ) }}

        {% set unread_msg_val = unread_messages_count if unread_messages_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Messages",
            card_value=unread_msg_val,
            card_icon="bi-chat-left-text-fill",
            card_color_class="text-success",
            card_url=url_for('contacts_list')
        ) }}

        {{ render_stat_card(
            card_title="Borrowed Books",
            card_value=borrowed_books | length if borrowed_books else 0,
            card_icon="bi-book-half",
            card_color_class="text-info",
            card_url=url_for('view_library')
        ) }}

        {{ render_stat_card(
            card_title = "Assigned Tasks",
            card_value = my_tasks | length if my_tasks else 0,
            card_icon = "bi-list-task",
            card_color_class = "text-primary",
            card_url = url_for('my_tasks')
        ) }}
    </div>

    {# ... rest of the content block ... #}
    <div class="row g-4">
        {# Left Column: My Marks & Recent Attendance #}
        <div class="col-lg-7 col-xl-8">
            {# My Marks Card #}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-award-fill me-2"></i>My Marks</h5>
                </div>
                <div class="card-body p-0"> {# Remove padding for full-width table #}
                    {% if marks_records and marks_records | length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">Subject</th>
                                        <th scope="col" class="text-center">Semester 1</th>
                                        <th scope="col" class="text-center">Semester 2</th>
                                        <th scope="col" class="text-center">Total</th>
                                        <th scope="col" class="text-center">Average</th>
                                        <th scope="col" class="text-center">Rank</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mark in marks_records %}
                                    <tr>
                                        <td class="fw-medium">{{ mark.subject }}</td>
                                        <td class="text-center">{{ mark.semester_1 if mark.semester_1 is not none else '-' }}</td>
                                        <td class="text-center">{{ mark.semester_2 if mark.semester_2 is not none else '-' }}</td>
                                        <td class="text-center fw-bold">{{ mark.total if mark.total is not none else '-' }}</td>
                                        <td class="text-center fw-bold {{ 'text-success' if mark.average and mark.average >= 75 else ('text-warning' if mark.average and mark.average >= 50 else 'text-danger') }}">{{ mark.average if mark.average is not none else '-' }}</td>
                                        <td class="text-center">{{ mark.rank if mark.rank is not none else '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="bi bi-journal-x fs-2 mb-2 d-block"></i>
                            No marks have been recorded for you yet.
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Recent Attendance Card #}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-calendar-check-fill me-2"></i>Recent Attendance</h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_attendance and recent_attendance | length > 0 %}
                        <ul class="list-group list-group-flush">
                            {% for att in recent_attendance %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="fw-medium">{{ att.date | dateformat('%A, %B %d, %Y') }}</span>
                                        {% if att.notes %}<small class="d-block text-muted fst-italic">- {{ att.notes }}</small>{% endif %}
                                    </div>
                                    <span class="badge fs-09rem
                                        {% if att.status == 'Present' %} bg-success-subtle text-success-emphasis
                                        {% elif att.status == 'Late' %} bg-warning-subtle text-warning-emphasis
                                        {% elif att.status == 'Excused' %} bg-info-subtle text-info-emphasis
                                        {% else %} bg-danger-subtle text-danger-emphasis {% endif %}
                                        p-2 rounded-pill">
                                        {{ att.status }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                         <div class="p-3 text-center text-muted">
                            <i class="bi bi-calendar-x fs-2 mb-2 d-block"></i>
                            No recent attendance records found.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Right Column: Quick Links & My Teachers #}
        <div class="col-lg-5 col-xl-4">
            {# Quick Links Card #}
            {% set student_quick_links = [
                {'url': url_for('view_library'), 'text': 'My Borrowed Books', 'icon': 'bi-book-half', 'color_class': 'text-info'},
                {'url': url_for('my_tasks'), 'text': 'View My Tasks', 'icon': 'bi-list-task', 'color_class': 'text-primary'},
                {'url': url_for('view_student_behavior_records', user_id=current_user.id), 'text': 'My Behavior Log', 'icon': 'bi-person-vcard', 'color_class': 'text-warning'},
                {'url': url_for('contacts_list'), 'text': 'Chat with Teachers', 'icon': 'bi-chat-dots-fill', 'color_class': 'text-success'},
                {'url': url_for('settings'), 'text': 'Account Settings', 'icon': 'bi-gear-fill', 'color_class': 'text-secondary'}
            ] %}
            {% if current_user.is_tc_member %}
                {# Add TC link if member #}
                {% set temp_links = student_quick_links %} {# Avoid modifying list during iteration if it were complex #}
                {% set student_quick_links = temp_links + [{'url': url_for('talent_club_dashboard'), 'text': 'Talent Club Portal', 'icon': 'bi-trophy-fill', 'color_class': 'text-danger'}] %}
            {% endif %}
            {{ render_quick_links(student_quick_links) }}


            {# My Teachers Card (if applicable) #}
            {% if teachers and teachers | length > 0 %}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-workspace me-2"></i>My Teachers ({{ teachers_count }})</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for teacher in teachers %}
                        <a href="{{ url_for('universal_chat', target_user_id=teacher.id) }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            {% if teacher.profile_photo_url %}
                                <img src="{{ url_for('static', filename=teacher.profile_photo_url) }}" alt="{{ teacher.full_name }}" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                            {% else %}
                                <i class="bi bi-person-circle fs-3 me-3 text-muted"></i>
                            {% endif %}
                            <div>
                                <span class="fw-medium">{{ teacher.full_name }}</span>
                                <small class="d-block text-muted">{{ teacher.teacher_profiles[0].subject if teacher.teacher_profiles else 'Teacher' }}</small> {# Assuming first profile subject #}
                            </div>
                            <i class="bi bi-chat-dots-fill ms-auto text-primary"></i>
                        </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}


{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Student Dashboard JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/system_admin/dashboard.html =====
{% extends "layout/base.html" %}

{% block page_title %}System Administration{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-hdd-network-fill me-2 text-primary"></i>System Administration
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {# Example: Button to go to CLI command info or a system health page #}
            {# <a href="#" class="btn btn-sm btn-outline-info me-2">
                <i class="bi bi-terminal-fill me-1"></i> System Tools
            </a> #}
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-person-gear me-1"></i> My Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-dark text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Administrator Control Panel, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Manage users, system settings, monitor logs, and ensure the smooth operation of the Nexus platform.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row - Tailored for System Admin #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {{ render_stat_card(
            card_title="Total Active Users",
            card_value=total_active_users | default(0), {# Backend provides this #}
            card_icon="bi-people-fill",
            card_color_class="text-primary",
            card_url="#" {# Link to User Management Page #}
        ) }}

        {{ render_stat_card(
            card_title="System Roles",
            card_value=total_roles | default(0), {# Backend provides this count #}
            card_icon="bi-person-rolodex",
            card_color_class="text-info",
            card_url="#" {# Link to Role Management Page #}
        ) }}

        {{ render_stat_card(
            card_title="Database Size",
            card_value=db_size | default("N/A"), {# Backend might provide this (conceptual) #}
            card_icon="bi-database-fill-gear",
            card_color_class="text-success",
            card_url="#"
        ) }}

        {{ render_stat_card(
            card_title="Recent Log Events",
            card_value=recent_log_count | default(0), {# Backend might provide this count #}
            card_icon="bi-file-earmark-text-fill",
            card_color_class="text-warning",
            card_url="#" {# Link to System Logs Page #}
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & System Status #}
        <div class="col-lg-4 col-xl-3">
            {% set admin_quick_links = [
                {'url': "#" , 'text': 'Manage Users', 'icon': 'bi-person-lines-fill', 'color_class': 'text-primary'},
                {'url': "#" , 'text': 'Manage Roles & Permissions', 'icon': 'bi-shield-shaded', 'color_class': 'text-info'},
                {'url': url_for('list_all_assets'), 'text': 'View All Assets', 'icon': 'bi-boxes', 'color_class': 'text-success'},
                {'url': url_for('manage_asset_categories'), 'text': 'Manage Asset Categories', 'icon': 'bi-tags-fill', 'color_class': 'text-secondary'},
                {'url': "#" , 'text': 'System Configuration', 'icon': 'bi-sliders', 'color_class': 'text-warning'},
                {'url': "#" , 'text': 'View System Logs', 'icon': 'bi-journal-text', 'color_class': 'text-danger'},
                {'url': url_for('create_task'), 'text': 'Create System Task', 'icon': 'bi-plus-square-dotted', 'color_class': 'text-primary'}
            ] %}
            {{ render_quick_links(admin_quick_links) }}

            {# System Health/Status Placeholder #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-heart-pulse-fill me-2 text-success"></i>System Status</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between mb-2"><span>Database Connection:</span> <span class="badge bg-success-subtle text-success-emphasis p-2">Operational</span></li>
                        <li class="d-flex justify-content-between mb-2"><span>Mail Server:</span> <span class="badge bg-secondary-subtle text-secondary-emphasis p-2">Not Configured</span></li>
                        <li class="d-flex justify-content-between"><span>Background Tasks:</span> <span class="badge bg-success-subtle text-success-emphasis p-2">Running</span></li>
                    </ul>
                </div>
            </div>
        </div>

        {# Right Column: Recent Admin Activities & Critical Alerts #}
        <div class="col-lg-8 col-xl-9">
            {{ render_recent_activity(recent_admin_activities) }} {# Assuming recent_admin_activities is passed #}

            {# Critical System Alerts Placeholder #}
            <div class="card shadow-sm mt-4 border-danger">
                <div class="card-header bg-danger-subtle text-danger-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Critical System Alerts</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-shield-fill-exclamation fs-1 mb-2"></i>
                    <p>No critical alerts at this time.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{# Macros - ideally in _macros.html #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Admin Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('dark') }} p-2 rounded-circle"> {# Darker default for admin #}
                                <i class="bi {{ activity.icon | default('bi-terminal') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">Details <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-hdd-rack fs-1 mb-2"></i>
                <p>No recent administrative activity logged.</p>
            </div>
        {% endif %}
    </div>
    {% if activities and activities | length > 5 %}
    <a href="#" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light"> {# Link to full admin log page #}
        <small>View Full Admin Log <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>
{% endmacro %}
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any System Admin dashboard specific JS
        // e.g., AJAX calls to fetch system health or real-time log snippets
        console.log('System Admin Dashboard JS loaded.');

        // Example: Simulate fetching system status for the placeholder card
        // setTimeout(function() {
        //     const dbStatus = document.querySelector('#systemStatusDb');
        //     if(dbStatus) dbStatus.innerHTML = '<span class="badge bg-success-subtle text-success-emphasis p-2">Operational</span>';
        // }, 1500);
    });
</script>
{% endblock %}-e 

===== templates/teacher/lab_equipment.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Lab Equipment - {{ lab_name }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-binoculars-fill me-2 text-primary"></i>Lab Equipment: {{ lab_name }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
             <a href="{{ url_for('add_asset') }}" class="btn btn-sm btn-success me-2" title="Request new equipment for your lab">
                <i class="bi bi-plus-circle-dotted me-1"></i> Request New Equipment
            </a>
            <a href="{{ url_for('teacher_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {% if not current_user.lab_id %}
        <div class="alert alert-warning" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Not Assigned to a Lab</h4>
            <p>You are not currently assigned to a specific lab. Therefore, no lab equipment can be displayed for you.</p>
            <hr>
            <p class="mb-0">If you believe this is an error, please contact an administrator to have your lab assignment updated.</p>
        </div>
    {% elif lab_equipment and lab_equipment | length > 0 %}
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0 font-heading">Equipment in {{ lab_name }}</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Asset ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Category</th>
                                <th scope="col">Quantity</th>
                                <th scope="col">Condition</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in lab_equipment %}
                            <tr>
                                <td>{{ asset.id }}</td>
                                <td class="fw-medium">
                                    {# Link to a detailed asset view if one exists for teachers, or HR edit view if appropriate and permitted #}
                                    {{ asset.name | truncate(40) }}
                                </td>
                                <td><span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">{{ asset.category.name if asset.category else 'N/A' }}</span></td>
                                <td>{{ asset.quantity }}</td>
                                <td>
                                    {% if asset.condition == 'New' or asset.condition == 'Good' %} <span class="badge bg-success-subtle text-success-emphasis rounded-pill">{{ asset.condition }}</span>
                                    {% elif asset.condition == 'Fair' %} <span class="badge bg-info-subtle text-info-emphasis rounded-pill">{{ asset.condition }}</span>
                                    {% elif asset.condition == 'Poor' or asset.condition == 'Needs Repair' %} <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">{{ asset.condition }}</span>
                                    {% elif asset.condition == 'Broken' %} <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">{{ asset.condition }}</span>
                                    {% else %} <span class="badge bg-light text-dark border rounded-pill">{{ asset.condition }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if asset.status == 'Available' %} <span class="badge bg-success-subtle text-success-emphasis rounded-pill">{{ asset.status }}</span>
                                    {% elif asset.status == 'Pending Review' %} <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill">{{ asset.status }}</span>
                                    {% elif asset.status == 'CheckedOut' %} <span class="badge bg-info-subtle text-info-emphasis rounded-pill">Checked Out</span>
                                    {% elif asset.status == 'Under Maintenance' or asset.status == 'Needs Repair' %} <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">{{ asset.status }}</span>
                                    {% else %} <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ asset.status | default('Unknown') }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('report_asset_specific', asset_id=asset.id) }}" class="btn btn-sm btn-outline-warning p-1" title="Report Issue with this Asset">
                                        <i class="bi bi-exclamation-triangle-fill fs-6"></i> Report
                                    </a>
                                    {# Teachers typically don't edit assets directly, but HR/CEO can #}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="text-center text-muted p-5 content-placeholder">
            <i class="bi bi-box-fill display-3 mb-3"></i>
            <h4 class="font-heading">No Equipment Listed</h4>
            <p>There is currently no equipment listed for your assigned lab: <strong>{{ lab_name }}</strong>.</p>
            <p>You can <a href="{{ url_for('add_asset') }}">request new equipment</a> if needed.</p>
        </div>
    {% endif %}
</div>
{% endblock %}-e 

===== templates/teacher/student_profile_view.html =====
{% extends "layout/base.html" %}

{% set student_page_title = "Student Profile: " + (student.full_name or student.username if student else "N/A") %}
{% block page_title %}{{ student_page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0 text-truncate" style="max-width: 70%;">
            <i class="bi bi-person-vcard-fill me-2 text-primary"></i>{{ student_page_title }}
        </h1>
        <a href="{{ request.referrer or url_for('student_database_block', grade=student.grade, section=student.section) if student and student.grade and student.section else url_for('teacher_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {% if student %}
    <div class="row g-4">
        {# Left Column: Student Info & Quick Actions #}
        <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm mb-4 text-center">
                <div class="card-body">
                    {% set student_avatar = url_for('static', filename=(student.profile_photo_url if student.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                    <img src="{{ student_avatar }}" alt="{{ student.username }}" class="rounded-circle mb-3 shadow-sm" style="width: 120px; height: 120px; object-fit: cover; border: 3px solid var(--nexus-border-color);">
                    <h4 class="font-heading mb-1">{{ student.full_name or student.username }}</h4>
                    <p class="text-muted mb-0">{{ student.username }}</p>
                    <p class="text-muted"><small>Grade: {{ student.grade or 'N/A' }} | Section: {{ student.section or 'N/A' }}</small></p>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                 <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-lines-fill me-2"></i>Contact & Details</h5>
                </div>
                <ul class="list-group list-group-flush small">
                    <li class="list-group-item"><strong>Email:</strong> {{ student.email or 'N/A' }}</li>
                    <li class="list-group-item"><strong>Phone:</strong> {{ student.phone or 'N/A' }}</li>
                    <li class="list-group-item"><strong>Date of Birth:</strong> {{ student.date_of_birth | dateformat if student.date_of_birth else 'N/A' }} (Age: {{ student.age or 'N/A' }})</li>
                    <li class="list-group-item"><strong>Gender:</strong> {{ student.gender or student.sex or 'N/A' }}</li>
                    {# Add more relevant details if available on User model #}
                </ul>
            </div>

            {% set student_profile_quick_links = [
                {'url': url_for('add_behavior_record', student_id=student.id), 'text': 'Log Behavior', 'icon': 'bi-journal-plus', 'color_class': 'text-warning'},
                {'url': url_for('universal_chat', target_user_id=student.id), 'text': 'Send Message', 'icon': 'bi-chat-dots-fill', 'color_class': 'text-success'},
                {'url': url_for('send_notification_to_user', receiver_id=student.id), 'text': 'Send Notification', 'icon': 'bi-bell-fill', 'color_class': 'text-info'}
            ] %}
            {{ render_quick_links(student_profile_quick_links, "Teacher Actions") }}
        </div>

        {# Right Column: Academic Performance, Attendance, Behavior #}
        <div class="col-lg-8 col-xl-9">
            {# Marks/Grades Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 font-heading"><i class="bi bi-award-fill me-2"></i>Academic Performance</h5>
                    {% if current_user.role.name == 'teacher' and teacher_profile and student.grade == teacher_profile.grade and student.section == teacher_profile.section %}
                    <a href="{{ url_for('enter_marks') }}?student_id={{ student.id }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil-square me-1"></i> Edit Marks</a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                     {% if student_marks and student_marks | length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Subject</th>
                                        <th class="text-center">Sem 1</th>
                                        <th class="text-center">Sem 2</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Average</th>
                                        <th class="text-center">Rank</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for mark in student_marks %}
                                    <tr>
                                        <td class="fw-medium">{{ mark.subject }}</td>
                                        <td class="text-center">{{ mark.semester_1 if mark.semester_1 is not none else '-' }}</td>
                                        <td class="text-center">{{ mark.semester_2 if mark.semester_2 is not none else '-' }}</td>
                                        <td class="text-center fw-bold">{{ mark.total if mark.total is not none else '-' }}</td>
                                        <td class="text-center fw-bold {{ 'text-success' if mark.average and mark.average >= 75 else ('text-warning' if mark.average and mark.average >= 50 else 'text-danger') }}">{{ mark.average if mark.average is not none else '-' }}</td>
                                        <td class="text-center">{{ mark.rank if mark.rank is not none else '-' }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center p-3">No marks recorded for this student yet.</p>
                    {% endif %}
                </div>
            </div>

            {# Attendance Section #}
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 font-heading"><i class="bi bi-calendar-check-fill me-2"></i>Recent Attendance</h5>
                     {% if current_user.role.name == 'teacher' and teacher_profile and student.grade == teacher_profile.grade and student.section == teacher_profile.section %}
                     <a href="{{ url_for('mark_attendance') }}?date={{ now.strftime('%Y-%m-%d') }}&highlight_student={{ student.id }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-calendar-plus me-1"></i> Mark Today's Attendance</a>
                    {% endif %}
                </div>
                 <div class="list-group list-group-flush" style="max-height: 250px; overflow-y:auto;">
                    {% if student_attendance and student_attendance | length > 0 %}
                        {% for att in student_attendance %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ att.date | dateformat('%A, %b %d, %Y') }}</span>
                                <span class="badge fs-08rem p-2 rounded-pill
                                    {% if att.status == 'Present' %} bg-success-subtle text-success-emphasis
                                    {% elif att.status == 'Late' %} bg-warning-subtle text-warning-emphasis
                                    {% elif att.status == 'Excused' %} bg-info-subtle text-info-emphasis
                                    {% else %} bg-danger-subtle text-danger-emphasis {% endif %}">
                                    {{ att.status }}
                                </span>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item text-muted text-center p-3">No recent attendance records.</div>
                    {% endif %}
                </div>
            </div>

            {# Behavior Records Section #}
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-exclamation me-2"></i>Behavior Log</h5>
                    <a href="{{ url_for('view_student_behavior_records', user_id=student.id) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-view-list me-1"></i> View Full Log & Add</a>
                </div>
                 <div class="list-group list-group-flush" style="max-height: 250px; overflow-y:auto;">
                    {% if student_behavior_records and student_behavior_records | length > 0 %}
                        {% for record in student_behavior_records %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <span class="fw-medium">{{ record.behavior_type }} - {{ record.date | dateformat }}</span>
                                    <small class="text-muted">Severity: {{ record.severity }}</small>
                                </div>
                                <p class="mb-1 small text-muted">{{ record.description | truncate(100) }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                         <div class="list-group-item text-muted text-center p-3">No behavior records logged recently.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
        <div class="alert alert-danger text-center" role="alert">
            <h4 class="alert-heading">Student Not Found</h4>
            <p>The requested student profile could not be loaded.</p>
        </div>
    {% endif %}
</div>

{# Re-define macros if not globally available or imported from _macros.html #}
{% macro render_quick_links(links, title="Quick Actions") %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>{{ title }}</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% endblock %}-e 

===== templates/teacher/dashboard.html =====
{% extends "layout/base.html" %}

{# Define macros at the top of the file, before they are used #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                {# Check if the link should be displayed based on its 'condition' attribute #}
                {% if link.condition is not defined or link.condition %}
                    <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                        <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                        <span class="fw-medium">{{ link.text | default('Link') }}</span>
                        <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                    </a>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity to display.</p>
            </div>
        {% endif %}
    </div>
    {% if activities and activities | length > 5 %}
    <a href="{{ url_for('view_notifications') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Activity <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>
{% endmacro %}

{% block page_title %}Teacher Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-video3 me-2 text-primary"></i>Teacher Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message & Key Info #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-primary text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Welcome, {{ current_user.full_name or current_user.username }}!</h4>
                    {% if teacher_profile and teacher_profile.subject and teacher_profile.grade and teacher_profile.section %}
                        <p class="mb-0">
                            You are currently assigned to teach <strong>{{ teacher_profile.subject }}</strong>
                            for <strong>Grade {{ teacher_profile.grade }} - Section {{ teacher_profile.section }}</strong>.
                            Your assigned lab is <strong>{{ lab_name | default('Not Assigned') }}</strong>.
                        </p>
                    {% else %}
                        <p class="mb-0">Your teaching profile seems incomplete. Please contact administration if your class/subject details are missing.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {% set unread_notif_val = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Notifications",
            card_value=unread_notif_val,
            card_icon="bi-bell-fill",
            card_color_class="text-warning",
            card_url=url_for('view_notifications')
        ) }}

        {% set unread_msg_val = unread_messages_count if unread_messages_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Messages",
            card_value=unread_msg_val,
            card_icon="bi-chat-left-text-fill",
            card_color_class="text-success",
            card_url=url_for('contacts_list')
        ) }}

        {{ render_stat_card(
            card_title="Students in Class",
            card_value=students_count | default(0),
            card_icon="bi-people-fill",
            card_color_class="text-info",
            card_url=url_for('student_database_block', grade=(teacher_profile.grade if teacher_profile else 'N/A'), section=(teacher_profile.section if teacher_profile else 'N/A')) if teacher_profile and teacher_profile.grade and teacher_profile.section else "#"
        ) }}

        {{ render_stat_card(
            card_title="Assigned Tasks",
            card_value=my_tasks | length if my_tasks else 0,
            card_icon="bi-list-task",
            card_color_class="text-primary",
            card_url=url_for('my_tasks')
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Class Schedule (Placeholder) #}
        <div class="col-lg-4 col-xl-3">
            {% set teacher_quick_links = [
                {'url': url_for('mark_attendance'), 'text': 'Mark Attendance', 'icon': 'bi-calendar-check-fill', 'color_class': 'text-primary'},
                {'url': url_for('enter_marks'), 'text': 'Enter Student Marks', 'icon': 'bi-pencil-square', 'color_class': 'text-success'},
                {'url': url_for('teacher_lab_equipment'), 'text': 'My Lab Equipment', 'icon': 'bi-binoculars-fill', 'color_class': 'text-info'},
                {'url': url_for('my_tasks'), 'text': 'My Tasks', 'icon': 'bi-list-task', 'color_class': 'text-secondary'},
                {'url': url_for('submit_request'), 'text': 'Submit a Request', 'icon': 'bi-file-earmark-plus-fill', 'color_class': 'text-warning', 'condition': permissions and permissions.can_create_request }
            ] %}
            {# Call render_quick_links without the selectattr filter now #}
            {{ render_quick_links(teacher_quick_links) }}

            {# Class Schedule/Timetable Placeholder #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-table me-2"></i>My Schedule</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                    <i class="bi bi-hourglass-split fs-1 mb-2"></i>
                    <p>Class schedule will be displayed here.</p>
                    <small>(Feature coming soon)</small>
                </div>
            </div>
        </div>

        {# Right Column: Recent Activity & Student Performance Overview (Placeholder) #}
        <div class="col-lg-8 col-xl-9">
            {# Recent Activity/Notifications for Teacher #}
            {# Assuming recent_activities is passed from backend for the teacher #}
            {{ render_recent_activity(recent_activities) }}

            {# Student Performance Overview Placeholder #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-graph-up-arrow me-2"></i>Class Performance Overview</h5>
                </div>
                <div class="card-body text-center text-muted content-placeholder">
                     <i class="bi bi-pie-chart-fill fs-1 mb-2"></i>
                    <p>A summary of class performance trends will appear here.</p>
                     <small>(Feature coming soon)</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any teacher dashboard specific JS
        console.log('Teacher Dashboard JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/teacher/attendance.html =====
{% extends "layout/base.html" %}

{% block title %}Take Attendance{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Take Attendance</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('teacher_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Attendance</li>
                </ol>
            </nav>
        </div>
        <!-- Date Display: Assumes 'attendance_date' is passed from the backend -->
        <div class="text-end">
            <span class="h5 font-weight-bold">{{ attendance_date.strftime('%A, %B %d, %Y') }}</span>
        </div>
    </div>

    <!-- Main Attendance Form Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <!-- Class Information: Assumes 'class_section' object is passed -->
            <h6 class="m-0 font-weight-bold text-primary">
                Class: {{ class_section.class_name }} | Section: {{ class_section.section_name }}
            </h6>
            <!-- Utility Button for Teachers -->
            <button type="button" id="markAllPresentBtn" class="btn btn-sm btn-outline-success">
                <i class="bi bi-check-all me-1"></i> Mark All Present
            </button>
        </div>
        <div class="card-body">
            <!-- Form Submission: The route should handle the POST request -->
            <form method="POST" action="{{ url_for('take_attendance', class_id=class_section.id) }}">
                {{ form.csrf_token }}
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="attendanceTable" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th class="col-1">#</th>
                                <th class="col-4">Student Name</th>
                                <th class="col-2">Student ID</th>
                                <th class="col-5 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 
                                The backend should pass a list of student objects.
                                It should also pass 'attendance_records', a dictionary mapping student_id to their status
                                if attendance has already been taken for this day, to repopulate the form.
                            -->
                            {% for student in students %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ student.first_name }} {{ student.last_name }}</td>
                                <td>{{ student.student_id }}</td>
                                <td class="text-center">
                                    <!-- 
                                        Radio buttons are superior to a dropdown for a small, fixed set of options.
                                        They reduce clicks and make the state of all students visible at once.
                                        The name attribute is unique per student to group their radios.
                                        The 'checked' attribute is set if a record already exists for this student.
                                    -->
                                    <div class="btn-group" role="group" aria-label="Attendance status for {{ student.first_name }}">
                                        {% set current_status = attendance_records.get(student.id, 'P') %} {# Default to Present #}
                                        
                                        <input type="radio" class="btn-check" name="status_{{ student.id }}" id="present_{{ student.id }}" value="P" autocomplete="off" {% if current_status == 'P' %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="present_{{ student.id }}">Present</label>

                                        <input type="radio" class="btn-check" name="status_{{ student.id }}" id="absent_{{ student.id }}" value="A" autocomplete="off" {% if current_status == 'A' %}checked{% endif %}>
                                        <label class="btn btn-outline-danger" for="absent_{{ student.id }}">Absent</label>

                                        <input type="radio" class="btn-check" name="status_{{ student.id }}" id="late_{{ student.id }}" value="L" autocomplete="off" {% if current_status == 'L' %}checked{% endif %}>
                                        <label class="btn btn-outline-warning" for="late_{{ student.id }}">Late</label>

                                        <input type="radio" class="btn-check" name="status_{{ student.id }}" id="excused_{{ student.id }}" value="E" autocomplete="off" {% if current_status == 'E' %}checked{% endif %}>
                                        <label class="btn btn-outline-info" for="excused_{{ student.id }}">Excused</label>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No students found in this class section.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Form Submission Button -->
                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i> Submit Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// This is a self-contained, non-obtrusive script for the "Mark All Present" utility.
// It uses modern JavaScript and requires no external libraries like jQuery.
document.addEventListener('DOMContentLoaded', function() {
    const markAllPresentBtn = document.getElementById('markAllPresentBtn');
    if (markAllPresentBtn) {
        markAllPresentBtn.addEventListener('click', function() {
            // Find all radio buttons with a value of 'P' (Present)
            const presentRadios = document.querySelectorAll('input[type="radio"][value="P"]');
            
            // Iterate and check each 'Present' radio button
            presentRadios.forEach(radio => {
                radio.checked = true;
            });

            // Optional: Provide visual feedback to the user
            this.innerHTML = '<i class="bi bi-check-all me-1"></i> Done!';
            this.classList.remove('btn-outline-success');
            this.classList.add('btn-success');
            setTimeout(() => {
                this.innerHTML = '<i class="bi bi-check-all me-1"></i> Mark All Present';
                this.classList.remove('btn-success');
                this.classList.add('btn-outline-success');
            }, 1500);
        });
    }
});
</script>
{% endblock %}-e 

===== templates/teacher/marks.html =====
{% extends "layout/base.html" %}
{% from "macros/_form_helpers.html" import render_field %}

{% block title %}Enter & Edit Marks{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <h1 class="h3 mb-4 text-gray-800">Enter & Edit Student Marks</h1>

    <!-- Filter Form Card -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Select Class and Assessment</h6>
        </div>
        <div class="card-body">
            <!-- 
                This form allows the teacher to select which set of marks to view/edit.
                The form should be submitted via GET to update the URL and reload the page with the correct data.
            -->
            <form method="GET" action="{{ url_for('enter_marks') }}" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <!-- Assumes filter_form has 'class_section' and 'assessment' fields -->
                    {{ render_field(filter_form.class_section, class="form-select") }}
                </div>
                <div class="col-md-5">
                    {{ render_field(filter_form.assessment, class="form-select") }}
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-filter me-1"></i> Load Students
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Marks Entry Table: This section is only displayed if a class and assessment have been selected -->
    {% if students and selected_assessment %}
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                Entering Marks for: {{ selected_assessment.name }} (Total Marks: {{ selected_assessment.total_marks }})
            </h6>
        </div>
        <div class="card-body">
            <!-- The main form for submitting all marks at once -->
            <form method="POST" action="{{ url_for('enter_marks') }}">
                {{ form.csrf_token }}
                <!-- Hidden fields to pass context back to the server on POST -->
                <input type="hidden" name="class_section_id" value="{{ selected_class_section.id }}">
                <input type="hidden" name="assessment_id" value="{{ selected_assessment.id }}">
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="marksTable" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Student Name</th>
                                <th>Student ID</th>
                                <th>Score / {{ selected_assessment.total_marks }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loop through the students for the selected class -->
                            {% for student in students %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ student.first_name }} {{ student.last_name }}</td>
                                <td>{{ student.student_id }}</td>
                                <td>
                                    <!-- 
                                        The input name is unique per student.
                                        The 'marks' dictionary maps student_id to their existing mark object.
                                        HTML5 type="number" provides basic validation and a better UX on mobile.
                                    -->
                                    <input type="number" 
                                           name="mark_{{ student.id }}" 
                                           class="form-control" 
                                           value="{{ marks.get(student.id).score if marks.get(student.id) else '' }}"
                                           min="0"
                                           max="{{ selected_assessment.total_marks }}"
                                           placeholder="Enter score"
                                           aria-label="Score for {{ student.first_name }}">
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center">No students found for this selection.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i> Save All Marks
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% elif request.args.get('class_section') %}
    <!-- Shown if filters are selected but no students are found -->
    <div class="alert alert-warning" role="alert">
        No students are enrolled in the selected class section. Please select another class or enroll students.
    </div>
    {% else %}
    <!-- Initial empty state before any filters are applied -->
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>
        Please select a class and an assessment from the dropdowns above to begin entering marks.
    </div>
    {% endif %}
</div>
{% endblock %}-e 

===== templates/talent_club_role_dashboard/dashboard.html =====
{% extends "layout/base.html" %}
{% block title %}Manage: {{ club.name }}{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Club Management Dashboard</h1>
            <p class="text-muted mb-0">You are managing: <strong>{{ club.name }}</strong></p>
        </div>
        <a href="{{ url_for('club_profile', club_id=club.id) }}" class="btn btn-outline-secondary"><i class="bi bi-eye-fill me-1"></i> View Public Profile</a>
    </div>

    <div class="row">
        <!-- Member Management -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Manage Members</h6></div>
                <div class="card-body">
                    <h5 class="card-title">Pending Join Requests</h5>
                    <div class="list-group mb-3">
                        {% for req in pending_requests %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>{{ req.sender.first_name }} {{ req.sender.last_name }}</span>
                                <span><!-- Action buttons here --></span>
                            </div>
                        {% else %}
                            <div class="list-group-item text-muted">No pending requests.</div>
                        {% endfor %}
                    </div>
                    <h5 class="card-title">Current Members</h5>
                    <div class="list-group">
                        {% for member in club.memberships %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>{{ member.user.first_name }} {{ member.user.last_name }}</span>
                                <span>{{ member.role }}</span>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- Proposal & Task Management -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Proposals & Tasks</h6></div>
                <div class="card-body">
                    <!-- Actions to create proposals/tasks -->
                    <a href="#" class="btn btn-primary w-100 mb-3">Create New Task</a>
                    <a href="#" class="btn btn-outline-primary w-100">Create New Proposal</a>
                    <hr>
                    <h5 class="card-title">Pending Proposals</h5>
                     <div class="list-group">
                        {% for prop in pending_proposals %}
                            <div class="list-group-item d-flex justify-content-between">
                                <span>{{ prop.title }}</span>
                                <span><a href="#" class="btn btn-sm btn-secondary">Review</a></span>
                            </div>
                        {% else %}
                             <div class="list-group-item text-muted">No proposals awaiting review.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}