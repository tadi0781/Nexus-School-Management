===== PHASE 6: OPERATIONS & MANAGEMENT =====
-e 

===== templates/tasks/my_assigned_tasks.html =====
{% extends "layout/base.html" %}

{% block page_title %}Tasks I Assigned{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-card-checklist me-2 text-primary"></i>Tasks I Created & Assigned
        </h1>
        <a href="{{ url_for('create_task') }}" class="btn btn-sm btn-success">
            <i class="bi bi-plus-circle-fill me-1"></i> Create New Task
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {# Filters - Placeholder for future (e.g., filter by task status, urgency, due date range) #}
    {# <div class="card shadow-sm mb-3">
        <div class="card-body bg-light-subtle py-2 px-3">
            <small class="text-muted">Filters: (Coming soon)</small>
        </div>
    </div> #}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Overview of Tasks You Created</h5>
        </div>
        <div class="card-body p-0">
            {% if my_created_tasks and my_created_tasks | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for task in my_created_tasks %}
                        <div class="list-group-item task-creator-view-item py-3 px-3 mb-2 shadow-sm border rounded">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1 font-heading">
                                    <a href="{{ url_for('view_assigned_task_detail', task_id=task.id) }}" class="text-decoration-none">
                                        <i class="bi bi-journal-text me-1"></i> {{ task.title | truncate(60) }}
                                    </a>
                                </h6>
                                <small class="text-muted">Created: {{ task.created_at | dateformat }}</small>
                            </div>
                            <p class="mb-2 text-muted small">{{ task.description | truncate(100) }}</p>
                            <div class="d-flex justify-content-between align-items-center small">
                                <div>
                                    <span class="me-2" title="Urgency"><strong>Urgency:</strong>
                                        {% if task.urgency == 'Critical' %}<span class="badge bg-danger text-white rounded-pill">{{ task.urgency }}</span>
                                        {% elif task.urgency == 'High' %}<span class="badge bg-warning text-dark rounded-pill">{{ task.urgency }}</span>
                                        {% else %}<span class="badge bg-info text-white rounded-pill">{{ task.urgency }}</span>{% endif %}
                                    </span>
                                    {% if task.due_date %}
                                    <span title="Due Date"><strong>Due:</strong> {{ task.due_date | dateformat }}
                                        {% if task.due_date < now.date() %}<span class="badge bg-danger-subtle text-danger-emphasis ms-1">OVERDUE</span>{% endif %}
                                    </span>
                                    {% endif %}
                                </div>
                                <a href="{{ url_for('view_assigned_task_detail', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">
                                    View Assignments ({{ task.user_assignments.count() if task.user_assignments else 0 }}) <i class="bi bi-arrow-right-short"></i>
                                </a>
                            </div>
                            {# Assignment Status Summary #}
                            {% set counts = task_status_counts.get(task.id, {}) %}
                            {% if counts %}
                            <div class="mt-2 pt-2 border-top border-light-subtle">
                                <small class="text-muted fw-medium">Assignment Statuses:</small>
                                <div class="d-flex flex-wrap gap-2 mt-1">
                                    {% for status, count in counts.items() %}
                                        {% if count > 0 %}
                                        <span class="badge rounded-pill px-2 py-1 fs-08rem
                                            {% if status == 'Open' %} bg-info-subtle text-info-emphasis
                                            {% elif status == 'In Progress' %} bg-primary-subtle text-primary-emphasis
                                            {% elif status.endswith('(Pending Review)') %} bg-warning-subtle text-warning-emphasis
                                            {% elif status == 'Accepted' %} bg-success-subtle text-success-emphasis
                                            {% elif status == 'Review Rejected' %} bg-danger-subtle text-danger-emphasis
                                            {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}">
                                            {{ status | replace(' (Pending Review)', '') }}: {{ count }}
                                        </span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-journal-plus display-3 mb-3"></i>
                    <h4 class="font-heading">No Tasks Created Yet</h4>
                    <p>You haven't created and assigned any tasks. <a href="{{ url_for('create_task') }}">Create one now!</a></p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination #}
    </div>
</div>
{% endblock %}-e 

===== templates/tasks/user_task_detail.html =====
{% extends "layout/base.html" %}

{% block title %}Task: {{ task.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Main Task Content -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h1 class="h4 m-0 font-weight-bold text-primary">{{ task.title }}</h1>
                </div>
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Description</h6>
                    <p>{{ task.description | nl2br | safe }}</p>
                    
                    {% if task.subtasks %}
                    <hr>
                    <h6 class="mt-4">Checklist</h6>
                    <ul class="list-group list-group-flush">
                        {% for subtask in task.subtasks %}
                        <li class="list-group-item">
                            <input class="form-check-input me-1" type="checkbox" value="" id="subtask-{{ subtask.id }}" {{ 'checked' if subtask.is_completed }}>
                            <label class="form-check-label {{ 'text-decoration-line-through' if subtask.is_completed }}" for="subtask-{{ subtask.id }}">
                                {{ subtask.description }}
                            </label>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Sidebar with Metadata and Actions -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <strong>Details</strong>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>Status:</span> <strong><span class="badge bg-primary">{{ task.status | capitalize }}</span></strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Due Date:</span> <strong>{{ task.due_date.strftime('%Y-%m-%d') if task.due_date else 'N/A' }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Assigned by:</span> <strong>{{ task.assigner.first_name }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>Related Club:</span> <a href="{{ url_for('club_profile', club_id=task.talent_club.id) }}">{{ task.talent_club.name }}</a></li>
                </ul>
                <div class="card-body">
                    {% if task.status != 'COMPLETED' %}
                    <form method="POST" action="{{ url_for('complete_task', task_id=task.id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-check-circle-fill me-2"></i>Mark as Complete
                        </button>
                    </form>
                    {% else %}
                    <div class="alert alert-success text-center" role="alert">
                        Task Completed!
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/tasks/create.html =====
{% extends "layout/base.html" %}

{% block page_title %}Create New Task{% endblock %}

{% block content_header %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="page-title font-heading mb-0">
        <i class="bi bi-plus-square-dotted me-2 text-primary"></i>Create New Task
    </h1>
    <a href="{{ url_for('my_assigned_tasks') if current_user.role.name in TASK_CREATOR_ROLES else url_for('my_tasks') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to Tasks
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">Task Details & Assignment</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('create_task') }}" id="createTaskForm" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        {# --- Task Information (Unchanged) --- #}
                        <fieldset class="mb-4">
                            <legend class="font-heading fs-5 mb-3 border-bottom pb-2">Task Information</legend>
                            <div class="mb-3">
                                {{ form.title.label(class="form-label fw-medium") }}
                                {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="Enter a clear and concise task title") }}
                                {% if form.title.errors %}<div class="invalid-feedback">{% for e in form.title.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="mb-3">
                                {{ form.description.label(class="form-label fw-medium") }}
                                {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="5", placeholder="Provide a detailed description of the task, expected outcomes, and any necessary instructions.") }}
                                {% if form.description.errors %}<div class="invalid-feedback">{% for e in form.description.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.due_date.label(class="form-label fw-medium") }}
                                    {{ form.due_date(class="form-control flatpickr-date" + (" is-invalid" if form.due_date.errors else ""), placeholder="YYYY-MM-DD (Optional)") }}
                                    {% if form.due_date.errors %}<div class="invalid-feedback">{% for e in form.due_date.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.urgency.label(class="form-label fw-medium") }}
                                    {{ form.urgency(class="form-select" + (" is-invalid" if form.urgency.errors else "")) }}
                                    {% if form.urgency.errors %}<div class="invalid-feedback">{% for e in form.urgency.errors %}{{e}}{% endfor %}</div>{% endif %}
                                </div>
                            </div>
                        </fieldset>

                        {# --- MODERN UNIFIED ASSIGNMENT SECTION --- #}
                        <fieldset class="mb-4">
                            <legend class="font-heading fs-5 mb-3 border-bottom pb-2">Assign Task To</legend>
                            <div class="mb-3">
                                <label for="assigneePicker" class="form-label fw-medium">Assignees</label>
                                <select id="assigneePicker" multiple placeholder="Search for users, roles, or classes..."></select>
                                <small class="form-text text-muted">You can assign this task to individual users, entire roles (e.g., all Teachers), or specific classes (e.g., Grade 9, Section A).</small>
                                
                                {# Hidden input to store the structured selection data #}
                                <input type="hidden" name="assignees_data" id="assignees_data">
                            </div>
                        </fieldset>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('my_assigned_tasks') if current_user.role.name in TASK_CREATOR_ROLES else url_for('my_tasks') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4 btn-lg", value="Create & Assign Task") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/tasks.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the new, modern assignee picker
        if (typeof initializeModernAssigneePicker === 'function') {
            initializeModernAssigneePicker({
                pickerId: 'assigneePicker',
                hiddenInputId: 'assignees_data',
                searchUrl: "{{ url_for('api_search_assignees') }}" // Use the new API endpoint
            });
        } else {
            console.error('initializeModernAssigneePicker function not found in tasks.js');
        }
    });
</script>
{% endblock %}-e 

===== templates/tasks/my_tasks.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Assigned Tasks{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-list-check me-2 text-primary"></i>My Assigned Tasks
        </h1>
        {# Optional: Link to create task if user also has creator role #}
        {% if current_user.role.name in TASK_CREATOR_ROLES %}
        <a href="{{ url_for('create_task') }}" class="btn btn-sm btn-success">
            <i class="bi bi-plus-circle-fill me-1"></i> Create New Task
        </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {# Filters - Placeholder for future enhancement (e.g., filter by status, urgency) #}
    {# <div class="card shadow-sm mb-3">
        <div class="card-body bg-light-subtle py-2 px-3">
            <small class="text-muted">Filters: (Coming soon)</small>
        </div>
    </div> #}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Tasks Requiring Your Action</h5>
        </div>
        <div class="card-body p-0">
            {% if my_tasks and my_tasks | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for user_task_item in my_tasks %} {# Renamed to avoid conflict with task variable in partial #}
                        {% with user_task=user_task_item, current_user=current_user %}
                            {% include 'partials/_task_list_item.html' %}
                        {% endwith %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-check2-circle display-3 mb-3 text-success"></i>
                    <h4 class="font-heading">No Tasks Assigned!</h4>
                    <p>You currently have no tasks assigned to you that require action.</p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if task list is very long #}
    </div>
</div>
{% endblock %}
-e 

===== templates/tasks/my_assigned_tasks_detail.html =====
{% extends "layout/base.html" %}

{% set page_title = "Assignments for: " + (task.title if task else "N/A") %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0 text-truncate" style="max-width: 70%;">
            <i class="bi bi-people-fill me-2 text-primary"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('my_assigned_tasks') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to My Created Tasks
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {# Task Summary Card #}
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Task Overview</h5>
        </div>
        <div class="card-body">
             <dl class="row mb-0">
                <dt class="col-sm-3">Title:</dt>
                <dd class="col-sm-9">{{ task.title }}</dd>

                <dt class="col-sm-3">Description:</dt>
                <dd class="col-sm-9" style="white-space: pre-wrap;">{{ task.description }}</dd>

                <dt class="col-sm-3">Urgency:</dt>
                <dd class="col-sm-9">
                     {% if task.urgency == 'Critical' %}<span class="badge bg-danger text-white rounded-pill px-2">{{ task.urgency }}</span>
                     {% elif task.urgency == 'High' %}<span class="badge bg-warning text-dark rounded-pill px-2">{{ task.urgency }}</span>
                     {% else %}<span class="badge bg-info text-white rounded-pill px-2">{{ task.urgency }}</span>
                     {% endif %}
                </dd>

                <dt class="col-sm-3">Due Date:</dt>
                <dd class="col-sm-9">
                    {% if task.due_date %}{{ task.due_date | dateformat }}
                        {% if task.due_date < now.date() %} <span class="badge bg-danger-subtle text-danger-emphasis ms-1">OVERDUE</span>{% endif %}
                    {% else %} N/A {% endif %}
                </dd>
                 <dt class="col-sm-3">Total Assignments:</dt>
                <dd class="col-sm-9">{{ user_assignments | length }}</dd>
            </dl>
        </div>
    </div>

    {# Assignments List Card #}
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 font-heading">Individual Assignments & Progress</h5>
            {# Optional: Filters for assignment status #}
        </div>
        <div class="card-body p-0">
             {% if user_assignments and user_assignments | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for assignment in user_assignments %}
                        {# Use the _user_task_assignment_item.html partial #}
                        {% include 'partials/_user_task_assignment_item.html' with {'user_assignment': assignment, 'task': task, 'current_user': current_user} %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-person-fill-x display-3 mb-3"></i>
                    <h4 class="font-heading">No Users Assigned</h4>
                    <p>This task has not been assigned to any users yet, or assignments were removed.</p>
                    {# TODO: Add button to "Add/Edit Assignees" for this task #}
                </div>
            {% endif %}
        </div>
         {# Optional: Pagination if many assignees #}
    </div>
</div>
{% endblock %}-e 

===== templates/requests/my_requests.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Submitted Requests{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-folder-check me-2 text-primary"></i>My Submitted Requests
        </h1>
        {% if permissions and permissions.can_create_request %} {# Check if user can create more #}
        <a href="{{ url_for('submit_request') }}" class="btn btn-sm btn-success">
            <i class="bi bi-plus-circle-fill me-1"></i> Submit New Request
        </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Requests You Have Submitted</h5>
            {# Optional: Filters for status, type, date range #}
        </div>
        <div class="card-body p-0">
            {% if requests and requests | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for request_obj in requests %}
                        {% include 'partials/_request_list_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-journal-richtext display-3 mb-3"></i>
                    <h4 class="font-heading">No Requests Submitted Yet</h4>
                    {% if permissions and permissions.can_create_request %}
                    <p>You haven't submitted any requests. <a href="{{ url_for('submit_request') }}">Need to request something?</a></p>
                    {% else %}
                    <p>You haven't submitted any requests.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination #}
    </div>
</div>
{% endblock %}-e 

===== templates/requests/hr_ceo_initiate.html =====
{% extends "layout/base.html" %}

{% block page_title %}Initiate Request to School Executive{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-send-plus-fill me-2 text-primary"></i>Initiate Request to School Executive (Tier 2)
        </h1>
        <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to HR Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">New Request Details (For School Executive Review)</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <p class="text-muted mb-4">
                        As HR/CEO, you are initiating this request directly to the School Executive (Tier 2) for their review and action.
                        Please provide all necessary details.
                    </p>

                    {# Reusing the CreateRequestForm structure #}
                    <form method="POST" action="{{ url_for('hr_ceo_initiate_request') }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.title.label(class="form-label fw-medium") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="Concise title for the request") }}
                            {% if form.title.errors %}<div class="invalid-feedback">{% for e in form.title.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="6", placeholder="Detailed description, justification, and any supporting information for the School Executive...") }}
                            {% if form.description.errors %}<div class="invalid-feedback">{% for e in form.description.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.request_type.label(class="form-label fw-medium") }}
                                {{ form.request_type(class="form-select" + (" is-invalid" if form.request_type.errors else "")) }}
                                {% if form.request_type.errors %}<div class="invalid-feedback">{% for e in form.request_type.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.urgency.label(class="form-label fw-medium") }}
                                {{ form.urgency(class="form-select" + (" is-invalid" if form.urgency.errors else "")) }}
                                {% if form.urgency.errors %}<div class="invalid-feedback">{% for e in form.urgency.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                        </div>

                        <div class="alert alert-info small p-2 mt-3">
                            <i class="bi bi-info-circle-fill me-1"></i>
                            This request will be directly assigned to a School Executive for Tier 2 processing.
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4 btn-lg", value="Submit to School Executive") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/requests/school_exec_initiate.html =====
{% extends "layout/base.html" %}

{% block page_title %}Initiate Request to Government{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-send-check-fill me-2 text-primary"></i>Initiate Request to Government (Tier 3)
        </h1>
        <a href="{{ url_for('school_exec_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to School Exec Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">New Request Details (For Government Review)</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <p class="text-muted mb-4">
                        As a School Executive, you are initiating this request directly to the designated Government contact (Tier 3) for their review and final approval/action.
                    </p>

                    {# Reusing the CreateRequestForm structure #}
                    <form method="POST" action="{{ url_for('school_exec_initiate_request') }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.title.label(class="form-label fw-medium") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="Concise title for the official request") }}
                            {% if form.title.errors %}<div class="invalid-feedback">{% for e in form.title.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="6", placeholder="Detailed description, justification, compliance details, and any supporting information for the Government contact...") }}
                            {% if form.description.errors %}<div class="invalid-feedback">{% for e in form.description.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.request_type.label(class="form-label fw-medium") }}
                                {{ form.request_type(class="form-select" + (" is-invalid" if form.request_type.errors else "")) }}
                                {% if form.request_type.errors %}<div class="invalid-feedback">{% for e in form.request_type.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.urgency.label(class="form-label fw-medium") }}
                                {{ form.urgency(class="form-select" + (" is-invalid" if form.urgency.errors else "")) }}
                                {% if form.urgency.errors %}<div class="invalid-feedback">{% for e in form.urgency.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                        </div>

                        <div class="alert alert-info small p-2 mt-3">
                            <i class="bi bi-info-circle-fill me-1"></i>
                            This request will be directly assigned to a Government contact for Tier 3 processing and final disposition.
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('school_exec_dashboard') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4 btn-lg", value="Submit to Government") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/requests/detail.html =====
{% extends "layout/base.html" %}

{% set page_title = "Request Details: " + (request_obj.title[:30] + '...' if request_obj.title and request_obj.title|length > 30 else request_obj.title or "N/A") %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0 text-truncate" style="max-width: 70%;">
            <i class="bi bi-file-earmark-medical-fill me-2 text-primary"></i>Request Details (ID: {{ request_obj.id }})
        </h1>
        {% if permissions.is_handler_for_request and request_obj.status not in ['Resolved', 'Denied'] %}
            <a href="{{ url_for('review_request', request_id=request_obj.id) }}" class="btn btn-sm btn-warning">
                <i class="bi bi-pencil-square me-1"></i> Review This Request
            </a>
        {% elif permissions.is_requester_of_request %}
             <a href="{{ url_for('my_requests') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to My Requests
            </a>
        {% else %} {# Admin or other viewer #}
            <a href="{{ url_for('requests_inbox') if permissions.can_review else (request.referrer or url_for('hr_ceo_dashboard')) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i> Back
            </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Left Column: Request Information #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Request Information</h5>
                </div>
                <div class="card-body">
                    <h4 class="font-heading mb-3">{{ request_obj.title }}</h4>
                    <dl class="row">
                        <dt class="col-sm-3">Request ID:</dt>
                        <dd class="col-sm-9">{{ request_obj.id }}</dd>

                        <dt class="col-sm-3">Type:</dt>
                        <dd class="col-sm-9">{{ request_obj.request_type }}</dd>

                        <dt class="col-sm-3">Urgency:</dt>
                        <dd class="col-sm-9">
                            {% if request_obj.urgency == 'Critical' %}<span class="badge fs-09rem bg-danger text-white rounded-pill px-2 py-1">{{ request_obj.urgency }}</span>
                            {% elif request_obj.urgency == 'High' %}<span class="badge fs-09rem bg-warning text-dark rounded-pill px-2 py-1">{{ request_obj.urgency }}</span>
                            {% elif request_obj.urgency == 'Medium' %}<span class="badge fs-09rem bg-info text-white rounded-pill px-2 py-1">{{ request_obj.urgency }}</span>
                            {% else %}<span class="badge fs-09rem bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ request_obj.urgency }}</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Submitted By:</dt>
                        <dd class="col-sm-9">{{ request_obj.requester.full_name or request_obj.requester.username if request_obj.requester else 'N/A' }}</dd>

                        <dt class="col-sm-3">Submitted On:</dt>
                        <dd class="col-sm-9">{{ request_obj.created_at | datetimeformat }}</dd>

                        <dt class="col-sm-3">Last Updated:</dt>
                        <dd class="col-sm-9">{{ request_obj.last_updated_at | datetimeformat }}</dd>

                        <dt class="col-sm-3">Current Status:</dt>
                        <dd class="col-sm-9">
                            {% set status_badge_class = 'bg-secondary-subtle text-secondary-emphasis' %}
                            {% if request_obj.status == 'Pending' %}{% set status_badge_class = 'bg-warning-subtle text-warning-emphasis' %}
                            {% elif request_obj.status == 'Approved' or request_obj.status == 'On Progress' %}{% set status_badge_class = 'bg-primary-subtle text-primary-emphasis' %}
                            {% elif request_obj.status == 'Resolved' %}{% set status_badge_class = 'bg-success-subtle text-success-emphasis' %}
                            {% elif request_obj.status == 'Denied' %}{% set status_badge_class = 'bg-danger-subtle text-danger-emphasis' %}{% endif %}
                            <span class="badge fs-09rem px-2 py-1 rounded-pill {{ status_badge_class }}">{{ request_obj.status }}</span>
                        </dd>

                        <dt class="col-sm-3">Current Tier:</dt>
                        <dd class="col-sm-9">Tier {{ request_obj.tier }}</dd>

                        <dt class="col-sm-3">Current Handler:</dt>
                        <dd class="col-sm-9">
                            {{ request_obj.current_handler.full_name or request_obj.current_handler.username if request_obj.current_handler else 'None (Finalized or Awaiting System)' }}
                            {% if request_obj.current_handler %}
                                <small class="text-muted">({{ request_obj.current_handler.role.name.replace('_',' ') | title if request_obj.current_handler.role }})</small>
                            {% endif %}
                        </dd>

                        {% if request_obj.last_forwarded_by %}
                        <dt class="col-sm-3">Last Forwarded By:</dt>
                        <dd class="col-sm-9">{{ request_obj.last_forwarded_by.full_name or request_obj.last_forwarded_by.username }}</dd>
                        {% endif %}
                    </dl>
                    <hr>
                    <h5 class="font-heading mt-3">Full Description:</h5>
                    <div class="p-3 bg-light-subtle border rounded" style="white-space: pre-wrap;">
                        {{ request_obj.description }}
                    </div>

                     {% if request_obj.status == 'Denied' and request_obj.denial_reason %}
                        <h5 class="font-heading mt-3 text-danger">Denial Reason:</h5>
                        <div class="p-3 bg-danger-subtle border border-danger- GGGGGGGGGGG rounded" style="white-space: pre-wrap;">
                            {{ request_obj.denial_reason }}
                        </div>
                    {% endif %}

                    {% if request_obj.status == 'Resolved' and request_obj.resolution_notes %}
                        <h5 class="font-heading mt-3 text-success">Resolution Notes:</h5>
                        <div class="p-3 bg-success-subtle border border-success- GGGGGGGGGGG rounded" style="white-space: pre-wrap;">
                            {{ request_obj.resolution_notes }}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Right Column: Request History Log #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-list-ol me-2"></i>Request History & Audit Trail</h5>
                </div>
                <div class="card-body p-0" style="max-height: 70vh; overflow-y: auto;"> {# Max height and scroll for long histories #}
                    {% if history_records and history_records | length > 0 %}
                        <ul class="list-group list-group-flush">
                            {% for history_item in history_records %}
                                {% include 'partials/_request_history_log_item.html' %}
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="p-3 text-muted text-center">
                            <i class="bi bi-archive fs-2 mb-2 d-block"></i>
                            No history recorded for this request yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/requests/review.html =====
{% extends "layout/base.html" %}

{% set page_title = "Review Request ID: " + (request_obj.id | string) %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0 text-truncate" style="max-width: 70%;">
            <i class="bi bi-card-heading me-2 text-primary"></i>{{ page_title }} - {{ request_obj.title | truncate(40) }}
        </h1>
        <a href="{{ url_for('requests_inbox') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Inbox
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-4">
        {# Left Column: Request Details Summary #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm mb-4 sticky-lg-top" style="top: 70px;"> {# Sticky summary #}
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Request Summary</h5>
                </div>
                <div class="card-body small">
                    <p><strong>Title:</strong> {{ request_obj.title }}</p>
                    <p><strong>Type:</strong> {{ request_obj.request_type }}</p>
                    <p><strong>Urgency:</strong>
                        {% if request_obj.urgency == 'Critical' %}<span class="badge bg-danger text-white rounded-pill">{{ request_obj.urgency }}</span>
                        {% elif request_obj.urgency == 'High' %}<span class="badge bg-warning text-dark rounded-pill">{{ request_obj.urgency }}</span>
                        {% else %}<span class="badge bg-info text-white rounded-pill">{{ request_obj.urgency }}</span>{% endif %}
                    </p>
                    <p><strong>Submitted By:</strong> {{ request_obj.requester.full_name or request_obj.requester.username if request_obj.requester else 'N/A' }}</p>
                    <p><strong>Submitted On:</strong> {{ request_obj.created_at | datetimeformat }}</p>
                    <p><strong>Current Status:</strong> <span class="badge fs-08rem px-2 py-1 rounded-pill {{ status_badge_class }}">{{ request_obj.status }}</span></p>
                    <p><strong>Current Tier:</strong> Tier {{ request_obj.tier }}</p>
                    <hr>
                    <h6 class="font-heading">Full Description:</h6>
                    <div class="p-2 bg-light-subtle border rounded" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                        {{ request_obj.description }}
                    </div>
                    {% if request_obj.last_forwarded_by %}
                        <p class="mt-2 text-muted"><small>Last Forwarded By: {{ request_obj.last_forwarded_by.full_name or request_obj.last_forwarded_by.username }}</small></p>
                    {% endif %}
                </div>
                 <a href="{{ url_for('view_request_detail', request_id=request_obj.id) }}" class="card-footer text-center text-decoration-none text-primary fw-medium hover-bg-light">
                    View Full Details & History <i class="bi bi-box-arrow-up-right ms-1"></i>
                </a>
            </div>
        </div>

        {# Right Column: Review Form & Actions #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-pencil-square me-2"></i>Process This Request</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('review_request', request_id=request_obj.id) }}" id="reviewRequestForm" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token for ReviewRequestForm #}

                        <div class="mb-3">
                            {{ form.status.label(text="Select Action / New Status:", class="form-label fw-medium") }}
                            {{ form.status(class="form-select form-select-lg" + (" is-invalid" if form.status.errors else ""), id="requestActionStatusSelect") }}
                            {% if form.status.errors %}<div class="invalid-feedback">{% for e in form.status.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        {# Denial Reason - Shown/Hidden by JS #}
                        <div id="denialReasonGroup" class="mb-3 assignment-section-sub" style="display:none;"> {# Using assignment-section-sub for potential shared styling #}
                            {{ form.denial_reason.label(class="form-label fw-medium") }}
                            {{ form.denial_reason(class="form-control" + (" is-invalid" if form.denial_reason.errors else ""), rows="3", placeholder="Provide a clear reason for denial...") }}
                            {% if form.denial_reason.errors %}<div class="invalid-feedback">{% for e in form.denial_reason.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        {# Forward To User - Shown/Hidden by JS #}
                        <div id="forwardToUserGroup" class="mb-3 assignment-section-sub" style="display:none;">
                            {{ form.forward_to_user_id.label(text="Forward To (Next Tier Handler):", class="form-label fw-medium") }}
                            {% if form.forward_to_user_id.choices and form.forward_to_user_id.choices|length > 1 %} {# Check if choices beyond default exist #}
                                {{ form.forward_to_user_id(class="form-select tom-select-user" + (" is-invalid" if form.forward_to_user_id.errors else "")) }}
                            {% else %}
                                <p class="text-muted"><em>No eligible users found in the next tier, or this is the final tier. Forwarding not available.</em></p>
                            {% endif %}
                            {% if form.forward_to_user_id.errors %}<div class="invalid-feedback">{% for e in form.forward_to_user_id.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.resolution_notes.label(text="Handler Notes / Comments:", class="form-label fw-medium") }}
                            {{ form.resolution_notes(class="form-control" + (" is-invalid" if form.resolution_notes.errors else ""), rows="4", placeholder="Add any comments, progress updates, or details related to your action...") }}
                            {% if form.resolution_notes.errors %}<div class="invalid-feedback">{% for e in form.resolution_notes.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="alert alert-info small p-2">
                            <i class="bi bi-info-circle-fill me-1"></i>
                            Select an action. If denying, provide a reason. If forwarding, select a user. Notes are optional but recommended.
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('requests_inbox') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4 btn-lg", value="Update Request Status") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/requests.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize dynamic form field visibility in requests.js
        // initializeReviewRequestForm() // This will be called from requests.js based on IDs

        // Initialize TomSelect for the forward_to_user_id dropdown
        const forwardUserSelect = document.getElementById('{{ form.forward_to_user_id.id }}');
        if (forwardUserSelect && typeof TomSelect !== 'undefined' && forwardUserSelect.options.length > 1) {
             new TomSelect(forwardUserSelect, {
                create: false,
                placeholder: 'Select a user to forward to...'
            });
        }
        console.log('Review Request page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/requests/submit.html =====
{% extends "layout/base.html" %}

{% block page_title %}Submit New Request{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-file-earmark-plus-fill me-2 text-primary"></i>Submit New Request
        </h1>
        <a href="{{ request.referrer or url_for('my_requests') if current_user.is_authenticated else url_for('home') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Cancel & Go Back
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">Request Details</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <p class="text-muted mb-4">
                        Please fill out the form below to submit your request. It will be routed to the appropriate department for review.
                    </p>

                    <form method="POST" action="{{ url_for('submit_request') }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.title.label(class="form-label fw-medium") }}
                            {{ form.title(class="form-control form-control-lg" + (" is-invalid" if form.title.errors else ""), placeholder="E.g., New Projector for Room 101, Repair Leaky Faucet in Staff Lounge") }}
                            {% if form.title.errors %}<div class="invalid-feedback">{% for e in form.title.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="6", placeholder="Provide a detailed description of your request, including justification, specific needs, location (if applicable), and any other relevant information.") }}
                            {% if form.description.errors %}<div class="invalid-feedback">{% for e in form.description.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.request_type.label(class="form-label fw-medium") }}
                                {{ form.request_type(class="form-select" + (" is-invalid" if form.request_type.errors else "")) }}
                                {% if form.request_type.errors %}<div class="invalid-feedback">{% for e in form.request_type.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.urgency.label(class="form-label fw-medium") }}
                                {{ form.urgency(class="form-select" + (" is-invalid" if form.urgency.errors else "")) }}
                                {% if form.urgency.errors %}<div class="invalid-feedback">{% for e in form.urgency.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ request.referrer or url_for('my_requests') if current_user.is_authenticated else url_for('home') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4 btn-lg", value="Submit Request") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/requests/inbox.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Requests Inbox{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-inbox-fill me-2 text-primary"></i>Requests Awaiting My Review
        </h1>
        {% if current_user.role.name == 'hr_ceo' %}
            <a href="{{ url_for('hr_ceo_initiate_request') }}" class="btn btn-sm btn-success">
                <i class="bi bi-send-plus-fill me-1"></i> Initiate Request (Tier 2)
            </a>
        {% elif current_user.role.name == 'school_executive' %}
            <a href="{{ url_for('school_exec_initiate_request') }}" class="btn btn-sm btn-success">
                <i class="bi bi-send-plus-fill me-1"></i> Initiate Request (Tier 3)
            </a>
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Requests Assigned to You (Tier {{ inbox_requests[0].tier if inbox_requests else 'N/A' }})</h5>
            {# Optional: Filters for urgency, request type, date received #}
        </div>
        <div class="card-body p-0">
            {% if inbox_requests and inbox_requests | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for request_obj in inbox_requests %}
                        {# Reusing _request_list_item.html - it highlights pending for current handler #}
                        {% include 'partials/_request_list_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-check2-square display-3 mb-3 text-success"></i>
                    <h4 class="font-heading">Inbox Clear!</h4>
                    <p>There are no requests currently awaiting your review.</p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if inbox list is very long #}
    </div>
</div>
{% endblock %}

<!-- SUPERIOR, DYNAMIC ACTION BUTTONS -->
<div class="flex-shrink-0 align-self-center ms-3" id="request-actions-{{ request.id }}">
    {% if request.status == 'PENDING' and request.request_type == 'JOIN_CLUB' %}
    <button class="btn btn-sm btn-success" 
            onclick="handleRequest({{ request.id }}, 'approve', this)">Approve</button>
    <button class="btn btn-sm btn-danger" 
            onclick="handleRequest({{ request.id }}, 'decline', this)">Decline</button>
    {% elif request.status != 'PENDING' %}
        <span class="badge bg-light text-dark">{{ request.status | capitalize }}</span>
    {% endif %}
</div>

{# Add this script block at the end of the template (or in a global JS file) #}
{% if loop.last %}
<script>
async function handleRequest(requestId, action, button) {
    const container = document.getElementById(`request-actions-${requestId}`);
    const csrfToken = '{{ csrf_token() }}'; // Get CSRF token from Flask

    // Provide immediate visual feedback
    container.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';

    try {
        const formData = new FormData();
        formData.append('action', action);

        const response = await fetch(`/club/request/${requestId}/handle`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData,
            redirect: 'manual' // IMPORTANT: Prevents fetch from following the redirect
        });

        // The backend flashes a message and redirects. We can simply reload to show the result.
        // A more advanced SPA-like implementation would update the DOM directly.
        if (response.type === 'opaqueredirect' || response.ok) {
             window.location.reload();
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'An unknown error occurred.');
        }
    } catch (error) {
        console.error('Request handling failed:', error);
        // Restore buttons on failure
        container.innerHTML = `<div class="alert alert-danger p-1 small">Error: ${error.message}</div>`;
    }
}
</script>
{% endif %}-e 

===== templates/talent_club/my_proposals.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Talent Club Proposals{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-file-earmark-check-fill me-2 text-primary"></i>My Submitted Proposals
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('create_talent_club_proposal') }}" class="btn btn-sm btn-success me-2">
                <i class="bi bi-plus-circle-fill me-1"></i> Submit New Proposal
            </a>
            <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Configuration
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Your Club Proposals</h5>
        </div>
        <div class="card-body p-0">
            {% if proposals and proposals | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for proposal_loop_var in proposals %} {# Changed loop variable name for clarity to avoid collision if 'proposal' is set outside #}
                        {# Set the context variables needed by the partial #}
                        {% set proposal = proposal_loop_var %}
                        {% set accepted_count = accepted_counts.get(proposal_loop_var.id, 0) %}
                        
                        {# Call include in its simplest form #}
                        {% include 'partials/_tc_proposal_item.html' %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-journal-richtext display-3 mb-3"></i>
                    <h4 class="font-heading">No Proposals Submitted Yet</h4>
                    <p>Ready to share your vision? <a href="{{ url_for('create_talent_club_proposal') }}">Propose a new Talent Club!</a></p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if proposal list can be very long #}
    </div>
</div>
{% endblock %}
-e 

===== templates/talent_club/config_my_clubs.html =====
{% extends "layout/base.html" %}
{% block title %}Club Settings{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h3 mb-4">My Club Configuration</h1>
    <div class="card shadow">
        <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Notification Preferences</h6></div>
        <div class="card-body">
            <p class="text-muted">Manage how you receive notifications for each club you're a member of.</p>
            <form method="POST">
                {{ form.hidden_tag() }}
                {% for subform in form.clubs %}
                    <div class="mb-3 p-3 border rounded">
                        <h5>{{ subform.club_name.data }}</h5>
                        {{ render_field(subform.notifications, class="form-select") }}
                    </div>
                {% endfor %}
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">Save Preferences</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/club_feed.html =====
{% extends "layout/base.html" %}

{% block page_title %}{{ club.name }} - Feed{% endblock %}

{% block content_header %}
    <div class="channel-header pt-3 pb-2 mb-3 border-bottom bg-light-subtle position-relative"> {# Reusing .channel-header styling for consistency #}
        <div class="container-fluid">
            <div class="d-flex flex-column flex-md-row align-items-md-center">
                <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="me-md-3 mb-2 mb-md-0 text-center text-md-start">
                    {% set club_avatar_view = url_for('static', filename=(club.profile_photo_url if club.profile_photo_url else 'img/placeholders/tc_club_default_avatar.png')) %}
                    <img src="{{ club_avatar_view }}" alt="{{ club.name }} Profile Photo" class="rounded-circle shadow-sm" style="width: 60px; height: 60px; object-fit: cover; border: 2px solid var(--nexus-content-bg);">
                </a>
                <div class="flex-grow-1 text-center text-md-start">
                    <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="text-decoration-none">
                        <h1 class="page-title font-heading mb-0 fs-4 text-dark">{{ club.name }} Feed</h1>
                    </a>
                    <p class="text-muted mb-1 small">
                        <i class="bi bi-award-fill me-1"></i>Level {{ club.level }}
                        <span class="mx-1 text-muted">|</span>
                        <i class="bi bi-tag-fill me-1"></i>{{ club.social_category.name if club.social_category else 'N/A' }}
                    </p>
                </div>
                <div class="mt-2 mt-md-0 ms-md-auto">
                     <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="bi bi-person-badge-fill me-1"></i> Club Profile
                    </a>
                    {% if is_club_manager %} {# is_club_manager: owner or club admin #}
                        <a href="{{ url_for('edit_talent_club_profile', club_id=club.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-pencil-square me-1"></i> Edit Club
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row g-4 justify-content-center">
        <div class="col-lg-9 col-xl-8"> {# Main feed column #}
            {% include 'layout/_flash_messages.html' %}

            {% if can_post_in_feed %}
                <div class="mb-4">
                     {# Reusing _social_content_form.html for TC feed posts #}
                    {% include 'partials/_social_content_form.html' with {
                        'post_form': post_form,
                        'submit_url': url_for('create_talent_club_feed_post', club_id=club.id), {# Ensure this route exists #}
                        'submit_button_text': 'Post to Club Feed',
                        'parent_id': club.feed.id if club.feed else club.id
                    } %}
                </div>
            {% endif %}

            <h4 class="font-heading mb-3"><i class="bi bi-newspaper me-2"></i>Club Feed Posts</h4>
            <div class="social-feed-container tc-feed-container" id="tcFeedContainer-{{ club.id }}">
                {% if posts and posts | length > 0 %}
                    {% for post in posts %}
                        {% include 'partials/_tc_feed_post_item.html' with {'club': club} %} {# Pass club for context to partial #}
                    {% endfor %}
                    {# Placeholder for "Load More" button or infinite scroll trigger #}
                    {% if pagination and pagination.has_next %}
                    <div class="text-center my-4" id="loadMoreTcPostsTrigger-{{ club.id }}">
                        <button class="btn btn-outline-primary load-more-tc-posts-btn" data-club-id="{{ club.id }}" data-current-page="{{ pagination.page }}">
                            <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span>
                            Load More Posts
                        </button>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted p-5 content-placeholder">
                        <i class="bi bi-mic-mute-fill display-3 mb-3"></i>
                        <h4 class="font-heading">This Club Feed is Empty</h4>
                        {% if can_post_in_feed %}
                        <p>Be the first to share an update, achievement, or idea!</p>
                        {% else %}
                        <p>Check back later for new posts.</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
{# Lightbox JS if used for image previews in _tc_feed_post_item.html #}
{# <script src="https://cdn.jsdelivr.net/npm/bs5-lightbox@1.8.3/dist/bs5-lightbox.bundle.min.js"></script> #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const clubId = {{ club.id | tojson }};
        const currentUserId = {{ current_user.id | tojson }};

        // Initialize TC feed interactions (posts, comments, reactions)
        if (typeof initializeTCFeed === 'function') { // This function would be in talent_club.js
            initializeTCFeed(clubId, currentUserId);
        } else {
            console.error('initializeTCFeed function not found in talent_club.js');
            // Fallback: generic social.js handlers might work for some parts if class names are similar
            // and backend responses are consistent.
        }
         console.log('Talent Club Feed page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/community_group.html =====
{% extends "layout/base.html" %}

{% block page_title %}{{ community_group.name if community_group else "Talent Club Community" }}{% endblock %}

{% block head_css %}
<style>
    .tc-community-chat-window {
        height: calc(100vh - 56px - 56px - 70px - 3rem - 70px); /* Adjust for header and input */
        min-height: 400px;
        overflow-y: auto;
        display: flex;
        flex-direction: column-reverse; /* Newest messages at the bottom */
        padding: 1rem;
        background-color: var(--nexus-body-bg);
    }
    .tc-community-input-area {
        border-top: 1px solid var(--nexus-border-color);
        background-color: var(--nexus-content-bg);
    }
    .tc-community-header {
        background-color: var(--nexus-content-bg);
        border-bottom: 1px solid var(--nexus-border-color);
    }
</style>
{% endblock %}

{% block content_header %}
    <div class="tc-community-header pt-3 pb-2 mb-0 sticky-top shadow-sm" style="top: 56px; z-index: 1010;">
        <div class="container-fluid">
            <div class="d-flex flex-column flex-md-row align-items-md-center">
                <div class="me-md-3 mb-2 mb-md-0 text-center text-md-start">
                    {# Placeholder for a TC Community Group Icon/Logo #}
                    <span class="fa-stack fa-2x d-inline-block me-md-2" style="font-size: 2.5rem;">
                        <i class="bi bi-shield-fill fs-1 text-primary"></i>
                        <i class="bi bi-stars fs-4 text-warning position-absolute" style="top: 2px; left: 1px; opacity: 0.9;"></i>
                    </span>
                </div>
                <div class="flex-grow-1 text-center text-md-start">
                    <h1 class="page-title font-heading mb-0 fs-4">{{ community_group.name if community_group else "Talent Club Community" }}</h1>
                    <p class="text-muted mb-1 small">
                        <i class="bi bi-people-fill me-1"></i> <span id="tcCommunityMemberCount">{{ community_group.members.count() if community_group else 'N/A' }}</span> Active Member{{ 's' if (community_group and community_group.members.count() != 1) else '' }}
                    </p>
                </div>
                <div class="mt-2 mt-md-0 ms-md-auto">
                    <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-gear-fill me-1"></i> TC Config
                    </a>
                    {# Optional: Link to view members if a dedicated page exists #}
                </div>
            </div>
             {% if community_group and community_group.description %}
                <p class="text-muted small mb-2 mt-2 text-center text-md-start">{{ community_group.description }}</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}
{% set no_sidebar = True %} {# Full focus on community chat #}

<div class="container-fluid px-0 h-100 d-flex flex-column">
    <div class="tc-community-chat-window flex-grow-1" id="tcCommunityChatWindowMessages-{{ community_group.id if community_group else '0' }}">
        {% if messages and messages | length > 0 %}
            {% for message_loop_var in messages %} {# Changed loop variable name #}
                {# Set the context variables needed by the partial #}
                {% set message = message_loop_var %}
                {% set current_user_id = current_user.id %} {# Explicitly set for the partial #}
                
                {# Call include in its simplest form #}
                {% include 'partials/_chat_message_item.html' %}
            {% endfor %}
        {% else %}
            <div class="text-center text-muted p-5 flex-grow-1 d-flex align-items-center justify-content-center">
                <div>
                    <i class="bi bi- megaphone-fill display-3 mb-3"></i>
                    <h4 class="font-heading">Welcome to the {{ community_group.name if community_group else "Community" }}!</h4>
                    <p>Start a discussion, share an announcement, or ask a question.</p>
                </div>
            </div>
        {% endif %}
    </div>

    <div class="tc-community-input-area p-3">
        {% if can_post_in_community %} {# Backend variable: True if user not muted in TC #}
            {# Reusing _social_content_form.html for message input UI consistency #}
            {# Set variables with names expected by _social_content_form.html #}
            {% set post_form_for_partial = post_form %} {# Use a distinct name if 'post_form' is already used, or ensure it's correctly scoped #}
            {% set submit_url = url_for('create_tc_community_message') %}
            {% set submit_button_text = 'Send Message' %}
            {% set parent_id = community_group.id if community_group else '0' %}

            {# Call include in its simplest form #}
            {% include 'partials/_social_content_form.html' %}
        {% else %}
            <div class="alert alert-warning text-center" role="alert">
                <i class="bi bi-mic-mute-fill me-1"></i> You are currently muted and cannot send messages in the TC Community.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const communityGroupId = {{ community_group.id | tojson if community_group else 'null' }};
        const currentUserId = {{ current_user.id | tojson }};

        if (communityGroupId && typeof initializeTCCommunityChat === 'function') {
            initializeTCCommunityChat(communityGroupId, currentUserId);
        } else if(communityGroupId) {
            console.warn('initializeTCCommunityChat function not found in talent_club.js. TC Community chat may not be fully dynamic.');
            // Basic form submission will still work if the form action in _social_content_form.html is correct.
            // The generic social.js post handler might pick it up if class names match and form action is correct.
        }
        console.log('TC Community Group page JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/talent_club/config_current_leader.html =====
{% extends "layout/base.html" %}

{% block page_title %}TC Leadership & Election{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-workspace me-2 text-primary"></i>Talent Club Leadership
        </h1>
        <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Configuration
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4 justify-content-center">
        {# Current Leader Information #}
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm text-center">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Current System Talent Club Leader</h5>
                </div>
                <div class="card-body p-4">
                    {% if current_leader %}
                        {% set leader_avatar = url_for('static', filename=(current_leader.profile_photo_url if current_leader.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                        <img src="{{ leader_avatar }}" alt="{{ current_leader.username }}" class="rounded-circle mb-3 shadow-sm" style="width: 100px; height: 100px; object-fit: cover; border: 3px solid var(--nexus-primary);">
                        <h4 class="font-heading mb-1">{{ current_leader.full_name or current_leader.username }}</h4>
                        <p class="text-muted mb-0">{{ current_leader.username }}</p>
                        <p class="text-muted"><small>{{ current_leader.role.name | title if current_leader.role }} | TC Leader</small></p>
                    {% else %}
                        <i class="bi bi-person-fill-slash display-3 text-muted mb-3"></i>
                        <p class="text-muted lead">No system-wide Talent Club Leader is currently assigned.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Active Election Section #}
        {% if active_election %}
        <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-success-subtle text-success-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-megaphone-fill me-2"></i>Active Election for TC Leader!</h5>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted">An election is currently underway to select the next Talent Club Leader. Initiated on {{ active_election.initiated_at | dateformat }}.</p>
                    
                    {% if can_vote and vote_form %}
                        <h6 class="font-heading mt-3">Cast Your Vote:</h6>
                        <form method="POST" action="{{ url_for('cast_tc_leader_vote') }}" id="tcLeaderVoteForm" novalidate>
                            {{ vote_form.hidden_tag() if vote_form.hidden_tag }}
                            <div class="mb-3">
                                {{ vote_form.candidate_id.label(class="form-label fw-medium") }}
                                {{ vote_form.candidate_id(class="form-select tom-select" + (" is-invalid" if vote_form.candidate_id.errors else "")) }}
                                {% if vote_form.candidate_id.errors %}<div class="invalid-feedback">{% for e in vote_form.candidate_id.errors %}{{e}}{% endfor %}</div>{% endif %}
                            </div>
                            <div class="d-grid">
                                {{ vote_form.submit(class="btn btn-success w-100", value="Submit My Vote") }}
                            </div>
                        </form>
                    {% elif user_vote %}
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="bi bi-check-circle-fill me-1"></i> You have already voted in this election for <strong>{{ user_vote.candidate.full_name or user_vote.candidate.username if user_vote.candidate else 'a candidate' }}</strong> on {{ user_vote.voted_at | dateformat }}.
                        </div>
                    {% elif not current_user.is_tc_member %}
                         <div class="alert alert-warning mt-3" role="alert">
                            <i class="bi bi-exclamation-circle-fill me-1"></i> Only Talent Club members can vote in this election.
                        </div>
                    {% else %}
                         <div class="alert alert-secondary mt-3" role="alert">
                            <i class="bi bi-info-circle-fill me-1"></i> Voting form is not available at this moment.
                        </div>
                    {% endif %}
                    <hr class="my-3">
                    <small class="text-muted d-block">The election will be concluded by HR/Administration.</small>
                </div>
            </div>
        </div>
        {% elif not current_leader %} {# No active election AND no current leader #}
         <div class="col-lg-6 col-md-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">No Active Election</h5>
                </div>
                <div class="card-body text-center text-muted p-4">
                    <i class="bi bi-person-bounding-box display-4 mb-3"></i>
                    <p>There is no active election for a new Talent Club Leader at this time. HR/Administration may initiate one when required.</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect for candidate selection if form is present
        {% if can_vote and vote_form and vote_form.candidate_id %}
        const candidateSelect = document.getElementById('{{ vote_form.candidate_id.id }}');
        if (candidateSelect) {
            new TomSelect(candidateSelect, {
                create: false,
                placeholder: 'Select your preferred candidate...'
            });
        }
        {% endif %}
        console.log('View Current TC Leader / Vote page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/my_clubs.html =====
{% extends "layout/base.html" %}

{% block title %}My Talent Clubs{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">My Talent Clubs</h1>
        <!-- A button to discover new clubs could go here -->
    </div>
    
    <!-- Club Cards Grid -->
    <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
        {# Here we reuse the _tc_club_card_item partial.
           Assume it's adapted from the group card as previously specified.
           The backend passes a list of clubs the user is a member of. #}
        {% for club in my_clubs %}
            {# Assuming _tc_club_card_item.html exists and is adapted from the group card #}
            {% include "talent_club/partials/_tc_club_card_item.html" %}
        {% else %}
        <div class="col-12">
            <div class="text-center p-5 bg-light rounded">
                <h4 class="text-muted">You haven't joined any clubs yet.</h4>
                <p>Go explore and find a club that interests you!</p>
                <a href="{{ url_for('discover_clubs') }}" class="btn btn-primary">Discover Clubs</a>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/dashboard.html =====
{% extends "layout/base.html" %}

{# ====================================================================== #}
{# MACRO DEFINITIONS (MOVED TO TOP)                                     #}
{# ====================================================================== #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links, title="Quick Actions") %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>{{ title }}</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities, title="Recent Activity in My Clubs") %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-activity me-2"></i>{{title}}</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                                {% if activity.club_name %}in <strong>{{ activity.club_name }}</strong>{% endif %}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity in your clubs to display.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endmacro %}
{# ====================================================================== #}
{# END OF MACRO DEFINITIONS                                             #}
{# ====================================================================== #}

{% block page_title %}Talent Club Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-trophy-fill me-2 text-warning"></i>My Talent Club Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-sm btn-primary me-2">
                <i class="bi bi-sliders me-1"></i> TC Configuration
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-person-gear me-1"></i> My Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {# Welcome Message & Quick Stats Row for TC Member #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-warning text-dark"> {# TC Themed Welcome #}
                <div class="card-body">
                    <h4 class="card-title font-heading">Hello, {{ current_user.full_name or current_user.username }} - Welcome to the Club!</h4>
                    <p class="mb-0">Explore your clubs, discover new talents, and engage with the TC community.</p>
                </div>
            </div>
        </div>
    </div>

{# Main Stats Cards Row - Tailored for TC Member #}
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
    {{ render_stat_card(
        card_title = "My Club Memberships",
        card_value = my_club_memberships_count | default(0),
        card_icon = "bi-person-check-fill",
        card_color_class = "text-primary",
        card_url = url_for('my_talent_clubs')
    ) }}

    {{ render_stat_card(
        card_title = "Clubs I Follow",
        card_value = my_followed_clubs_count | default(0),
        card_icon = "bi-eye-fill",
        card_color_class = "text-info",
        card_url = url_for('my_talent_clubs')
    ) }}

    {{ render_stat_card(
        card_title = "My Pending Proposals",
        card_value = my_pending_proposals_count | default(0),
        card_icon = "bi-lightbulb-fill",
        card_color_class = "text-success",
        card_url = url_for('my_talent_club_proposals')
    ) }}

    {% set unread_tc_notifications = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
    {{ render_stat_card(
        card_title = "TC Notifications",
        card_value = unread_tc_notifications,
        card_icon = "bi-bell-fill",
        card_color_class = "text-danger",
        card_url = url_for('view_notifications')
    ) }}
</div>

{# ... rest of the template ... #}

    <div class="row g-4">
        {# Left Column: My Active Clubs & Recent Activity #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-joystick me-2"></i>My Active Clubs (Joined)</h5>
                </div>
                <div class="card-body p-0">
                    {% if my_active_club_memberships and my_active_club_memberships | length > 0 %}
                        <div class="list-group list-group-flush">
                            {% for membership in my_active_club_memberships | slice(0, 5) %} {# Show first 5 #}
                                {% set club = membership.club %}
                                <a href="{{ url_for('view_talent_club_feed', club_id=club.id) }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                                    {% set club_avatar_dash = url_for('static', filename=(club.profile_photo_url if club.profile_photo_url else 'img/placeholders/tc_club_default_avatar.png')) %}
                                    <img src="{{ club_avatar_dash }}" alt="{{ club.name }}" class="rounded-circle me-3 shadow-sm" style="width: 45px; height: 45px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0 font-heading">{{ club.name }}</h6>
                                        <small class="text-muted">Role: {{ membership.role | title }} | Level: {{ club.level }}</small>
                                    </div>
                                    <i class="bi bi-arrow-right-circle-fill fs-4 text-primary opacity-75"></i>
                                </a>
                            {% endfor %}
                        </div>
                         {% if my_active_club_memberships | length > 5 %}
                            <a href="{{ url_for('my_talent_clubs') }}" class="card-footer text-center d-block text-decoration-none text-primary fw-medium hover-bg-light">
                                View All My Clubs & Follows <i class="bi bi-chevron-right"></i>
                            </a>
                        {% endif %}
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-collection-play fs-2 mb-2 d-block"></i>
                            You are not an active member of any Talent Clubs yet.
                            <a href="{{ url_for('talent_club_discover') }}" class="d-block mt-2">Discover and join clubs!</a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            {# Recent Activity in My Clubs - Uses the macro #}
            {{ render_recent_activity(recent_my_clubs_activity, title="Recent Activity in My Clubs") }}
        </div>

        {# Right Column: Quick Links & System TC Leader Info #}
        <div class="col-lg-5 col-xl-4">
            {% set tc_member_quick_links = [
                {'url': url_for('talent_club_discover'), 'text': 'Discover New Clubs', 'icon': 'bi-search-heart-fill', 'color_class': 'text-primary'},
                {'url': url_for('create_talent_club_proposal'), 'text': 'Propose a Club Idea', 'icon': 'bi-lightbulb-fill', 'color_class': 'text-success'},
                {'url': url_for('talent_club_community_group'), 'text': 'Join TC Community Chat', 'icon': 'bi-people-fill', 'color_class': 'text-info'},
                {'url': url_for('talent_club_leaderboard'), 'text': 'View Club Leaderboard', 'icon': 'bi-bar-chart-steps', 'color_class': 'text-warning'},
                {'url': url_for('my_talent_club_proposals'), 'text': 'Track My Proposals', 'icon': 'bi-file-earmark-text-fill', 'color_class': 'text-secondary'}
            ] %}
            {{ render_quick_links(tc_member_quick_links, title="Explore & Engage") }}

            {# System TC Leader Info #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-workspace me-2"></i>System TC Leader</h5>
                </div>
                <div class="card-body text-center">
                    {% if system_tc_leader %}
                        {% set leader_avatar = url_for('static', filename=(system_tc_leader.profile_photo_url if system_tc_leader.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                        <img src="{{ leader_avatar }}" alt="{{ system_tc_leader.username }}" class="rounded-circle mb-2 shadow-sm" style="width: 70px; height: 70px; object-fit: cover;">
                        <h6 class="font-heading mb-1">{{ system_tc_leader.full_name or system_tc_leader.username }}</h6>
                        <a href="{{ url_for('view_current_tc_leader')}}" class="btn btn-sm btn-outline-primary mt-1">View Election Info</a>
                    {% else %}
                        <p class="text-muted mb-0">No system leader currently assigned. An election may be pending.</p>
                         <a href="{{ url_for('view_current_tc_leader')}}" class="btn btn-sm btn-outline-info mt-2">Check Election Status</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Placeholder for any TC Member dashboard specific JS
        console.log('TC Member Dashboard JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/configuration.html =====
{% extends "layout/base.html" %}

{% block page_title %}Talent Club Configuration{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-sliders me-2 text-primary"></i>Talent Club Configuration
        </h1>
        <a href="{{ url_for('talent_club_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <p class="lead text-muted mb-4">Manage your Talent Club involvement, propose new clubs, and view system-wide TC information.</p>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {# My Club Management #}
        <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-joystick display-3 text-primary mb-3"></i>
                    <h5 class="card-title font-heading">My Club Involvement</h5>
                    <p class="card-text text-muted small">View clubs you own or are a member of. Manage content and members for clubs you administer.</p>
                    <a href="{{ url_for('my_talent_club_management') }}" class="btn btn-primary stretched-link">Go to My Clubs</a>
                </div>
            </div>
        </div>

        {# Propose New Club #}
        <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-lightbulb-fill display-3 text-success mb-3"></i>
                    <h5 class="card-title font-heading">Propose a New Club</h5>
                    <p class="card-text text-muted small">Have a great idea for a new Talent Club? Submit your proposal for review.</p>
                    <a href="{{ url_for('create_talent_club_proposal') }}" class="btn btn-success stretched-link">Submit Proposal</a>
                </div>
            </div>
        </div>

        {# My Submitted Proposals #}
        <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-file-earmark-text-fill display-3 text-info mb-3"></i>
                    <h5 class="card-title font-heading">My Proposals</h5>
                    <p class="card-text text-muted small">Track the status of your submitted club proposals and responses from mentioned members.</p>
                    <a href="{{ url_for('my_talent_club_proposals') }}" class="btn btn-info text-white stretched-link">View My Proposals</a>
                </div>
            </div>
        </div>
        
        {# Current TC Leader & Elections #}
        <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-person-check-fill display-3 text-warning mb-3"></i>
                    <h5 class="card-title font-heading">TC Leadership</h5>
                    <p class="card-text text-muted small">View the current system-wide Talent Club Leader and participate in active elections.</p>
                    <a href="{{ url_for('view_current_tc_leader') }}" class="btn btn-warning stretched-link">View Leader Info</a>
                </div>
            </div>
        </div>

        {# Talent Club Leaderboard #}
         <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-bar-chart-line-fill display-3 text-danger mb-3"></i>
                    <h5 class="card-title font-heading">Club Leaderboard</h5>
                    <p class="card-text text-muted small">See how different Talent Clubs are performing based on level and engagement.</p>
                    <a href="{{ url_for('talent_club_leaderboard') }}" class="btn btn-danger stretched-link">View Leaderboard</a>
                </div>
            </div>
        </div>

        {# TC Community Group #}
        <div class="col">
            <div class="card h-100 shadow-sm feature-card-hover">
                <div class="card-body text-center p-4">
                    <i class="bi bi-people-fill display-3 text-secondary mb-3"></i>
                    <h5 class="card-title font-heading">TC Community</h5>
                    <p class="card-text text-muted small">Connect with all Talent Club members in the official community group.</p>
                    <a href="{{ url_for('talent_club_community_group') }}" class="btn btn-secondary stretched-link">Join Community Chat</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/leader/ban_mute_member.html =====
{% extends "layout/base.html" %}

{% set action_title = "Ban/Mute: " + (user_to_manage.full_name or user_to_manage.username) %}
{% block page_title %}{{ action_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-fill-lock me-2 text-danger"></i>{{ action_title }}
        </h1>
        <a href="{{ url_for('manage_tc_members_leader') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Member Management
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            {% include 'layout/_flash_messages.html' %}

            {% if active_ban %}
            <div class="alert alert-warning" role="alert">
                <h5 class="alert-heading font-heading"><i class="bi bi-exclamation-triangle-fill me-2"></i>Active Restriction</h5>
                <p class="mb-1">This user currently has an active <strong>{{ active_ban.type | title }}</strong> in place.</p>
                <p class="mb-1"><strong>Reason:</strong> {{ active_ban.reason }}</p>
                <p class="mb-0"><strong>Expires:</strong> {{ active_ban.expires_at | datetimeformat if active_ban.expires_at else "Permanent" }}</p>
                <hr>
                <p class="mb-0">Applying a new ban/mute will end the current one.</p>
            </div>
            {% endif %}

            <div class="card shadow-sm">
                <div class="card-header bg-danger-subtle text-danger-emphasis">
                    <h5 class="mb-0 font-heading">Apply Restriction to: {{ user_to_manage.full_name or user_to_manage.username }}</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('ban_mute_tc_member', user_id=user_to_manage.id) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.ban_type.label(class="form-label fw-medium") }}
                            {{ form.ban_type(class="form-select" + (" is-invalid" if form.ban_type.errors else "")) }}
                            <small class="form-text text-muted">
                                <strong>Ban:</strong> Removes user from TC system, memberships, and community. <br>
                                <strong>Mute:</strong> Prevents user from posting in TC feeds and community group.
                            </small>
                            {% if form.ban_type.errors %}<div class="invalid-feedback">{% for e in form.ban_type.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.reason.label(class="form-label fw-medium") }}
                            {{ form.reason(class="form-control" + (" is-invalid" if form.reason.errors else ""), rows="4", placeholder="Clearly state the reason for this action...") }}
                            {% if form.reason.errors %}<div class="invalid-feedback">{% for e in form.reason.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.duration_days.label(class="form-label fw-medium") }}
                            {{ form.duration_days(class="form-control" + (" is-invalid" if form.duration_days.errors else ""), type="number", min="1", placeholder="e.g., 7, 30. Leave empty for permanent.") }}
                            {% if form.duration_days.errors %}<div class="invalid-feedback">{% for e in form.duration_days.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="alert alert-info small p-2">
                            <i class="bi bi-info-circle-fill me-1"></i>
                            Applying a 'Ban' will remove the user from all their Talent Clubs and the TC Community.
                            A 'Mute' will restrict their ability to post. Permanent actions require manual reversal.
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('manage_tc_members_leader') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-danger px-4", value="Apply Restriction") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/leader/review_proposal_detail.html =====
{% extends "layout/base.html" %}

{% set page_title = "Review Proposal: " + (proposal.name if proposal else "N/A") %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-clipboard2-data-fill me-2 text-primary"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('review_tc_proposals') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to All Pending Proposals
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <form id="reviewProposalForm" method="POST" action="{{ url_for('review_tc_proposal', proposal_id=proposal.id) }}">
        {{ csrf_token() if csrf_token else '' }} {# For WTForms if form object is used, or manual CSRF #}
        <input type="hidden" name="action" id="proposalActionInput" value="save_notes"> {# Default action #}

        <div class="row g-4">
            {# Left Column: Proposal Details & Mentioned Members #}
            <div class="col-lg-7 col-xl-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0 font-heading">Proposal Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-3">Proposed Name:</dt>
                            <dd class="col-sm-9">{{ proposal.name }}</dd>

                            <dt class="col-sm-3">Creator:</dt>
                            <dd class="col-sm-9">{{ proposal.creator.full_name or proposal.creator.username if proposal.creator else 'N/A' }}</dd>

                            <dt class="col-sm-3">Category:</dt>
                            <dd class="col-sm-9">{{ proposal.social_category.name if proposal.social_category else 'N/A' }}</dd>

                            <dt class="col-sm-3">Submitted On:</dt>
                            <dd class="col-sm-9">{{ proposal.created_at | datetimeformat }}</dd>

                            <dt class="col-sm-3">Description:</dt>
                            <dd class="col-sm-9"><p style="white-space: pre-wrap;">{{ proposal.description }}</p></dd>

                            {% if proposal.proposal_file %}
                            <dt class="col-sm-3">Attached Document:</dt>
                            <dd class="col-sm-9">
                                <a href="{{ url_for('download_social_file', file_id=proposal.proposal_file.id) }}" class="btn btn-sm btn-outline-info" download="{{ proposal.proposal_file.original_filename }}">
                                    <i class="bi bi-file-earmark-arrow-down-fill me-1"></i> {{ proposal.proposal_file.original_filename }}
                                </a>
                            </dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 font-heading"><i class="bi bi-people-fill me-2"></i>Mentioned Members ({{ mentions | length }})</h5>
                        <span class="badge {{ 'bg-success-subtle text-success-emphasis' if meets_min_members else 'bg-danger-subtle text-danger-emphasis' }} rounded-pill p-2">
                            {{ accepted_count }} / 5 Accepted Mentions
                        </span>
                    </div>
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% if mentions %}
                            {% for mention in mentions %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    {% set user_avatar = url_for('static', filename=(mention.user.profile_photo_url if mention.user.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                                    <img src="{{ user_avatar }}" alt="{{ mention.user.username }}" class="rounded-circle me-2" style="width:32px; height:32px; object-fit:cover;">
                                    <span class="fw-medium">{{ mention.user.full_name or mention.user.username }}</span>
                                    <small class="text-muted">({{ mention.user.role.name.replace('_',' ') | title if mention.user.role else 'N/A' }})</small>
                                </div>
                                {% if mention.status == 'pending' %}
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">Pending Response</span>
                                {% elif mention.status == 'accepted' %}
                                    <span class="badge bg-success-subtle text-success-emphasis rounded-pill"><i class="bi bi-check-circle-fill me-1"></i>Accepted</span>
                                {% elif mention.status == 'rejected' %}
                                    <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill"><i class="bi bi-x-circle-fill me-1"></i>Declined</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="list-group-item text-muted text-center p-3">No members were mentioned in this proposal.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# Right Column: Review Actions & Notes #}
            <div class="col-lg-5 col-xl-4">
                <div class="card shadow-sm sticky-lg-top" style="top: 70px;"> {# Sticky top for review panel #}
                    <div class="card-header bg-primary-subtle text-primary-emphasis">
                        <h5 class="mb-0 font-heading"><i class="bi bi-ui-checks-grid me-2"></i>Review & Action</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="reviewNotesTextarea" class="form-label fw-medium">Leader's Review Notes:</label>
                            <textarea class="form-control" id="reviewNotesTextarea" name="review_notes" rows="5" placeholder="Add your comments or reasons for decision here...">{{ proposal.leader_review_notes or '' }}</textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="save_notes" class="btn btn-outline-secondary proposal-action-btn">
                                <i class="bi bi-save-fill me-1"></i> Save Notes Only
                            </button>
                            <button type="submit" name="action" value="accept" class="btn btn-success proposal-action-btn" {% if not meets_min_members %}disabled title="Requires 5 accepted mentions"{% endif %}>
                                <i class="bi bi-check-circle-fill me-1"></i> Accept Proposal & Create Club
                            </button>
                            <button type="submit" name="action" value="reject" class="btn btn-danger proposal-action-btn">
                                <i class="bi bi-x-octagon-fill me-1"></i> Reject Proposal
                            </button>
                        </div>
                        {% if not meets_min_members %}
                        <small class="text-danger d-block mt-2 text-center">
                            Acceptance is disabled until at least 5 members accept their mention.
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // JavaScript to set the hidden 'action' input based on which button is clicked.
        // Or, backend can check request.form for 'accept', 'reject', 'save_notes'.
        // The current HTML uses name="action" on buttons, so backend can check request.form.get('action').
        
        // Optional: AJAX submission for review actions (more complex)
        // const reviewForm = document.getElementById('reviewProposalForm');
        // if(reviewForm) {
        //     reviewForm.querySelectorAll('.proposal-action-btn').forEach(button => {
        //         button.addEventListener('click', function(e) {
        //             document.getElementById('proposalActionInput').value = this.value;
        //             // If not using AJAX, form will submit normally.
        //             // If using AJAX:
        //             // e.preventDefault();
        //             // handleTCProposalReviewAction(reviewForm, this.value); // Function in talent_club.js
        //         });
        //     });
        // }
        console.log('Review TC Proposal Detail JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/leader/review_proposals.html =====
{% extends "layout/base.html" %}

{% block page_title %}Review Club Proposals{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-journal-check me-2 text-primary"></i>Review Talent Club Proposals
        </h1>
        <a href="{{ url_for('talent_club_dashboard') }}" class="btn btn-sm btn-outline-secondary"> {# Or TC Leader specific dashboard #}
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Proposals Awaiting Your Review</h5>
        </div>
        <div class="card-body p-0">
            {% if pending_proposals and pending_proposals | length > 0 %}
                <div class="list-group list-group-flush">
                    {% for proposal in pending_proposals %}
                        {# Reusing _tc_proposal_item.html with context for TC Leader #}
                        {% include 'partials/_tc_proposal_item.html' with {'proposal': proposal, 'current_user': current_user, 'accepted_count': accepted_counts.get(proposal.id, 0) } %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-clipboard-check-fill display-3 mb-3 text-success"></i>
                    <h4 class="font-heading">All Caught Up!</h4>
                    <p>There are no new club proposals currently awaiting your review.</p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if list is long #}
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/leader/member_management.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage TC Members (Leader Admin){% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-fill-slash me-2 text-primary"></i>Manage Talent Club Members
        </h1>
        <a href="{{ url_for('talent_club_dashboard') }}" class="btn btn-sm btn-outline-secondary"> {# Or TC Leader specific dashboard #}
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">All Active Talent Club Members</h5>
            {# Optional: Filters for grade, section, or specific clubs #}
        </div>
        <div class="card-body p-0">
            {% if tc_members and tc_members | length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle tc-member-management-table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 5%;">Avatar</th>
                                <th scope="col">Name</th>
                                <th scope="col">Username</th>
                                <th scope="col">Grade/Section</th>
                                <th scope="col">Clubs Joined</th>
                                <th scope="col" class="text-center">System Status</th>
                                <th scope="col" class="text-center" style="min-width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in tc_members %}
                            <tr id="tc-member-row-{{ member.id }}">
                                <td>
                                    {% set member_avatar = url_for('static', filename=(member.profile_photo_url if member.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                                    <img src="{{ member_avatar }}" alt="{{ member.username }}" class="rounded-circle" style="width: 35px; height: 35px; object-fit: cover;">
                                </td>
                                <td class="fw-medium">{{ member.full_name or member.username }}</td>
                                <td><small class="text-muted">{{ member.username }}</small></td>
                                <td><small>{{ member.grade or 'N/A' }}-{{ member.section or 'N/A' }}</small></td>
                                <td>
                                    <small>{{ member.tc_memberships.count() }} Club{{ 's' if member.tc_memberships.count() != 1 else '' }}</small>
                                    {# Could list first few clubs or link to a detail view #}
                                </td>
                                <td class="text-center">
                                    {% set ban = member_ban_status.get(member.id) %}
                                    {% if ban %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis p-2 fs-08rem">
                                            <i class="bi {{ 'bi-mic-mute-fill' if ban.type == 'mute' else 'bi-person-fill-x' }} me-1"></i>
                                            {{ ban.type | title }}ned
                                            {% if ban.expires_at %}
                                                (til {{ ban.expires_at | dateformat }})
                                            {% else %}
                                                (Permanent)
                                            {% endif %}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success-subtle text-success-emphasis p-2 fs-08rem">
                                            <i class="bi bi-check-circle-fill me-1"></i>Active
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if member.id != current_user.id %} {# TC Leader cannot ban/mute self #}
                                        {% if ban %}
                                            <form action="{{ url_for('unban_unmute_tc_member', user_id=member.id) }}" method="POST" class="d-inline">
                                                {{ csrf_token() if csrf_token else '' }}
                                                <button type="submit" class="btn btn-sm btn-outline-success p-1" title="Remove {{ ban.type | title }}">
                                                    <i class="bi {{ 'bi-mic-fill' if ban.type == 'mute' else 'bi-person-fill-check' }} fs-6"></i> Un-{{ ban.type }}
                                                </button>
                                            </form>
                                        {% else %}
                                            <a href="{{ url_for('ban_mute_tc_member', user_id=member.id) }}" class="btn btn-sm btn-outline-danger p-1" title="Ban or Mute Member">
                                                <i class="bi bi-slash-circle-fill fs-6"></i> Ban/Mute
                                            </a>
                                        {% endif %}
                                    {% else %}
                                         <small class="text-muted fst-italic">Your Account</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-person-video3 display-3 mb-3"></i>
                    <h4 class="font-heading">No Active Talent Club Members Found</h4>
                    <p>Students can opt-in to become Talent Club members from their dashboard.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/leader/club_management.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage Talent Clubs (Leader Admin){% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-kanban-fill me-2 text-primary"></i>Manage All Talent Clubs
        </h1>
        <a href="{{ url_for('talent_club_dashboard') }}" class="btn btn-sm btn-outline-secondary"> {# Or TC Leader specific dashboard #}
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">Talent Club Instances Overview</h5>
            {# Optional: Add filters for active/inactive, category, level #}
        </div>
        <div class="card-body p-0">
            {% if all_clubs and all_clubs | length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle tc-club-management-table">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" style="width: 5%;">ID</th>
                                <th scope="col">Club Name</th>
                                <th scope="col">Category</th>
                                <th scope="col">Owner</th>
                                <th scope="col" class="text-center">Level</th>
                                <th scope="col" class="text-center">Warnings</th>
                                <th scope="col" class="text-center">Members</th>
                                <th scope="col" class="text-center">Status</th>
                                <th scope="col" class="text-center" style="min-width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for club in all_clubs %}
                            <tr id="club-row-{{ club.id }}" class="{{ 'table-secondary opacity-75' if not club.is_active }}">
                                <td>{{ club.id }}</td>
                                <td class="fw-medium">
                                    <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="text-decoration-none">{{ club.name | truncate(30) }}</a>
                                    {% if not club.is_active %}<span class="badge bg-dark-subtle text-dark-emphasis ms-1 small">Inactive</span>{% endif %}
                                </td>
                                <td><small>{{ club.social_category.name if club.social_category else 'N/A' }}</small></td>
                                <td><small>{{ club.owner.full_name or club.owner.username if club.owner else 'N/A' }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-info-subtle text-info-emphasis p-2 fs-09rem">{{ club.level }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge {{ 'bg-danger-subtle text-danger-emphasis' if club.warning_count >= 2 else ('bg-warning-subtle text-warning-emphasis' if club.warning_count > 0 else 'bg-success-subtle text-success-emphasis') }} p-2 fs-09rem">
                                        {{ club.warning_count }}
                                    </span>
                                </td>
                                <td class="text-center">{{ club_counts.get(club.id, {}).get('members', 0) }}</td>
                                <td class="text-center">
                                    {% if club.is_active %}
                                        <span class="badge bg-success-subtle text-success-emphasis p-2">Active</span>
                                    {% else %}
                                        <span class="badge bg-danger-subtle text-danger-emphasis p-2">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary p-1 me-1 tc-set-level-btn" title="Set Level"
                                            data-bs-toggle="modal" data-bs-target="#setLevelModal"
                                            data-club-id="{{ club.id }}" data-club-name="{{ club.name }}" data-current-level="{{ club.level }}"
                                            {% if not club.is_active %}disabled{% endif %}>
                                        <i class="bi bi-award-fill fs-6"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning p-1 me-1 tc-warn-club-btn" title="Issue Warning"
                                            data-bs-toggle="modal" data-bs-target="#warnClubModal"
                                            data-club-id="{{ club.id }}" data-club-name="{{ club.name }}"
                                            {% if not club.is_active %}disabled{% endif %}>
                                        <i class="bi bi-exclamation-triangle-fill fs-6"></i>
                                    </button>
                                    {# Deactivate/Reactivate button - a more complex action than simple delete #}
                                    {# <button class="btn btn-sm btn-outline-danger p-1 tc-toggle-active-btn" title="{{ 'Deactivate' if club.is_active else 'Activate' }} Club">
                                        <i class="bi {{ 'bi-toggle-off' if club.is_active else 'bi-toggle-on' }} fs-6"></i>
                                    </button> #}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted p-5 content-placeholder">
                    <i class="bi bi-collection-play-fill display-3 mb-3"></i>
                    <h4 class="font-heading">No Talent Clubs Found</h4>
                    <p>There are no Talent Clubs currently in the system. Proposals might be pending your review.</p>
                    <a href="{{ url_for('review_tc_proposals') }}" class="btn btn-info text-white mt-2">Review Pending Proposals</a>
                </div>
            {% endif %}
        </div>
    </div>

    {# Modal for Setting Club Level #}
    <div class="modal fade" id="setLevelModal" tabindex="-1" aria-labelledby="setLevelModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="setLevelForm" method="POST" action=""> {# Action set by JS #}
                    {{ csrf_token() if csrf_token else '' }}
                    <div class="modal-header bg-primary-subtle text-primary-emphasis">
                        <h5 class="modal-title font-heading" id="setLevelModalLabel"><i class="bi bi-award-fill me-2"></i>Set Level for <span id="setLevelClubName">Club</span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="club_id" id="setLevelClubIdInput">
                        <div class="mb-3">
                            <label for="newClubLevelInput" class="form-label fw-medium">New Level (Current: <span id="currentClubLevelDisplay"></span>):</label>
                            {# Assuming TalentClubLevelForm has a 'level' field #}
                            {{ set_level_form.level(class="form-control" + (" is-invalid" if set_level_form.level.errors else ""), id="newClubLevelInput", type="number", min="1", step="1") }}
                            {% if set_level_form.level.errors %}<div class="invalid-feedback">{% for e in set_level_form.level.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        {{ set_level_form.submit(class="btn btn-primary", value="Set Level") }}
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# Modal for Issuing Warning #}
    <div class="modal fade" id="warnClubModal" tabindex="-1" aria-labelledby="warnClubModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                 <form id="warnClubForm" method="POST" action=""> {# Action set by JS #}
                    {{ csrf_token() if csrf_token else '' }}
                    <div class="modal-header bg-warning-subtle text-warning-emphasis">
                        <h5 class="modal-title font-heading" id="warnClubModalLabel"><i class="bi bi-exclamation-triangle-fill me-2"></i>Issue Warning to <span id="warnClubName">Club</span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="club_id" id="warnClubIdInput">
                        <div class="mb-0">
                            <label for="warningReasonTextarea" class="form-label fw-medium">Reason for Warning:</label>
                            {# Assuming TalentClubWarningForm has a 'reason' field #}
                            {{ warning_form.reason(class="form-control" + (" is-invalid" if warning_form.reason.errors else ""), id="warningReasonTextarea", rows="4", placeholder="Clearly state the reason for this warning...") }}
                            {% if warning_form.reason.errors %}<div class="invalid-feedback">{% for e in warning_form.reason.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        {{ warning_form.submit(class="btn btn-warning", value="Issue Warning") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Modal for Set Level
        const setLevelModal = document.getElementById('setLevelModal');
        if (setLevelModal) {
            setLevelModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const clubId = button.dataset.clubId;
                const clubName = button.dataset.clubName;
                const currentLevel = button.dataset.currentLevel;

                setLevelModal.querySelector('#setLevelClubName').textContent = clubName;
                setLevelModal.querySelector('#currentClubLevelDisplay').textContent = currentLevel;
                setLevelModal.querySelector('#setLevelClubIdInput').value = clubId;
                setLevelModal.querySelector('#newClubLevelInput').value = currentLevel; // Pre-fill with current
                setLevelModal.querySelector('#setLevelForm').action = `/talent_club/leader/club/${clubId}/set_level`;
            });
        }

        // Modal for Warn Club
        const warnClubModal = document.getElementById('warnClubModal');
        if (warnClubModal) {
            warnClubModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const clubId = button.dataset.clubId;
                const clubName = button.dataset.clubName;

                warnClubModal.querySelector('#warnClubName').textContent = clubName;
                warnClubModal.querySelector('#warnClubIdInput').value = clubId;
                warnClubModal.querySelector('#warnClubForm').action = `/talent_club/leader/club/${clubId}/warn`;
                warnClubModal.querySelector('#warningReasonTextarea').value = ''; // Clear previous reason
            });
        }
        console.log('TC Leader Club Management JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/leaderboard.html =====
{% extends "layout/base.html" %}
{% block title %}Talent Club Leaderboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="text-center mb-5">
        <i class="bi bi-trophy-fill text-warning" style="font-size: 3.5rem;"></i>
        <h1 class="h2 mt-2">Talent Club Leaderboard</h1>
        <p class="lead text-muted">See which clubs are leading the way in points and achievements.</p>
    </div>
    <div class="card shadow">
        <div class="card-body">
            <table class="table table-hover table-borderless">
                <thead class="table-light">
                    <tr>
                        <th style="width: 10%;">Rank</th>
                        <th style="width: 60%;">Club Name</th>
                        <th style="width: 30%;" class="text-end">Points</th>
                    </tr>
                </thead>
                <tbody>
                {% for entry in leaderboard_data %}
                    <tr class="align-middle">
                        <td><span class="fs-4 fw-bold text-primary">#{{ loop.index }}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="{{ entry.club.avatar_url or url_for('static', filename='img/placeholders/tc_club_default_avatar.png') }}" class="rounded-circle me-3" width="40" height="40">
                                <a href="{{ url_for('club_profile', club_id=entry.club.id) }}" class="fw-bold text-dark text-decoration-none">{{ entry.club.name }}</a>
                            </div>
                        </td>
                        <td class="text-end fs-5 fw-bold text-muted">{{ entry.points }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="3" class="text-center p-4">Leaderboard data is not yet available.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/club_profile.html =====
{% extends "layout/base.html" %}

{% block title %}{{ club.name }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4" 
     x-data="{ activeTab: 'feed' }"> {# ALPINE.JS COMPONENT INITIALIZATION #}

    <!-- Club Header -->
    <div class="card shadow-sm mb-4">
        <div class="card-header p-0" style="height: 200px; background: url({{ club.banner_url or url_for('static', filename='img/placeholders/asset_default.png') }}) center center / cover;"></div>
        <div class="card-body">
            <div class="d-flex align-items-end" style="margin-top: -50px;">
                <img src="{{ club.avatar_url or url_for('static', filename='img/placeholders/tc_club_default_avatar.png') }}" alt="{{ club.name }} avatar" class="rounded-circle border border-3 border-white me-3" width="100" height="100">
                <div>
                    <h1 class="h3 mb-0">{{ club.name }}</h1>
                    <p class="text-muted mb-0">{{ club.description }}</p>
                </div>
                <div class="ms-auto">
                    <a href="{{ url_for('club_leader_dashboard', club_id=club.id) }}" class="btn btn-outline-secondary btn-sm"><i class="bi bi-gear-fill"></i> Manage</a>
                    <a href="#" class="btn btn-primary btn-sm"><i class="bi bi-person-plus-fill"></i> Join Club</a>
                </div>
            </div>
        </div>
        <!-- DYNAMIC Navigation Tabs (Powered by Alpine.js) -->
        <ul class="nav nav-tabs nav-tabs-bottom px-3">
            <li class="nav-item">
                <a class="nav-link" :class="{ 'active': activeTab === 'feed' }" @click.prevent="activeTab = 'feed'" href="#">Feed</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" :class="{ 'active': activeTab === 'members' }" @click.prevent="activeTab = 'members'" href="#">Members</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" :class="{ 'active': activeTab === 'proposals' }" @click.prevent="activeTab = 'proposals'" href="#">Proposals</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" :class="{ 'active': activeTab === 'tasks' }" @click.prevent="activeTab = 'tasks'" href="#">Tasks</a>
            </li>
        </ul>
    </div>

    <!-- DYNAMIC Tab Content (Controlled by Alpine.js) -->
    <div>
        <!-- Feed Tab -->
        <div x-show="activeTab === 'feed'" x-transition>
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    {% set post_form = get_post_form() %}
                    {% include "social/partials/_social_content_form.html" with {
                        'form': post_form,
                        'submit_url': url_for('create_club_post', club_id=club.id),
                        'placeholder_text': 'Share an update with the club...',
                        'submit_button_text': 'Post'
                    } %}
                    <hr>
                    {% for post in club_posts %}
                        {% include "talent_club/partials/_tc_feed_post_item.html" %}
                    {% else %}
                        <p class="text-center text-muted">No posts in this club yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Members Tab -->
        <div x-show="activeTab === 'members'" x-transition.opacity>
            <div class="card">
                <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Club Members</h6></div>
                <div class="list-group list-group-flush">
                    {% for member in club.memberships %}
                        {% include "talent_club/partials/_tc_member_list_item.html" %}
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Proposals Tab -->
        <div x-show="activeTab === 'proposals'" x-transition.opacity>
            <div class="card">
                <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Project Proposals</h6></div>
                <div class="card-body">
                    {% for proposal in club.proposals %}
                        {% include "talent_club/partials/_tc_proposal_item.html" %}
                    {% else %}
                        <p class="text-center text-muted">No proposals have been made yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Tasks Tab -->
        <div x-show="activeTab === 'tasks'" x-transition.opacity>
            <div class="card">
                <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Active Tasks</h6></div>
                <div class="card-body">
                    <p class="text-center text-muted">Task management interface coming soon.</p>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    /* Add a subtle transition for tab content */
    [x-show] { display: none; }
    [x-show][x-transition] { transition: opacity 0.3s ease; }
</style>
{% endblock %}-e 

===== templates/talent_club/partials/_tc_club_card_item.html =====
-e 

===== templates/talent_club/partials/_tc_member_list_item.html =====
{#
    Renders a single member in a list view.
    Required context:
    - member: The club membership object, which links a user and their role.
#}
<div class="list-group-item d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <img src="{{ member.user.profile.avatar_url or url_for('static', filename='img/placeholders/avatar_default.svg') }}" 
             alt="{{ member.user.first_name }}'s avatar" class="rounded-circle me-3" width="40" height="40">
        <div>
            <a href="{{ url_for('user_profile', user_id=member.user.id) }}" class="fw-bold text-dark text-decoration-none">{{ member.user.first_name }} {{ member.user.last_name }}</a>
            <div class="small text-muted">Joined: {{ member.join_date.strftime('%b %Y') }}</div>
        </div>
    </div>
    <div>
        {% set role_colors = {'Leader': 'primary', 'Co-Leader': 'info', 'Member': 'secondary'} %}
        <span class="badge bg-{{ role_colors.get(member.role, 'secondary') }}">{{ member.role }}</span>
    </div>
</div>
    Renders a single member in a list view.
    Required context:
    - member: The club membership object, which links a user and their role.
#}
<div class="list-group-item d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center">
        <img src="{{ member.user.profile.avatar_url or url_for('static', filename='img/placeholders/avatar_default.svg') }}" 
             alt="{{ member.user.first_name }}'s avatar" class="rounded-circle me-3" width="40" height="40">
        <div>
            <a href="{{ url_for('user_profile', user_id=member.user.id) }}" class="fw-bold text-dark text-decoration-none">{{ member.user.first_name }} {{ member.user.last_name }}</a>
            <div class="small text-muted">Joined: {{ member.join_date.strftime('%b %Y') }}</div>
        </div>
    </div>
    <div>
        {% set role_colors = {'Leader': 'primary', 'Co-Leader': 'info', 'Member': 'secondary'} %}
        <span class="badge bg-{{ role_colors.get(member.role, 'secondary') }}">{{ member.role }}</span>
    </div>
</div>>-e 

===== templates/talent_club/partials/_tc_proposal_item.html =====
{# 
    Renders a single proposal card.
    Required context:
    - proposal: The proposal object.
#}
<div class="card tc-proposal-item mb-3" id="proposal-{{ proposal.id }}">
    <div class="card-body">
        <div class="d-flex justify-content-between">
            <h5 class="card-title">{{ proposal.title }}</h5>
            {% set status_meta = {
                'Pending': {'color': 'warning', 'icon': 'hourglass-split'},
                'Approved': {'color': 'success', 'icon': 'check-circle-fill'},
                'Rejected': {'color': 'danger', 'icon': 'x-circle-fill'}
            } %}
            <span class="badge fs-6 bg-{{ status_meta[proposal.status].color }}-subtle text-{{ status_meta[proposal.status].color }}-emphasis">
                <i class="bi bi-{{ status_meta[proposal.status].icon }} me-1"></i>
                {{ proposal.status }}
            </span>
        </div>
        <h6 class="card-subtitle mb-2 text-muted small">
            Proposed by {{ proposal.proposer.first_name }} on {{ proposal.timestamp.strftime('%Y-%m-%d') }}
        </h6>
        <p class="card-text">{{ proposal.description | truncate(200) }}</p>
        
        <!-- Voting/Actions Area -->
        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
            <div>
                <span class="text-success me-3"><i class="bi bi-hand-thumbs-up-fill"></i> {{ proposal.votes_for }}</span>
                <span class="text-danger"><i class="bi bi-hand-thumbs-down-fill"></i> {{ proposal.votes_against }}</span>
            </div>
            <div>
                {% if proposal.status == 'Pending' %}
                <a href="#" class="btn btn-sm btn-outline-success">Vote For</a>
                <a href="#" class="btn btn-sm btn-outline-danger">Vote Against</a>
                {% endif %}
                <a href="#" class="btn btn-sm btn-outline-secondary">Details</a>
            </div>
        </div>
    </div>
</div>-e 

===== templates/talent_club/partials/_tc_feed_post_item.html =====
{# 
    Renders a specialized post for a Talent Club feed.
    Extends the concept of a social post with club-specific context.
    Required context:
    - post: The post object, which may have a linked_proposal or linked_event.
#}
<div class="card tc-post-item mb-3 shadow-sm">
    <div class="card-body">
        <!-- Post Header -->
        <div class="d-flex align-items-center mb-3">
            <img src="{{ post.author.profile.avatar_url or url_for('static', filename='img/placeholders/avatar_default.svg') }}" 
                 alt="{{ post.author.first_name }}'s avatar" class="rounded-circle me-3" width="48" height="48">
            <div class="flex-grow-1">
                <a href="{{ url_for('user_profile', user_id=post.author.id) }}" class="fw-bold text-dark text-decoration-none">{{ post.author.first_name }} {{ post.author.last_name }}</a>
                <div class="text-muted small">{{ post.timestamp | humanize_time }}</div>
            </div>
            {% if post.author == current_user %}
            <div class="dropdown">
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="#">Delete Post</a></li>
                </ul>
            </div>
            {% endif %}
        </div>
        <!-- Post Content -->
        <div class="post-content mb-3">
            {{ post.content | nl2br | safe }}
        </div>
        <!-- Contextual Link (e.g., to a proposal) -->
        {% if post.linked_proposal %}
        <div class="alert alert-light border p-2">
            <i class="bi bi-lightbulb-fill me-2 text-primary"></i>
            This post is related to the proposal: 
            <a href="#proposal-{{ post.linked_proposal.id }}" class="fw-bold">{{ post.linked_proposal.title }}</a>
        </div>
        {% endif %}
        <!-- Post Actions -->
        <div class="post-actions d-flex justify-content-start align-items-center gap-3 border-top pt-2">
            <a href="#" class="btn btn-light btn-sm"><i class="bi bi-hand-thumbs-up"></i> Like</a>
            <a href="#" class="btn btn-light btn-sm"><i class="bi bi-chat-dots"></i> Comment</a>
        </div>
    </div>
    <!-- Comments are loaded dynamically or included as in the social post item -->
</div>-e 

===== templates/talent_club/invite_response.html =====
{% extends "layout/base.html" %}

{% block page_title %}Club Proposal Invitation{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-envelope-paper-heart-fill me-2 text-primary"></i>Club Proposal Invitation
        </h1>
        <a href="{{ url_for('view_notifications') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Notifications
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            {% include 'layout/_flash_messages.html' %}

            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">Invitation to Join: {{ proposal.name }}</h5>
                </div>
                <div class="card-body p-4">
                    <p class="lead">
                        You have been mentioned by <strong>{{ proposal.creator.full_name or proposal.creator.username }}</strong>
                        in a proposal for a new Talent Club: <strong>"{{ proposal.name }}"</strong>.
                    </p>
                    <hr>
                    <h6 class="font-heading">Proposal Details:</h6>
                    <p><strong>Category:</strong> {{ proposal.social_category.name if proposal.social_category else 'N/A' }}</p>
                    <p><strong>Description:</strong></p>
                    <blockquote class="blockquote bg-light-subtle p-3 rounded">
                        <p class="mb-0 small">{{ proposal.description | nl2br | safe }}</p>
                    </blockquote>

                    {% if proposal.proposal_file %}
                        <p class="mt-3">
                            <a href="{{ url_for('download_social_file', file_id=proposal.proposal_file.id) }}" class="btn btn-outline-info btn-sm" download="{{ proposal.proposal_file.original_filename }}">
                                <i class="bi bi-file-earmark-arrow-down-fill me-1"></i> Download Proposal Document
                            </a>
                            <small class="text-muted ms-2">({{ (proposal.proposal_file.size / 1024) | round(1) }} KB)</small>
                        </p>
                    {% endif %}

                    <hr class="my-4">

                    {% if mention.status == 'pending' and proposal.status == 'pending_leader_review' %}
                        <h5 class="font-heading text-center">Do you want to be part of this proposed club?</h5>
                        <p class="text-muted text-center small">Your response is needed for the proposal to proceed.</p>
                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-3">
                            <form method="POST" action="{{ url_for('respond_tc_proposal_mention', mention_id=mention.id, response='accept') }}" class="d-inline">
                                {{ csrf_token() if csrf_token else '' }}
                                <button type="submit" class="btn btn-success btn-lg px-4">
                                    <i class="bi bi-check-circle-fill me-2"></i>Yes, I'm In!
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('respond_tc_proposal_mention', mention_id=mention.id, response='decline') }}" class="d-inline">
                                 {{ csrf_token() if csrf_token else '' }}
                                <button type="submit" class="btn btn-outline-danger btn-lg px-4">
                                    <i class="bi bi-x-circle-fill me-2"></i>No, Decline
                                </button>
                            </form>
                        </div>
                    {% elif mention.status != 'pending' %}
                        <div class="alert alert-{{ 'success' if mention.status == 'accepted' else ('danger' if mention.status == 'rejected' else 'info') }} text-center" role="alert">
                            <h5 class="alert-heading font-heading">You have already responded!</h5>
                            <p>You <strong>{{ mention.status | title }}</strong> this invitation on {{ mention.responded_at | dateformat }}.</p>
                             {% if proposal.status != 'pending_leader_review' %}
                                <hr>
                                <p class="mb-0 small">The overall proposal status is: <strong>{{ proposal.status.replace('_', ' ') | title }}</strong>. No further action is needed from you on this invite.</p>
                            {% endif %}
                        </div>
                    {% elif proposal.status != 'pending_leader_review' %}
                         <div class="alert alert-warning text-center" role="alert">
                            <h5 class="alert-heading font-heading">Proposal Review Status Changed</h5>
                            <p>This proposal is no longer in the 'Pending Leader Review' stage (Current status: <strong>{{ proposal.status.replace('_', ' ') | title }}</strong>).</p>
                            <p class="mb-0 small">You can no longer respond to this specific invitation.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/talent_club/discover.html =====
{% extends "layout/base.html" %}

{% block page_title %}Discover Talent Clubs{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-compass-fill me-2 text-primary"></i>Discover Talent Clubs
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('my_talent_clubs') }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="bi bi-view-list me-1"></i> My Clubs & Follows
            </a>
            <a href="{{ url_for('create_talent_club_proposal') }}" class="btn btn-sm btn-success">
                <i class="bi bi-lightbulb-fill me-1"></i> Propose New Club
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm mb-4">
        <div class="card-body bg-light-subtle p-3">
            <form method="GET" action="{{ url_for('talent_club_discover') }}" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="tcSearchInput" class="form-label fw-medium text-muted small">Search Clubs:</label>
                    <input type="text" name="search_query" id="tcSearchInput" class="form-control form-control-sm" value="{{ search_query or '' }}" placeholder="Search by name or description...">
                </div>
                <div class="col-md-5">
                    <label for="tcCategoryFilter" class="form-label fw-medium text-muted small">Filter by Category:</label>
                    <select name="category_id" id="tcCategoryFilter" class="form-select form-select-sm tom-select-filter">
                        <option value="" {% if not selected_category_id %}selected{% endif %}>All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}" {% if selected_category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm w-100"><i class="bi bi-search me-1"></i>Filter</button>
                </div>
            </form>
        </div>
    </div>

    {% if all_clubs and all_clubs | length > 0 %}
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4" id="discoverTcClubsContainer">
            {% for club_loop_var in all_clubs %} 
                 {% set is_member = club_statuses.get(club_loop_var.id, {}).get('is_member', False) %}
                 {% set is_following = club_statuses.get(club_loop_var.id, {}).get('is_following', False) %}
                 {% with
                    club=club_loop_var, 
                    current_user=current_user,
                    is_member_of_club=is_member,
                    is_following_club=is_following
                 %}
                    {% include 'partials/_tc_club_card_item.html' %}
                 {% endwith %}
            {% endfor %}
        </div>
        
        {% if pagination %}
            <nav aria-label="Talent Club discovery pagination" class="mt-5 d-flex justify-content-center">
                <ul class="pagination shadow-sm">
                    <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                        <a class="page-link" href="{{ url_for('talent_club_discover', page=pagination.prev_num, search_query=search_query, category_id=selected_category_id) if pagination.has_prev else '#' }}" aria-label="Previous">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {{ 'active' if page_num == pagination.page else '' }}" {% if page_num == pagination.page %}aria-current="page"{% endif %}>
                                <a class="page-link" href="{{ url_for('talent_club_discover', page=page_num, search_query=search_query, category_id=selected_category_id) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                    {% endfor %}
                    <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                        <a class="page-link" href="{{ url_for('talent_club_discover', page=pagination.next_num, search_query=search_query, category_id=selected_category_id) if pagination.has_next else '#' }}" aria-label="Next">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                </ul>
            </nav>
        {% endif %}
    {% else %}
        <div class="text-center text-muted p-5 content-placeholder">
            <i class="bi bi-binoculars display-3 mb-3" aria-hidden="true"></i>
            <h4 class="font-heading">No Talent Clubs Found</h4>
            <p>No active Talent Clubs match your current search or filter criteria. <a href="{{ url_for('talent_club_discover', search_query='', category_id='') }}">Clear filters</a> or perhaps <a href="{{ url_for('create_talent_club_proposal') }}">propose a new one</a>?</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const categoryFilterSelect = document.getElementById('tcCategoryFilter');
        if (categoryFilterSelect) {
            new TomSelect(categoryFilterSelect, {
                create: false,
                placeholder: 'Select a category...'
            });
        }
        console.log('Discover Talent Clubs page JS initialized with TomSelect.');
    });
</script>
{% endblock %}-e 

===== templates/talent_club/config_new_proposal.html =====
{% extends "layout/base.html" %}

{% block page_title %}Propose New Talent Club{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-lightbulb-fill me-2 text-primary"></i>Propose a New Talent Club
        </h1>
        <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to TC Configuration
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">New Club Proposal Form</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <p class="text-muted mb-4">
                        Excited about a new club idea? Fill out the details below. Your proposal will be reviewed by the Talent Club Leader.
                        You need at least <strong>5 other active TC members</strong> to accept their mention in your proposal before the TC Leader can approve it.
                    </p>

                    <form method="POST" action="{{ url_for('create_talent_club_proposal') }}" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.name.label(class="form-label fw-medium") }}
                            {{ form.name(class="form-control form-control-lg" + (" is-invalid" if form.name.errors else ""), placeholder="E.g., Robotics Club, Debate Society") }}
                            {% if form.name.errors %}<div class="invalid-feedback">{% for e in form.name.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.social_category_id.label(text="Club Category", class="form-label fw-medium") }}
                            {{ form.social_category_id(class="form-select tom-select" + (" is-invalid" if form.social_category_id.errors else ""), placeholder="Select a primary category...") }}
                            {% if form.social_category_id.errors %}<div class="invalid-feedback">{% for e in form.social_category_id.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="5", placeholder="Describe the club's mission, activities, and goals...") }}
                            {% if form.description.errors %}<div class="invalid-feedback">{% for e in form.description.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="mentioned_member_ids_picker" class="form-label fw-medium">Mention Initial Members (Min. 5, excluding yourself)</label>
                            <select id="mentioned_member_ids_picker" class="form-control tom-select-members" multiple placeholder="Search and select TC members...">
                                {# Options will be populated by JS via AJAX for TomSelect #}
                            </select>
                            {# Hidden input to store the comma-separated list of selected member IDs for form submission #}
                            <input type="hidden" name="mentioned_member_ids" id="mentioned_member_ids_hidden">
                            <small class="form-text text-muted">These members will be notified to accept or decline being part of your initial group.</small>
                            {# Placeholder for JS validation errors related to member selection #}
                            <div class="invalid-feedback d-none" id="mentionedMembersError"></div>
                        </div>

                        <div class="mb-3">
                            {{ form.proposal_file.label(text="Proposal Document (Optional PDF, DOC, TXT)",class="form-label fw-medium") }}
                            {{ form.proposal_file(class="form-control filepond-input" + (" is-invalid" if form.proposal_file.errors else "")) }} {# Use filepond-input class #}
                             <small class="form-text text-muted">Attach a detailed proposal document if you have one.</small>
                            {% if form.proposal_file.errors %}<div class="invalid-feedback">{% for e in form.proposal_file.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a href="{{ url_for('talent_club_configuration') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Submit Proposal for Review") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/utils.js') }}?v={{ range(1, 100000) | random }}"></script> {# Ensure utils.js (with getData) is loaded BEFORE this script #}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect for category
        const categorySelect = document.getElementById('{{ form.social_category_id.id }}');
        if (categorySelect) {
            try { // Add try-catch for robustness
                new TomSelect(categorySelect, { create: false, placeholder: 'Select a category...' });
                console.log('TomSelect for CATEGORY initialized successfully.');
            } catch (e) {
                console.error('Error initializing TomSelect for category:', e);
            }
        } else {
            console.warn('Category select element not found for TomSelect init.');
        }

        // Initialize TomSelect for mentioning members
        const memberPicker = document.getElementById('mentioned_member_ids_picker');
        const hiddenMemberInput = document.getElementById('mentioned_member_ids_hidden');

        if (memberPicker && hiddenMemberInput) {
            try { // Add try-catch for robustness
                const memberTomSelect = new TomSelect(memberPicker, { // Store instance in a variable
                    valueField: 'id',
                    labelField: 'text',
                    searchField: ['text'],
                    plugins: ['remove_button'],
                    maxItems: 10,
                    placeholder: 'Search and select TC members...',
                    create: false,
                    load: function(query, callback) {
                        console.log('[MEMBER PICKER] TomSelect load triggered. Query:', query); // LOG 1
                        if (!query || query.length < 2) {
                            console.log('[MEMBER PICKER] Query too short, returning.'); // LOG 2
                            return callback(); // Important to call callback even if no search
                        }
                        console.log('[MEMBER PICKER] Query is sufficient, attempting getData for:', query); // LOG 3
                        getData(`/talent_club/api/members/search?q=${encodeURIComponent(query)}`)
                            .then(response => {
                                console.log('[MEMBER PICKER] Received from API:', response); // LOG 4
                                callback(response);
                            })
                            .catch((error) => {
                                console.error('[MEMBER PICKER] TomSelect load error during getData:', error); // LOG 5
                                callback(); // Call callback even on error
                            });
                    },
                    onChange: function(value) {
                        console.log('[MEMBER PICKER] onChange triggered. Value:', value); // LOG 6
                        hiddenMemberInput.value = value.join(',');
                        // ... (your existing errorDiv logic for min members if needed) ...
                    },
                    onLoad: function() {
                        console.log('[MEMBER PICKER] TomSelect options loaded (onLoad event).'); // LOG 7 (if options were pre-loaded, not via AJAX load)
                    },
                    onFocus: function() {
                        console.log('[MEMBER PICKER] TomSelect focused.'); // LOG 8
                    },
                    onType: function(str) {
                        console.log('[MEMBER PICKER] TomSelect typed:', str); // LOG 9
                    },
                    render: {
                        option: function(data, escape) {
                            return `<div class="d-flex align-items-center">
                                        <div>
                                            <div class="text-dark">${escape(data.text)}</div>
                                            ${data.role ? `<small class="text-muted">${escape(data.role.replace('_',' ').title())}</small>` : ''}
                                        </div>
                                    </div>`;
                        },
                        item: function(data, escape) {
                            return `<div class="text-dark">${escape(data.text)}</div>`;
                        }
                    }
                });
                console.log('TomSelect for MEMBER PICKER initialized successfully. Instance:', memberTomSelect); // LOG 10
            } catch (e) {
                console.error('Error initializing TomSelect for MEMBER PICKER:', e); // LOG 11
            }
        } else {
            console.warn('Member picker or hidden input element not found for TomSelect init.'); // LOG 12
        }
        
        console.log('Propose New Club page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/hr_ceo/pending_assets.html =====
{% extends "layout/base.html" %}

{% block page_title %}Assets Pending Review{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-hourglass-split me-2 text-warning"></i>Assets Pending Review
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('list_all_assets') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-boxes me-1"></i> View All Assets
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0 font-heading">New Assets Awaiting Your Approval</h5>
        </div>
        <div class="card-body p-0"> {# Remove padding for full-width table #}
            {% if pending_assets and pending_assets | length > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Added By</th>
                                <th scope="col">Date Added</th>
                                <th scope="col">Qty</th>
                                <th scope="col">Suggested Category</th>
                                <th scope="col">Suggested Lab</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in pending_assets %}
                            <tr>
                                <td>{{ asset.id }}</td>
                                <td class="fw-medium">
                                    <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="text-decoration-none">
                                        {{ asset.name | truncate(40) }}
                                    </a>
                                </td>
                                <td>{{ asset.added_by_user.full_name or asset.added_by_user.username if asset.added_by_user else 'N/A' }}</td>
                                <td>{{ asset.created_at | dateformat if asset.created_at else (asset.reports[0].report_date | dateformat if asset.reports else 'N/A') }}</td> {# Assuming created_at for new assets #}
                                <td>{{ asset.quantity }}</td>
                                <td>
                                    {% if asset.category %}
                                        <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ asset.category.name }}</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">None Suggested</span>
                                    {% endif %}
                                </td>
                                 <td>
                                    {% if asset.lab %}
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ asset.lab.name }}</span>
                                    {% elif asset.location_description %}
                                        <span class="text-muted fst-italic">{{ asset.location_description | truncate(20) }}</span>
                                    {% else %}
                                        <span class="text-muted fst-italic">None Suggested</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="btn btn-sm btn-primary" title="Review and Edit Asset">
                                        <i class="bi bi-pencil-square me-1"></i> Review
                                    </a>
                                    {# Optional: Quick Approve/Reject if simple cases exist, but edit_asset is safer #}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted p-5">
                    <i class="bi bi-check2-all display-3 mb-3 text-success"></i>
                    <h4 class="font-heading">All Clear!</h4>
                    <p>There are no new assets currently pending review.</p>
                </div>
            {% endif %}
        </div>
        {# Optional: Pagination if the list can be very long #}
        {# {% if paginated_assets and (paginated_assets.has_prev or paginated_assets.has_next) %} ... {% endif %} #}
    </div>
</div>
{% endblock %}-e 

===== templates/hr_ceo/manage_categories.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage Asset Categories{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-tags-fill me-2 text-primary"></i>Manage Asset Categories
        </h1>
        <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Left Column: List Existing Categories #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Existing Asset Categories</h5>
                </div>
                <div class="card-body p-0"> {# No padding for full-width table #}
                    {% if categories and categories | length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Description</th>
                                        <th scope="col" class="text-center">Assets Linked</th>
                                        <th scope="col" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for category in categories %}
                                    <tr>
                                        <td>{{ category.id }}</td>
                                        <td class="fw-medium">{{ category.name }}</td>
                                        <td>{{ category.description | truncate(60) if category.description else '-' }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">
                                                {{ category.assets.count() }} {# Assuming 'assets' is a dynamic relationship #}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <a href="{{ url_for('edit_asset_category', category_id=category.id) }}" class="btn btn-sm btn-outline-primary p-1 me-1" title="Edit Category">
                                                <i class="bi bi-pencil-fill fs-6"></i>
                                            </a>
                                            {# Delete button triggers a modal confirmation #}
                                            <button type="button" class="btn btn-sm btn-outline-danger p-1"
                                                    data-bs-toggle="modal" data-bs-target="#deleteCategoryModal"
                                                    data-category-id="{{ category.id }}" data-category-name="{{ category.name }}"
                                                    title="Delete Category"
                                                    {% if category.assets.count() > 0 %}disabled{% endif %}> {# MODIFIED: Removed 'or category.channels.count() > 0' #}
                                                <i class="bi bi-trash-fill fs-6"></i>
                                            </button>
                                            {% if category.assets.count() > 0 %} {# MODIFIED: Removed 'or category.channels.count() > 0' #}
                                                <small class="d-block text-muted" style="font-size: 0.7rem;">(Reassign assets to enable delete)</small> {# MODIFIED: Text updated #}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted p-5">
                            <i class="bi bi-tag-fill display-3 mb-3"></i>
                            <h4 class="font-heading">No Categories Found</h4>
                            <p>Start by adding a new asset category using the form.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Right Column: Add New Category Form #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success-subtle text-success-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-plus-circle-dotted me-2"></i>Add New Category</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('add_asset_category') }}" novalidate>
                        {{ add_form.hidden_tag() if add_form.hidden_tag }} {# CSRF Token for add_form #}

                        <div class="mb-3">
                            {{ add_form.name.label(class="form-label fw-medium") }}
                            {{ add_form.name(class="form-control" + (" is-invalid" if add_form.name.errors else ""), placeholder="e.g., IT Hardware, Furniture") }}
                            {% if add_form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in add_form.name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ add_form.description.label(class="form-label fw-medium") }}
                            {{ add_form.description(class="form-control" + (" is-invalid" if add_form.description.errors else ""), rows="3", placeholder="Optional brief description") }}
                            {% if add_form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in add_form.description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-grid">
                            {{ add_form.submit(class="btn btn-success", value="Add Category") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# Delete Category Confirmation Modal #}
    <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title font-heading" id="deleteCategoryModalLabel"><i class="bi bi-trash3-fill me-2"></i>Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the category: <strong id="categoryNameToDelete"></strong>?</p>
                    <p class="text-danger"><small>This action cannot be undone. Ensure no assets are linked to this category.</small></p> {# MODIFIED: Text updated #}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteCategoryForm" method="POST" action=""> {# Action will be set by JS #}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() if csrf_token else '' }}">
                        <button type="submit" class="btn btn-danger">Yes, Delete Category</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const deleteCategoryModal = document.getElementById('deleteCategoryModal');
        if (deleteCategoryModal) {
            deleteCategoryModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget; // Button that triggered the modal
                const categoryId = button.getAttribute('data-category-id');
                const categoryName = button.getAttribute('data-category-name');

                const modalTitle = deleteCategoryModal.querySelector('.modal-title');
                const categoryNameSpan = deleteCategoryModal.querySelector('#categoryNameToDelete');
                const deleteForm = deleteCategoryModal.querySelector('#deleteCategoryForm');

                categoryNameSpan.textContent = categoryName;
                // Dynamically set the form action URL for deletion
                deleteForm.action = `/hr_ceo/asset_category/${categoryId}/delete`; // Matches your Flask route
            });
        }
        console.log('Manage Asset Categories JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/manage_tc_leader.html =====
{% extends "layout/base.html" %}

{% block page_title %}Manage System TC Leader{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-workspace me-2 text-primary"></i>Manage System Talent Club Leader
        </h1>
        <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to HR Dashboard
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Current Leader & Election Status Column #}
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-check-fill me-2"></i>Current System TC Leader</h5>
                </div>
                <div class="card-body">
                    {% if current_leader %}
                        <div class="d-flex align-items-center">
                            {% set leader_avatar = url_for('static', filename=(current_leader.profile_photo_url if current_leader.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                            <img src="{{ leader_avatar }}" alt="{{ current_leader.username }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover;">
                            <div>
                                <h6 class="font-heading mb-0">{{ current_leader.full_name or current_leader.username }}</h6>
                                <small class="text-muted">{{ current_leader.username }} | {{ current_leader.role.name | title if current_leader.role }}</small>
                            </div>
                        </div>
                        <form action="{{ url_for('hr_ceo_demote_tc_leader', user_id=current_leader.id) }}" method="POST" class="mt-3">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-sm btn-outline-danger w-100 confirm-demote-leader">
                                <i class="bi bi-person-fill-down me-1"></i> Demote Current Leader
                            </button>
                        </form>
                    {% else %}
                        <p class="text-muted text-center py-3">No system-wide Talent Club Leader is currently assigned.</p>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-archive-fill me-2"></i>Past Elections</h5>
                </div>
                <div class="list-group list-group-flush" style="max-height: 300px; overflow-y:auto;">
                    {% if past_elections and past_elections | length > 0 %}
                        {% for election in past_elections %}
                            <div class="list-group-item">
                                <small class="d-block">
                                    <strong>Concluded:</strong> {{ election.concluded_at | dateformat }}
                                    {% if election.elected_leader %}
                                        | <strong>Winner:</strong> {{ election.elected_leader.full_name or election.elected_leader.username }}
                                    {% else %}
                                        | <span class="text-muted">No winner declared</span>
                                    {% endif %}
                                </small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="list-group-item text-muted text-center p-3">No past election records.</div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Active Election Management Column #}
        <div class="col-lg-7 col-xl-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-bounding-box me-2"></i>Talent Club Leader Election</h5>
                </div>
                <div class="card-body">
                    {% if active_election %}
                        <h6 class="font-heading">Active Election (ID: {{ active_election.id }})</h6>
                        <p class="text-muted">Initiated on: {{ active_election.initiated_at | datetimeformat }}</p>
                        <p><strong>Total Votes Cast:</strong> <span class="badge bg-info rounded-pill fs-09rem">{{ total_votes_in_active_election }}</span></p>

                        <h6 class="mt-3 font-heading">Candidate Votes:</h6>
                        {% if candidate_vote_counts %}
                            <ul class="list-group list-group-numbered mb-3">
                                {% for candidate_id, votes in candidate_vote_counts.items() | sort(attribute='1', reverse=True) %}
                                    {% set cand = eligible_candidates | selectattr('id', 'equalto', candidate_id) | first %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ cand.full_name or cand.username if cand else 'Unknown Candidate' }}
                                        <span class="badge bg-primary rounded-pill">{{ votes }} vote{{'s' if votes != 1 else ''}}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No votes cast yet in this election.</p>
                        {% endif %}

                        <form action="{{ url_for('hr_ceo_conclude_tc_leader_election', election_id=active_election.id) }}" method="POST" class="mt-3">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-success w-100 confirm-conclude-election">
                                <i class="bi bi-flag-fill me-1"></i> Conclude Election & Declare Winner
                            </button>
                        </form>
                        {# Optional: Cancel election button #}

                    {% else %}
                        <p class="text-muted">No election is currently active.</p>
                        {% if eligible_candidates and eligible_candidates | length > 0 %}
                        <form action="{{ url_for('hr_ceo_initiate_tc_leader_election') }}" method="POST">
                            {{ csrf_token() if csrf_token else '' }}
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-megaphone-fill me-1"></i> Initiate New Election
                            </button>
                        </form>
                        {% else %}
                            <div class="alert alert-warning small" role="alert">
                                <i class="bi bi-exclamation-circle-fill me-1"></i> Cannot initiate an election: No eligible Talent Club members found to be candidates/voters.
                            </div>
                        {% endif %}
                    {% endif %}

                    <hr class="my-4">
                    <h6 class="font-heading">Eligible Candidates/Voters (Active TC Members)</h6>
                    {% if eligible_candidates and eligible_candidates | length > 0 %}
                        <ul class="list-unstyled list-group- DGGGGGGGGGG" style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;">
                            {% for candidate in eligible_candidates %}
                                <li class="list-group-item list-group-item-light py-1 px-2 d-flex align-items-center">
                                     {% set cand_avatar = url_for('static', filename=(candidate.profile_photo_url if candidate.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
                                    <img src="{{ cand_avatar }}" alt="{{ candidate.username }}" class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: cover;">
                                    {{ candidate.full_name or candidate.username }}
                                    <small class="text-muted ms-auto">{{candidate.username}}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted small">No active Talent Club members found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/talent_club.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Confirmation for demoting leader
        document.querySelectorAll('.confirm-demote-leader').forEach(button => {
            button.addEventListener('click', function(event) {
                if (!confirm('Are you sure you want to demote the current Talent Club Leader? This action cannot be undone easily.')) {
                    event.preventDefault();
                }
            });
        });
        // Confirmation for concluding election
         document.querySelectorAll('.confirm-conclude-election').forEach(button => {
            button.addEventListener('click', function(event) {
                if (!confirm('Are you sure you want to conclude this election? The candidate(s) with the most votes will be declared the winner. This cannot be undone.')) {
                    event.preventDefault();
                }
            });
        });
        console.log('Manage System TC Leader JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/hr_ceo/dashboard.html =====
{% extends "layout/base.html" %}

{# DEFINE MACROS FIRST, AFTER EXTENDS #}
{% macro render_stat_card(card_title, card_value, card_icon, card_color_class, card_url=None, card_url_text='View Details', card_id=None) %}
<div class="col">
    <div class="card dashboard-stat-card h-100 shadow-sm" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ card_color_class | default('text-primary') }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ card_url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% macro render_quick_links(links) %}
    {% if links and links | length > 0 %}
    <div class="card shadow-sm dashboard-quick-links-card">
        <div class="card-header">
            <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
        </div>
        <div class="list-group list-group-flush">
            {% for link in links %}
                <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                    <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                    <span class="fw-medium">{{ link.text | default('Link') }}</span>
                    <i class="bi bi-chevron-right ms-auto text-muted small"></i>
                </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
{% endmacro %}

{% macro render_recent_activity(activities) %}
<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if activities and activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity to display.</p>
            </div>
        {% endif %}
    </div>
    {% if activities and activities | length > 5 %}
    <a href="{{ url_for('view_notifications') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Activity <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>
{% endmacro %}
{# END OF MACRO DEFINITIONS #}


{% block page_title %}HR & Academics Dashboard{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-briefcase-fill me-2 text-primary"></i>HR & Academics Dashboard
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('create_task') }}" class="btn btn-sm btn-success me-2">
                 <i class="bi bi-plus-square-dotted me-1"></i> Create New Task
            </a>
            <a href="{{ url_for('settings') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-gear-fill me-1"></i> Settings
            </a>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">

    {# Welcome Message #}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm welcome-card bg-primary text-white">
                <div class="card-body">
                    <h4 class="card-title font-heading">Welcome, {{ current_user.full_name or current_user.username }}!</h4>
                    <p class="mb-0">Oversee school operations, manage staff and student affairs, and track key performance indicators.</p>
                </div>
            </div>
        </div>
    </div>

    {# Main Stats Cards Row #}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4 mb-4">
        {{ render_stat_card(
            card_title="Total Students",
            card_value=student_count | default(0),
            card_icon="bi-people-fill",
            card_color_class="text-info",
            card_url=url_for('student_database_index')
        ) }}

        {# Link to teacher management page if exists #}
        {{ render_stat_card(
            card_title="Total Teachers",
            card_value=teacher_count | default(0),
            card_icon="bi-person-video3",
            card_color_class="text-success",
            card_url="#"
        ) }}

        {{ render_stat_card(
            card_title="Student Leaders",
            card_value=student_leader_count | default(0),
            card_icon="bi-person-check-fill",
            card_color_class="text-primary",
            card_url=url_for('manage_student_leaders')
        ) }}

        {{ render_stat_card(
            card_title="Pending Assets",
            card_value=pending_assets | default(0),
            card_icon="bi-box-seam-fill",
            card_color_class="text-warning",
            card_url=url_for('list_pending_assets')
        ) }}

        {{ render_stat_card(
            card_title="Open Asset Reports",
            card_value=reports_open | default(0),
            card_icon="bi-flag-fill",
            card_color_class="text-danger",
            card_url=url_for('list_asset_reports')
        ) }}

        {# Backend needs to provide this count #}
        {{ render_stat_card(
            card_title="Tasks Assigned by You",
            card_value=my_assigned_tasks_count | default(0),
            card_icon="bi-card-checklist",
            card_color_class="text-secondary",
            card_url=url_for('my_assigned_tasks')
        ) }}

        {# Backend needs to provide this count #}
        {{ render_stat_card(
            card_title="Requests Inbox",
            card_value=requests_inbox_count | default(0),
            card_icon="bi-envelope-paper-fill",
            card_color_class="text-info",
            card_url=url_for('requests_inbox')
        ) }}

        {% set unread_notif_val = unread_notifications_count if unread_notifications_count != "N/A" else 0 %}
        {{ render_stat_card(
            card_title="Unread Notifications",
            card_value=unread_notif_val,
            card_icon="bi-bell-fill",
            card_color_class="text-warning",
            card_url=url_for('view_notifications')
        ) }}
    </div>

    <div class="row g-4">
        {# Left Column: Quick Links & Pending Reviews #}
        <div class="col-lg-4 col-xl-3">
            {% set hr_ceo_quick_links = [
                {'url': url_for('list_pending_assets'), 'text': 'Review Pending Assets', 'icon': 'bi-box-arrow-in-down', 'color_class': 'text-primary'},
                {'url': url_for('list_asset_reports'), 'text': 'Manage Asset Reports', 'icon': 'bi-tools', 'color_class': 'text-danger'},
                {'url': url_for('manage_student_leaders'), 'text': 'Manage Student Leaders', 'icon': 'bi-person-badge-fill', 'color_class': 'text-success'},
                {'url': url_for('manage_asset_categories'), 'text': 'Manage Asset Categories', 'icon': 'bi-tags-fill', 'color_class': 'text-info'},
                {'url': url_for('my_assigned_tasks'), 'text': 'View Tasks You Assigned', 'icon': 'bi-card-list', 'color_class': 'text-secondary'},
                {'url': url_for('hr_ceo_initiate_request'), 'text': 'Initiate Request (Tier 2)', 'icon': 'bi-send-plus-fill', 'color_class': 'text-warning'},
                {'url': url_for('manage_system_tc_leader'), 'text': 'Manage TC System Leader', 'icon': 'bi-trophy-fill', 'color_class': 'text-primary'}
            ] %}
            {{ render_quick_links(hr_ceo_quick_links) }}

             {# Analytics Quick Links #}
            <div class="card shadow-sm mt-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-pie-chart-fill me-2"></i>Analytics</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" onclick="fetchAndDisplayAnalytics('attendance', 'Attendance Overview', 'attendanceChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-calendar3-event me-2 text-success"></i>Attendance Data</a>
                    <a href="#" onclick="fetchAndDisplayAnalytics('performance', 'Performance Averages', 'performanceChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-graph-up-arrow me-2 text-info"></i>Performance Data</a>
                    <a href="#" onclick="fetchAndDisplayAnalytics('demographics', 'Student Demographics', 'demographicsChartContainer'); return false;" class="list-group-item list-group-item-action"><i class="bi bi-gender-ambiguous me-2 text-warning"></i>Demographics Data</a>
                </div>
            </div>
        </div>

        {# Right Column: Analytics Charts & Recent Activity #}
        <div class="col-lg-8 col-xl-9">
            <div class="row g-4">
                <div class="col-xl-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading"><i class="bi bi-calendar3-event me-2"></i>Attendance Overview</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="attendanceChartContainer">
                                <canvas id="attendanceChart"></canvas> {# Chart.js will target this #}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading"><i class="bi bi-graph-up-arrow me-2"></i>Performance Averages</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="performanceChartContainer">
                               <canvas id="performanceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
             {{ render_recent_activity(recent_activities) }} {# Assuming recent_activities is passed #}
            </div>
        </div>
    </div>
</div>
{% endblock %} {# This is the end of the content block #}

{% block body_scripts %}
{# utils.js should be loaded before this in base.html #}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('HR/CEO Dashboard JS (using global analytics) loaded.');
        if (typeof fetchAndDisplayAnalytics === 'function') {
            fetchAndDisplayAnalytics('attendance', 'Attendance Overview', 'attendanceChartContainer', 'doughnut');
            fetchAndDisplayAnalytics('performance', 'Performance Averages', 'performanceChartContainer', 'bar');
            // For demographics if you add a canvas for it:
            // fetchAndDisplayAnalytics('demographics', 'Student Demographics', 'demographicsChartContainer', 'pie');
        } else {
            console.error("fetchAndDisplayAnalytics function not found. Ensure utils.js is loaded.");
        }
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/edit_category.html =====
{% extends "layout/base.html" %}

{% set page_title = "Edit Category: " + (category.name if category else "New Category") %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-pencil-square me-2 text-primary"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('manage_asset_categories') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to Categories
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading">Category Details</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('edit_asset_category', category_id=category.id if category else 0) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token for the edit form #}

                        <div class="mb-3">
                            {{ form.name.label(class="form-label fw-medium") }}
                            {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), placeholder="e.g., IT Hardware, Furniture") }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.name.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-medium") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows="4", placeholder="Optional brief description of the category") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('manage_asset_categories') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Save Changes") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/hr_ceo/resolve_report.html =====
{% extends "layout/base.html" %}

{% set page_title = "Resolve Report ID: " + (report.id | string) %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-check-circle-fill text-success me-2"></i>{{ page_title }}
        </h1>
        <a href="{{ url_for('list_asset_reports') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Back to All Reports
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0 font-heading">Report Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-3">Report ID:</dt>
                        <dd class="col-sm-9">{{ report.id }}</dd>

                        <dt class="col-sm-3">Asset Reported:</dt>
                        <dd class="col-sm-9">
                            {% if report.asset %}
                                <a href="{{ url_for('edit_asset', asset_id=report.asset.id) }}" class="text-decoration-none">{{ report.asset.name }} (ID: {{ report.asset.id }})</a>
                            {% else %}
                                <span class="fst-italic text-muted">General Report (Not linked to a specific asset)</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-3">Reported By:</dt>
                        <dd class="col-sm-9">{{ report.reporter.full_name or report.reporter.username if report.reporter else 'N/A' }}</dd>

                        <dt class="col-sm-3">Report Date:</dt>
                        <dd class="col-sm-9">{{ report.report_date | datetimeformat }}</dd>

                        <dt class="col-sm-3">Issue Description:</dt>
                        <dd class="col-sm-9">{{ report.damage_description }}</dd>

                        {% if report.date_of_damage %}
                        <dt class="col-sm-3">Date of Damage:</dt>
                        <dd class="col-sm-9">{{ report.date_of_damage | dateformat }}</dd>
                        {% endif %}

                        <dt class="col-sm-3">Quantity Damaged:</dt>
                        <dd class="col-sm-9">{{ report.quantity_damaged }}</dd>

                        <dt class="col-sm-3">Current Status:</dt>
                        <dd class="col-sm-9">
                             {% if report.status == 'Pending' %}
                                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'In Progress' %}
                                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'Resolved' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% elif report.status == 'Rejected' %}
                                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% else %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
                            {% endif %}
                        </dd>

                        {% if report.resolver %}
                        <dt class="col-sm-3">Resolved/Rejected By:</dt>
                        <dd class="col-sm-9">{{ report.resolver.full_name or report.resolver.username }}</dd>
                        {% endif %}
                        {% if report.resolved_date %}
                        <dt class="col-sm-3">Resolved/Rejected Date:</dt>
                        <dd class="col-sm-9">{{ report.resolved_date | datetimeformat }}</dd>
                        {% endif %}
                    </dl>
                </div>
            </div>

            {% if report.status not in ['Resolved', 'Rejected'] %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-pencil-fill me-2"></i>Update Report Status & Resolution</h5>
                </div>
                <div class="card-body p-4">
                    {% include 'layout/_flash_messages.html' %}
                    <form method="POST" action="{{ url_for('resolve_asset_report', report_id=report.id) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.status.label(class="form-label fw-medium") }}
                            {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                            {% if form.status.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.status.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.resolution_notes.label(class="form-label fw-medium") }}
                            {{ form.resolution_notes(class="form-control" + (" is-invalid" if form.resolution_notes.errors else ""), rows="4", placeholder="Enter notes regarding the resolution, actions taken, or reasons for rejection...") }}
                            {% if form.resolution_notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.resolution_notes.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {# Optional: Field to link a general report to an asset - More complex UI needed #}
                        {# {% if not report.asset_id and form.link_to_asset_id %}
                        <div class="mb-3">
                            {{ form.link_to_asset_id.label(class="form-label fw-medium") }}
                            {{ form.link_to_asset_id(class="form-select tom-select" + (" is-invalid" if form.link_to_asset_id.errors else "")) }}
                            <small class="form-text text-muted">If this general report pertains to a specific asset, link it here.</small>
                            {% if form.link_to_asset_id.errors %}<div class="invalid-feedback">{% for e in form.link_to_asset_id.errors %}{{e}}{% endfor %}</div>{% endif %}
                        </div>
                        {% endif %} #}

                        <hr class="my-4">
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('list_asset_reports') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Update Report") }}
                        </div>
                    </form>
                </div>
            </div>
            {% elif report.resolution_notes %} {# Show notes if already resolved/rejected #}
             <div class="card shadow-sm">
                <div class="card-header bg-light-subtle">
                     <h5 class="mb-0 font-heading"><i class="bi bi-card-text me-2"></i>Resolution Notes</h5>
                </div>
                <div class="card-body">
                    <p class="fst-italic">{{ report.resolution_notes }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect if link_to_asset_id field is present and needs it
        // const assetLinkSelect = document.getElementById('{{ form.link_to_asset_id.id if form.link_to_asset_id else '' }}');
        // if (assetLinkSelect) {
        //     new TomSelect(assetLinkSelect, {
        //         create: false,
        //         placeholder: 'Search and select an asset...'
        //         // Add remote loading options if needed for asset search
        //     });
        // }
        console.log('Resolve Asset Report page JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/student_leaders.html =====
{% extends "layout/base.html" %}

{% block page_title %}{{ title or "Manage Student Leaders" }}{% endblock %}

{% block content_header %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="page-title font-heading mb-0">
        <i class="bi bi-person-badge-fill me-2 text-primary"></i>Manage Student Leaders & Assignments
    </h1>
    <a href="{{ url_for('hr_ceo_dashboard') }}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-1"></i> Back to Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    <div class="row g-4">
        {# Left Column: Assign Students Form & Current Leaders List (Optional) #}
        <div class="col-lg-4 col-xl-3">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary-subtle text-primary-emphasis">
                    <h5 class="mb-0 font-heading"><i class="bi bi-person-plus-fill me-2"></i>Assign Students to Leader</h5>
                </div>
                <div class="card-body p-3">
                    {% if form and form.leader.choices and form.leader.choices[0][0] != 0 %} {# Check if leaders exist for form #}
                        <form method="POST" action="{{ url_for('manage_student_leaders') }}" novalidate>
                            {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}
                            <div class="mb-3">
                                {{ form.leader.label(class="form-label fw-medium") }}
                                {{ form.leader(class="form-select tom-select" + (" is-invalid" if form.leader.errors else "")) }}
                                {% if form.leader.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.leader.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Select an active student leader who has a grade and section assigned.</small>
                            </div>
                            <p class="fw-medium">Select students below (from the main list) to assign to this leader.</p>
                            <div class="d-grid">
                                {{ form.submit(class="btn btn-primary", value="Assign Selected Students") }}
                            </div>
                            <small class="form-text text-muted mt-2 d-block">Note: Students will only be assigned if they are in the same grade and section as the selected leader.</small>
                        </form>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="bi bi-person-x-fill fs-3 mb-2"></i><br>
                            No active student leaders with assigned grade/sections found. Promote a student to leader first to enable assignment.
                        </p>
                    {% endif %}
                </div>
            </div>

            {% if current_leaders %}
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 font-heading"><i class="bi bi-star-fill me-2 text-warning"></i>Current Student Leaders</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for leader_user in current_leaders %}
                        <a href="#block-{{ leader_user.grade }}-{{ leader_user.section }}" class="list-group-item list-group-item-action">
                            {{ leader_user.full_name or leader_user.username }}
                            <small class="d-block text-muted">Grade {{ leader_user.grade }} - Section {{ leader_user.section }}</small>
                        </a>
                    {% else %}
                        <div class="list-group-item text-muted">No student leaders currently assigned.</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {# Right Column: Student Blocks by Grade/Section #}
        <div class="col-lg-8 col-xl-9">
            {% if students_by_grade_section %}
                {% for key, data in students_by_grade_section.items() %}
                    {% set grade, section = key %}
                    <div class="card shadow-sm mb-4" id="block-{{ grade }}-{{ section }}">
                        <div class="card-header">
                            <h5 class="mb-0 font-heading">
                                <i class="bi bi-collection-fill me-2"></i>Grade {{ grade }} - Section {{ section }}
                                {% if data.leader %}
                                    <small class="text-muted fw-normal ms-2">(Leader: <span class="text-success">{{ data.leader.full_name or data.leader.username }}</span>)</small>
                                {% else %}
                                    <small class="text-danger fw-normal ms-2">(No Leader Assigned)</small>
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if not data.leader and not data.followers and not data.unassigned_students %}
                                <p class="text-muted text-center m-0 py-3">No students found in this block.</p>
                            {% else %}
                                <form method="POST" action="{{ url_for('manage_student_leaders') }}"> {# Target for student selection checkboxes #}
                                    {{ form.hidden_tag() if form.hidden_tag }} {# CSRF for the main assignment form #}
                                    
                                    <h6 class="font-heading text-muted mb-2">
                                        {% if data.leader %}
                                            Leader & Followers ({{ (data.followers or []) | length + 1 }})
                                        {% else %}
                                            Unassigned Students (Potential Leaders) ({{ (data.unassigned_students or []) | length }})
                                        {% endif %}
                                    </h6>
                                    <ul class="list-group list-group-flush mb-3">
                                        {# Display Leader (if exists for this block) #}
                                        {% if data.leader %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2">
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ data.leader.id }}" id="student-{{ data.leader.id }}" form="assignStudentsFormId"> {# Add form attribute if assign form is outside this one #}
                                                    <label class="form-check-label fw-bold text-success" for="student-{{ data.leader.id }}">
                                                        {{ data.leader.full_name or data.leader.username }} (Current Leader <i class="bi bi-star-fill text-warning"></i>)
                                                    </label>
                                                </div>
                                                <form method="POST" action="{{ url_for('toggle_student_leader_status', student_id=data.leader.id) }}" class="d-inline">
                                                     <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger p-1" title="Demote Leader">
                                                        <i class="bi bi-person-x-fill fs-6"></i> Demote
                                                    </button>
                                                </form>
                                            </li>
                                        {% endif %}

                                        {# Display Followers (if leader exists) #}
                                        {% if data.leader and data.followers %}
                                            {% for student in data.followers %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2 ps-4"> {# Indent followers #}
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ student.id }}" id="student-{{ student.id }}" form="assignStudentsFormId">
                                                    <label class="form-check-label" for="student-{{ student.id }}">
                                                        {{ student.full_name or student.username }}
                                                        <small class="text-muted ms-1">(Following {{ data.leader.username }})</small>
                                                    </label>
                                                </div>
                                                {# Action for follower - e.g., Unassign (handled by re-assigning to no one or another leader) #}
                                            </li>
                                            {% endfor %}
                                        {% endif %}

                                        {# Display Unassigned Students (or potential leaders if no leader for block) #}
                                        {% for student in data.unassigned_students %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center py-2 px-2">
                                                <div>
                                                    <input class="form-check-input me-2" type="checkbox" name="students_to_assign" value="{{ student.id }}" id="student-{{ student.id }}" form="assignStudentsFormId">
                                                    <label class="form-check-label" for="student-{{ student.id }}">
                                                        {{ student.full_name or student.username }}
                                                        {% if student.leader %}<small class="text-muted ms-1">(Assigned to: {{ student.leader.username }})</small>{% endif %}
                                                    </label>
                                                </div>
                                                <form method="POST" action="{{ url_for('toggle_student_leader_status', student_id=student.id) }}" class="d-inline">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-success p-1" title="Promote to Leader">
                                                        <i class="bi bi-person-check-fill fs-6"></i> Promote
                                                    </button>
                                                </form>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </form> {# End of the checkbox form for assignments #}
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info text-center">No student blocks found. Please ensure students have grades and sections assigned.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize TomSelect for the leader selection dropdown if it exists
        const leaderSelect = document.querySelector('.tom-select'); // Target the class if dynamically added
        if (leaderSelect) {
            new TomSelect(leaderSelect, {
                placeholder: 'Search or select a leader...',
                allowEmptyOption: true // If you have a "--- Select Leader ---" option
            });
        }

        // Optional: Add JS to handle dynamic checkbox selection and update hidden field for Assign Students form
        // This depends on how the form in the left column is structured relative to checkboxes in the right column.
        // For simplicity, the template above assumes the checkboxes are part of the same form, or `form="assignStudentsFormId"` is used.
        // If they are separate, JS would be needed to collect checked student IDs and populate a hidden field.
        console.log('Manage Student Leaders JS loaded.');
    });
</script>
{% endblock %}
-e 

===== templates/hr_ceo/list_reports.html =====
{% extends "layout/base.html" %}

{% block page_title %}All Asset Reports{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-flag-fill text-danger me-2"></i>All Asset Reports
        </h1>
        {# Optional: Add filter controls or a "Report General Issue" button here if needed #}
        <a href="{{ url_for('report_asset_general') }}" class="btn btn-sm btn-outline-warning">
            <i class="bi bi-exclamation-triangle-fill me-1"></i> Report General Issue
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="card shadow-sm">
        <div class="card-header bg-light-subtle">
            <h5 class="mb-0 font-heading">List of Asset Reports</h5>
            {# Add search/filter form here if you implement those features in the route #}
        </div>
        <div class="card-body p-0">
            {% if reports %}
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" class="ps-3">ID</th>
                            <th scope="col">Asset Name</th>
                            <th scope="col">Reported By</th>
                            <th scope="col">Report Date</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="text-end pe-3">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report_item in reports %} {# Iterate through 'reports' (plural) #}
                        <tr>
                            <td class="ps-3"><strong>#{{ report_item.id }}</strong></td>
                            <td>
                                {% if report_item.asset %}
                                    <a href="{{ url_for('edit_asset', asset_id=report_item.asset.id) }}" class="text-decoration-none" title="View Asset Details">{{ report_item.asset.name }}</a>
                                    <small class="d-block text-muted">Category: {{ report_item.asset.category.name if report_item.asset.category else 'N/A' }}</small>
                                {% else %}
                                    <span class="fst-italic text-muted">General Report</span>
                                {% endif %}
                            </td>
                            <td>
                                {{ report_item.reporter.full_name or report_item.reporter.username if report_item.reporter else 'N/A' }}
                                <small class="d-block text-muted">{{ report_item.reporter.role.name.replace('_', ' ').title() if report_item.reporter and report_item.reporter.role else '' }}</small>
                            </td>
                            <td>
                                {{ report_item.report_date | datetimeformat('%b %d, %Y %I:%M %p') }}
                                <small class="d-block text-muted">({{ report_item.report_date | humanize_time_diff }})</small>
                            </td>
                            <td>
                                {% if report_item.status == 'Pending' %}
                                    <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'In Progress' %}
                                    <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'Resolved' %}
                                    <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% elif report_item.status == 'Rejected' %}
                                    <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ report_item.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-3">
                                <a href="{{ url_for('resolve_asset_report', report_id=report_item.id) }}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-search me-1"></i> View/Resolve
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center p-5 text-muted">
                <i class="bi bi-inbox fs-1 mb-2"></i>
                <p class="mb-0">No asset reports found.</p>
            </div>
            {% endif %}
        </div>
        {# Optional: Add pagination controls here if you implement pagination in the route #}
        {# {% if pagination and pagination.pages > 1 %}
            <div class="card-footer text-center">
                ... pagination links ...
            </div>
        {% endif %} #}
    </div>
</div>
{% endblock %}
-e 

===== templates/partials/_user_task_assignment_item.html =====
{# templates/partials/_user_task_assignment_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase G.3 #}
{#
    Reusable item for displaying a single user's assignment under a task (for creator's view).
    Expects a `user_assignment` object (UserTask instance) and `current_user`.
    - user_assignment.user (User object - the assignee)
    - user_assignment.status
    - user_assignment.completion_notes
    - user_assignment.reviewer_notes
    - user_assignment.last_status_update_at
    - user_assignment.assigned_at
    - user_assignment.task (the parent Task object)
#}

{% set assignee = user_assignment.user %}
{% set task = user_assignment.task %}
{% set assignee_avatar = url_for('static', filename=(assignee.profile_photo_url if assignee and assignee.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}

<div class="list-group-item user-task-assignment-item py-3 px-3 mb-2 shadow-sm border rounded
    {% if user_assignment.status == 'Open' %} border-info-subtle border-start-info border-start-3
    {% elif user_assignment.status == 'In Progress' %} border-primary-subtle border-start-primary border-start-3
    {% elif user_assignment.status in ['Completed (Pending Review)', 'Delayed (Pending Review)', 'Rejected (Pending Review)'] %} border-warning-subtle border-start-warning border-start-3
    {% elif user_assignment.status == 'Accepted' %} border-success-subtle border-start-success border-start-3
    {% elif user_assignment.status == 'Review Rejected' %} border-danger-subtle border-start-danger border-start-3
    {% else %} border-light-subtle {% endif %}">

    <div class="d-flex w-100 align-items-center mb-2">
        <img src="{{ assignee_avatar }}" alt="{{ assignee.username if assignee else 'N/A' }}" class="rounded-circle me-2 shadow-sm" style="width: 35px; height: 35px; object-fit: cover;">
        <div class="flex-grow-1">
            <h6 class="mb-0 font-heading assignee-name">
                {{ assignee.full_name or assignee.username if assignee else 'Unassigned User' }}
                <small class="text-muted fw-normal">({{ assignee.role.name.replace('_',' ') | title if assignee and assignee.role else 'N/A' }})</small>
            </h6>
            <small class="text-muted">Assigned: {{ user_assignment.assigned_at | dateformat }}</small>
        </div>
        <div class="text-end">
            <span class="badge fs-08rem px-2 py-1 rounded-pill
                {% if user_assignment.status == 'Open' %} bg-info-subtle text-info-emphasis
                {% elif user_assignment.status == 'In Progress' %} bg-primary-subtle text-primary-emphasis
                {% elif user_assignment.status.endswith('(Pending Review)') %} bg-warning-subtle text-warning-emphasis
                {% elif user_assignment.status == 'Accepted' %} bg-success-subtle text-success-emphasis
                {% elif user_assignment.status == 'Review Rejected' %} bg-danger-subtle text-danger-emphasis
                {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}">
                {{ user_assignment.status | replace(' (Pending Review)', '') }} {# Shorten for display #}
            </span>
            <small class="d-block text-muted mt-1">Last Update: {{ user_assignment.last_status_update_at | humanize_time_diff }}</small>
        </div>
    </div>

    {% if user_assignment.completion_notes %}
        <div class="assignment-notes my-2 p-2 bg-light-subtle border rounded small">
            <strong class="d-block mb-1"><i class="bi bi-chat-left-text-fill me-1"></i>Assignee's Notes:</strong>
            <p class="mb-0 fst-italic" style="white-space: pre-wrap;">{{ user_assignment.completion_notes }}</p>
        </div>
    {% endif %}

    {% if user_assignment.status == 'Review Rejected' and user_assignment.reviewer_notes %}
         <div class="assignment-notes my-2 p-2 bg-danger-subtle border border-danger- GGGGGGGGGGG rounded small">
            <strong class="d-block mb-1 text-danger-emphasis"><i class="bi bi-reply-all-fill me-1"></i>Your Review Notes (Rejected):</strong>
            <p class="mb-0 fst-italic" style="white-space: pre-wrap;">{{ user_assignment.reviewer_notes }}</p>
        </div>
    {% elif user_assignment.status == 'Accepted' and user_assignment.reviewer_notes %}
         <div class="assignment-notes my-2 p-2 bg-success-subtle border border-success- GGGGGGGGGGG rounded small">
            <strong class="d-block mb-1 text-success-emphasis"><i class="bi bi-check2-all me-1"></i>Your Review Notes (Accepted):</strong>
            <p class="mb-0 fst-italic" style="white-space: pre-wrap;">{{ user_assignment.reviewer_notes }}</p>
        </div>
    {% endif %}


    {# Action button for Creator/Admin to Review or View Detail #}
    {% if current_user.id == task.created_by_id or (current_user.role and current_user.role.name in ['system_admin', 'hr_ceo']) %}
        <div class="mt-2 text-end">
            {% if user_assignment.status in ['Completed (Pending Review)', 'Delayed (Pending Review)', 'Rejected (Pending Review)'] %}
                <a href="{{ url_for('view_user_task', user_task_id=user_assignment.id) }}#reviewFormSection" class="btn btn-sm btn-warning"> {# Anchor to review form section #}
                    <i class="bi bi-check-square-fill me-1"></i> Review Submission
                </a>
            {% else %}
                 <a href="{{ url_for('view_user_task', user_task_id=user_assignment.id) }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-eye-fill me-1"></i> View Details & History
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>-e 

===== templates/partials/_task_history_item.html =====
{# templates/partials/_task_history_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase G.2 #}
{#
    Reusable item for displaying a single task history entry.
    Expects a `history_entry` object (TaskHistory instance) in the context.
    - history_entry.changed_by (User object)
    - history_entry.timestamp
    - history_entry.action
    - history_entry.old_status
    - history_entry.new_status
    - history_entry.notes
#}
<li class="list-group-item task-history-entry py-2 px-3">
    <div class="d-flex w-100 justify-content-between">
        <small class="text-muted history-timestamp" title="{{ history_entry.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
            <i class="bi bi-clock-history me-1"></i>{{ history_entry.timestamp | humanize_time_diff }}
        </small>
        <small class="text-muted history-actor">
            by: {{ history_entry.changed_by.full_name or history_entry.changed_by.username if history_entry.changed_by else 'System' }}
        </small>
    </div>
    <p class="mb-1 history-action">
        <strong class="font-heading">{{ history_entry.action }}:</strong>
        {% if history_entry.old_status %}
            Status changed from <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-1">{{ history_entry.old_status }}</span>
            to <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-1">{{ history_entry.new_status }}</span>.
        {% else %}
            Status set to <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-1">{{ history_entry.new_status }}</span>.
        {% endif %}
    </p>
    {% if history_entry.notes %}
        <small class="d-block text-muted fst-italic history-notes ps-3 border-start border-2">
            <i class="bi bi-chat-left-quote me-1"></i> {{ history_entry.notes | nl2br | safe }}
        </small>
    {% endif %}
</li>-e 

===== templates/partials/_group_card_item.html =====
{% extends "layout/base.html" %}

{% block page_title %}My Social Groups{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-person-bounding-box me-2 text-primary"></i>My Social Groups
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {# Optional: Discover public groups link if feature exists #}
            {# <a href="{{ url_for('social_group_discover') }}" class="btn btn-sm btn-outline-info me-2">
                <i class="bi bi-compass-fill me-1"></i> Discover Groups
            </a> #}
            {% if current_user.role.name in ['hr_ceo', 'system_admin', 'teacher'] %} {# Role check for create button #}
            <a href="{{ url_for('create_social_group') }}" class="btn btn-sm btn-success">
                <i class="bi bi-plus-circle-fill me-1"></i> Create New Group
            </a>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    {% include 'layout/_flash_messages.html' %}

    {% if my_groups and my_groups | length > 0 %}
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
            {% for group in my_groups %}
                {% include 'partials/_group_card_item.html' with {'group': group, 'current_user': current_user, 'is_member': True, 'is_owner': (group.owner_id == current_user.id)} %}
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center text-muted p-5 content-placeholder">
            <i class="bi bi-people display-3 mb-3"></i>
            <h4 class="font-heading">No Groups Joined Yet</h4>
            <p>You are not a member of any social groups.
            {% if current_user.role.name in ['hr_ceo', 'system_admin', 'teacher'] %}
                You can <a href="{{ url_for('create_social_group') }}">create a new group</a>.
            {% else %}
                Ask a group owner or admin to add you to a group.
            {% endif %}
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block body_scripts %}
<script src="{{ url_for('static', filename='js/social.js') }}?v={{ range(1, 100000) | random }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // JS for handling group join/leave buttons if they are AJAX-based
        // For now, list.html mainly links to view_social_group
        console.log('My Groups page JS loaded.');
    });
</script>
{% endblock %}-e 

===== templates/partials/_chat_message_item.html =====
{# templates/partials/_chat_message_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase D.2 #}
{#
    Reusable item for displaying a single chat message.
    Expects a `message` object (Message instance) and `current_user_id` in the context.
    - message.sender (User object)
    - message.content
    - message.timestamp
#}

{% set is_sender = message.sender_id == current_user_id %}
{% set sender_name = message.sender.full_name or message.sender.username if message.sender else "Unknown User" %}
{% set sender_avatar = url_for('static', filename=(message.sender.profile_photo_url if message.sender and message.sender.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}

<div class="chat-message-wrapper d-flex mb-3 {% if is_sender %} justify-content-end {% else %} justify-content-start {% endif %}">
    <div class="chat-message d-flex flex-column {% if is_sender %} sent align-items-end {% else %} received align-items-start {% endif %}" style="max-width: 75%;">
        <div class="d-flex align-items-end {% if is_sender %} flex-row-reverse {% endif %}">
            {% if not is_sender %}
            <img src="{{ sender_avatar }}" alt="{{ sender_name }}" class="rounded-circle me-2 shadow-sm" style="width: 30px; height: 30px; object-fit: cover;">
            {% endif %}
            <div class="message-bubble p-2 px-3 shadow-sm">
                <p class="mb-0 message-content">{{ message.content | safe }}</p> {# Use safe if content can contain simple HTML like line breaks #}
            </div>
        </div>
        <small class="message-timestamp text-muted mt-1 {% if is_sender %} me-1 {% else %} ms-1 {% endif %}"
               title="{{ message.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
            {% if not is_sender %}
                <span class="fw-medium">{{ sender_name.split(' ')[0] }}</span> •
            {% endif %}
            {{ message.timestamp | humanize_time_diff }}
        </small>
    </div>
</div>-e 

===== templates/partials/_asset_card.html =====
{# templates/partials/_asset_card.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase C.1 #}
{#
    Reusable card for displaying a single asset.
    Expects an `asset` object in the context.
    The parent template should wrap this in Bootstrap column classes (e.g., col-md-4, col-lg-3).
#}
<div class="card asset-card h-100 shadow-sm">
    {# Placeholder for Asset Image - Future enhancement #}
    <div class="asset-card-img-placeholder bg-light-subtle text-center py-4 border-bottom">
        <i class="bi {{ asset.category.icon_class if asset.category and asset.category.icon_class else 'bi-box-seam' }} display-4 text-muted"></i>
        {# Fallback if category has no icon_class or category is None.
           `asset.category.icon_class` is a hypothetical field you might add to AssetCategory model.
           For now, a generic icon is used.
        #}
    </div>
    {# <img src="{{ asset.image_url or url_for('static', filename='img/placeholders/asset_default.png') }}" class="card-img-top" alt="{{ asset.name }}"> #}

    <div class="card-body d-flex flex-column">
        <h5 class="card-title font-heading mb-1">
            <a href="{{ url_for('edit_asset', asset_id=asset.id) if current_user.role.name in ['hr_ceo', 'system_admin'] else '#' }}"
               class="text-decoration-nonestretched-link stretched-link {% if not (current_user.role.name in ['hr_ceo', 'system_admin']) %} pe-none {% endif %}">
                {{ asset.name | truncate(50) }}
            </a>
        </h5>
        <small class="text-muted mb-2">ID: {{ asset.id }} | Qty: {{ asset.quantity }}</small>

        <p class="card-text text-muted small mb-2 flex-grow-1">
            {{ asset.description | truncate(80) if asset.description else 'No description available.' }}
        </p>

        <div class="mb-2">
            {% if asset.status == 'Available' %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-check-circle-fill me-1"></i>{{ asset.status }}
                </span>
            {% elif asset.status == 'Pending Review' %}
                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-hourglass-split me-1"></i>{{ asset.status }}
                </span>
            {% elif asset.status == 'CheckedOut' %}
                 <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-arrow-up-right-circle-fill me-1"></i>Checked Out
                </span>
            {% elif asset.status == 'Under Maintenance' or asset.status == 'Needs Repair' %}
                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-tools me-1"></i>{{ asset.status }}
                </span>
            {% elif asset.status == 'Retired' or asset.status == 'Lost' %}
                 <span class="badge bg-dark-subtle text-dark-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-slash-circle-fill me-1"></i>{{ asset.status }}
                </span>
            {% else %}
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-question-circle-fill me-1"></i>{{ asset.status | default('Unknown') }}
                </span>
            {% endif %}

            <span class="badge bg-light-subtle text-dark-emphasis border rounded-pill px-2 py-1 fs-08rem">
                <i class="bi bi-tag-fill me-1"></i>{{ asset.category.name if asset.category else 'Uncategorized' }}
            </span>
        </div>
    </div>

    <div class="card-footer bg-light-subtle d-flex justify-content-between align-items-center">
        <small class="text-muted">
            Lab: {{ asset.lab.name if asset.lab else (asset.location_description[:15] + '...' if asset.location_description and asset.location_description | length > 15 else asset.location_description or 'N/A') }}
        </small>
        <div class="asset-actions">
            {% if current_user.role.name in ['hr_ceo', 'system_admin'] %}
                <a href="{{ url_for('edit_asset', asset_id=asset.id) }}" class="btn btn-sm btn-outline-primary p-1" title="Edit Asset">
                    <i class="bi bi-pencil-square fs-6"></i>
                </a>
            {% endif %}
            {# All permitted roles should be able to report an asset from here #}
            {% if current_user.role.name in ['hr_ceo', 'system_admin', 'teacher', 'librarian', 'student', 'talent_club'] %}
                <a href="{{ url_for('report_asset_specific', asset_id=asset.id) }}" class="btn btn-sm btn-outline-warning p-1 ms-1" title="Report Issue">
                    <i class="bi bi-exclamation-triangle-fill fs-6"></i>
                </a>
            {% endif %}
        </div>
    </div>
</div>-e 

===== templates/partials/_tc_club_card_item.html =====
{# templates/partials/_tc_club_card_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase F.1 #}
{#
    Reusable card for displaying a single Talent Club instance.
    Expects a `club` object (TalentClub instance) and `current_user` in the context.
    Optionally, `is_member_of_club` and `is_following_club` booleans for button states.
#}

{% set club_avatar = url_for('static', filename=(club.profile_photo_url if club.profile_photo_url else 'img/placeholders/tc_club_default_avatar.png')) %}
{% set member_count = club.memberships.filter_by(is_active=True).count() if club.memberships else 0 %}
{% set follower_count = club.follows.count() if club.follows else 0 %}
{% set total_engagement = member_count + follower_count %}

<div class="col"> {# Bootstrap column class to be applied by parent template #}
    <div class="card talent-club-card h-100 shadow-sm">
        <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="text-decoration-none d-block tc-club-card-image-link">
            <div class="tc-club-card-img-placeholder bg-primary-subtle text-center d-flex align-items-center justify-content-center" style="height: 140px;">
                {% if club.profile_photo_url %}
                    <img src="{{ club_avatar }}" alt="{{ club.name }} Cover" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    {# Using club.social_category.icon_class is hypothetical, requires adding this field to SocialCategory model #}
                    <i class="bi {{ club.social_category.icon_class if club.social_category and club.social_category.icon_class else 'bi-trophy-fill' }} display-2 text-primary opacity-75"></i>
                {% endif %}
            </div>
        </a>
        <div class="card-body d-flex flex-column">
            <h5 class="card-title font-heading mb-1">
                <a href="{{ url_for('view_talent_club_profile', club_id=club.id) }}" class="text-decoration-none stretched-link text-dark">
                    {{ club.name | truncate(40) }}
                </a>
            </h5>
            <div class="mb-2">
                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1 me-1 fs-08rem">
                    <i class="bi bi-award-fill me-1"></i>Level {{ club.level | default(1) }}
                </span>
                {% if club.warning_count > 0 %}
                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1 fs-08rem">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ club.warning_count }} Warning{{ 's' if club.warning_count != 1 else '' }}
                </span>
                {% endif %}
            </div>
            <small class="text-muted mb-2">
                <i class="bi bi-tag-fill me-1"></i>{{ club.social_category.name if club.social_category else 'Uncategorized' }}
                <span class="mx-1">•</span>
                <i class="bi bi-people-fill me-1"></i>{{ total_engagement }} Engaged
            </small>
            <p class="card-text text-muted small mb-2 flex-grow-1">
                {{ club.description | truncate(70) if club.description else 'No description available.' }}
            </p>
        </div>
        <div class="card-footer bg-light-subtle d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Lead: {{ club.owner.full_name or club.owner.username if club.owner else 'N/A' }}
            </small>
            <div class="tc-club-actions">
                {% if is_member_of_club %}
                     <button class="btn btn-sm btn-outline-secondary tc-action-btn" data-action="leave_club" data-club-id="{{ club.id }}" title="You are a member">
                        <i class="bi bi-person-check-fill me-1"></i> Member
                    </button>
                {% elif is_following_club %}
                    <button class="btn btn-sm btn-info tc-action-btn" data-action="unfollow_club" data-club-id="{{ club.id }}">
                        <i class="bi bi-bell-slash-fill me-1"></i> Following
                    </button>
                {% else %}
                     <button class="btn btn-sm btn-primary tc-action-btn" data-action="follow_club" data-club-id="{{ club.id }}">
                        <i class="bi bi-bell-fill me-1"></i> Follow
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>-e 

===== templates/partials/report_asset_specific.html =====
{% extends "layout/base.html" %}

{% block page_title %}Report Issue: {{ asset.name }}{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Report Issue for Asset
        </h1>
        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Cancel & Go Back
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm">
                <div class="card-header bg-warning-subtle text-warning-emphasis">
                    <h5 class="mb-0 font-heading">Reporting Issue for: <strong>{{ asset.name }}</strong> (ID: {{ asset.id }})</h5>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted">
                        Please provide details about the damage or issue you observed with this asset.
                        Your report will be reviewed by an administrator.
                    </p>

                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('report_asset_specific', asset_id=asset.id) }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        <div class="mb-3">
                            {{ form.damage_description.label(class="form-label fw-medium") }}
                            {{ form.damage_description(class="form-control" + (" is-invalid" if form.damage_description.errors else ""), rows="5", placeholder="Describe the issue in detail...") }}
                            {% if form.damage_description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.damage_description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.date_of_damage.label(class="form-label fw-medium") }}
                                {{ form.date_of_damage(class="form-control flatpickr-date" + (" is-invalid" if form.date_of_damage.errors else ""), placeholder="YYYY-MM-DD (Optional)") }}
                                {% if form.date_of_damage.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.date_of_damage.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.quantity_damaged.label(class="form-label fw-medium") }}
                                {{ form.quantity_damaged(class="form-control" + (" is-invalid" if form.quantity_damaged.errors else ""), type="number", min="1") }}
                                 <small class="form-text text-muted">Quantity of this specific asset affected.</small>
                                {% if form.quantity_damaged.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.quantity_damaged.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-warning px-4", value="Submit Report") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/partials/_global_post_item.html =====
{# templates/partials/_global_post_item.html (Revised for Global Posts & Client-Side Rendering) #}
{#
    This partial is primarily a TEMPLATE for JavaScript client-side rendering.
    The actual data will be passed as a JSON object from the API.
    Context variables used here are examples of what the JS would populate.
    - post: The GlobalPost object (or a common structure if this becomes more generic).
            Expected: id, content, author (obj), timestamp, is_edited, file (obj),
                      like_count, comment_count, current_user_liked, share_url,
                      allow_comments
    - current_user: The logged-in user (for permissions).
    - post_type: 'global' (can be extended if this partial is reused).
#}
{% set post_type = post_type | default('global') %}
{% set post_dom_id = post_type ~ '_post-' ~ post.id %}

<div class="card social-post-item mb-3 shadow-sm" id="{{ post_dom_id }}"
     data-post-id="{{ post.id }}" data-post-type="{{ post_type }}">
    <div class="card-body">
        <div class="d-flex align-items-center mb-3">
            <a href="{{ url_for('user_profile_view', user_id=post.author.id) if post.author else '#' }}" class="flex-shrink-0">
                <img src="{{ post.author.profile_photo_url or url_for('static', filename='img/placeholders/user_avatar_default.png') }}"
                     alt="{{ post.author.full_name or post.author.username if post.author else 'User' }}'s avatar" class="rounded-circle me-3" width="48" height="48" style="object-fit: cover;">
            </a>
            <div class="flex-grow-1">
                <a href="{{ url_for('user_profile_view', user_id=post.author.id) if post.author else '#' }}" class="fw-bold text-dark text-decoration-none font-heading">{{ post.author.full_name or post.author.username if post.author else "Unknown Author" }}</a>
                <div class="text-muted small">
                    <i class="bi bi-clock"></i> 
                    <span class="post-timestamp" title="{{ post.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
                        {{ post.timestamp | humanize_time_diff }}
                    </span>
                    {% if post.is_edited %} <span class="fst-italic ms-1">(edited)</span>{% endif %}
                </div>
            </div>
            {# More Options Dropdown for Edit/Delete #}
            {% if current_user.is_authenticated and ((post.author and post.author.id == current_user.id) or (current_user.role and current_user.role.name in ['system_admin', 'hr_ceo'])) %}
            <div class="dropdown">
                <button class="btn btn-sm btn-light border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Post options">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    {% if post.author and post.author.id == current_user.id %}
                    <li><a class="dropdown-item edit-post-btn" href="#" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}"><i class="bi bi-pencil me-2"></i>Edit Post</a></li>
                    {% endif %}
                    <li>
                        <button class="dropdown-item text-danger delete-post-btn" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}">
                            <i class="bi bi-trash me-2"></i>Delete Post
                        </button>
                    </li>
                </ul>
            </div>
            {% endif %}
        </div>

        {% if post.content %}
        <div class="post-content-text mb-3">
            {{ post.content | nl2br | safe }}
        </div>
        {% endif %}

        {% if post.file %}
            <div class="post-attachment mb-3">
                {# Logic to display image, video, or generic file card #}
                {% if post.file.mimetype and post.file.mimetype.startswith('image/') %}
                    <a href="{{ post.file.download_url }}" data-bs-toggle="modal" data-bs-target="#viewFileModal" 
                       data-file-url="{{ post.file.download_url }}" data-file-mimetype="{{ post.file.mimetype }}" 
                       data-file-name="{{ post.file.original_filename }}">
                        <img src="{{ post.file.download_url }}" class="img-fluid rounded border" alt="Attachment: {{ post.file.original_filename }}" style="max-height: 450px; object-fit: contain; cursor: pointer;">
                    </a>
                {% elif post.file.mimetype and post.file.mimetype.startswith('video/') %}
                    <video controls class="img-fluid rounded border" style="max-height: 450px; width:100%;">
                        <source src="{{ post.file.download_url }}" type="{{ post.file.mimetype }}">
                        Your browser does not support the video tag.
                    </video>
                {% else %}
                    <div class="d-flex align-items-center p-2 border rounded-3 bg-light-subtle">
                        <i class="bi bi-file-earmark-text-fill fs-2 me-2 text-secondary"></i>
                        <div class="flex-grow-1">
                            <a href="{{ post.file.download_url }}" class="fw-semibold text-decoration-none stretched-link" target="_blank" download="{{ post.file.original_filename }}">
                                {{ post.file.original_filename }}
                            </a>
                            <div class="text-muted small">
                                {{ (post.file.size / (1024*1024)) | round(2) if post.file.size > 1024*1024 else (post.file.size / 1024) | round(1) }} 
                                {{ 'MB' if post.file.size > 1024*1024 else 'KB' }}
                                {% if post.file.mimetype %} - {{ post.file.mimetype }}{% endif %}
                            </div>
                        </div>
                        <a href="{{ post.file.download_url }}" class="btn btn-sm btn-outline-secondary ms-2" download="{{ post.file.original_filename }}" aria-label="Download file">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <div class="post-actions d-flex justify-content-start align-items-center gap-2 border-top pt-2 mt-2">
            {% set user_liked = post.current_user_liked | default(false) %}
            <button class="btn btn-subtle btn-sm reaction-btn like-post-btn {{ 'active' if user_liked }}" 
                    data-post-id="{{ post.id }}" data-post-type="{{ post_type }}" aria-pressed="{{ user_liked|lower }}">
                <i class="bi {{ 'bi-heart-fill text-danger' if user_liked else 'bi-heart' }}"></i> 
                <span class="like-text">{{ 'Liked' if user_liked else 'Like' }}</span>
                (<span class="like-count">{{ post.like_count | default(0) }}</span>)
            </button>
            
            {% if post.allow_comments | default(true) %}
            <button class="btn btn-subtle btn-sm comment-toggle-btn" data-bs-toggle="collapse" href="#commentsCollapse-{{ post_dom_id }}" role="button" aria-expanded="false" aria-controls="commentsCollapse-{{ post_dom_id }}">
                <i class="bi bi-chat-dots"></i> Comment 
                (<span class="comment-count">{{ post.comment_count | default(0) }}</span>)
            </button>
            {% endif %}

            <button class="btn btn-subtle btn-sm share-post-btn" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}" data-share-url="{{ post.share_url }}">
                <i class="bi bi-share"></i> Share
            </button>
            <button class="btn btn-subtle btn-sm save-item-btn" data-item-id="{{ post.id }}" data-item-type="{{ post_type }}">
                {# JS will toggle icon and text #}
                <i class="bi bi-bookmark"></i> <span class="save-text">Save</span>
            </button>
        </div>
    </div>

    {% if post.allow_comments | default(true) %}
    <div class="collapse comments-section-wrapper" id="commentsCollapse-{{ post_dom_id }}">
        <div class="card-footer bg-light-subtle p-2 comments-section" id="comments-for-{{ post_dom_id }}">
            <div class="text-center py-3 comments-loading-placeholder d-none"> {# Initially hidden #}
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Loading comments...</span>
                </div>
            </div>
            <div class="comments-list" id="comments-list-{{ post_dom_id }}">
                {# Comments will be loaded here by JS #}
            </div>
            <div class="load-more-comments-container text-center my-2 d-none">
                 <button class="btn btn-link btn-sm load-more-comments-btn" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}">Load more comments</button>
            </div>

            {% if current_user.is_authenticated %} {# Only show comment form if user is logged in #}
                {% set comment_form_instance = get_comment_form() %}
                {% with 
                    form = comment_form_instance,
                    submit_url = url_for('create_global_comment', post_id=post.id), {# For Global Posts #}
                    placeholder_text = "Write a thoughtful comment...",
                    submit_button_text = "Reply",
                    is_comment_form = True,
                    form_id = "commentForm-" ~ post_dom_id,
                    textarea_id = "commentTextarea-" ~ post_dom_id,
                    allow_file_upload = False {# Comments typically don't have files #}
                %}
                    {% include "partials/_social_content_form.html" %}
                {% endwith %}
            {% else %}
                <p class="text-muted small text-center mt-2">
                    <a href="{{ url_for('login', next=request.url) }}">Log in</a> to comment.
                </p>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>-e 

===== templates/partials/_book_checkout_item.html =====
{# templates/partials/_book_checkout_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase C.4 #}
{#
    Reusable item for displaying a book checkout record.
    Expects a `checkout` object (BookCheckout instance) in the context.
    - checkout.asset (the book Asset object)
    - checkout.user (the User who borrowed the book)
#}
<div class="list-group-item list-group-item-action flex-column align-items-start book-checkout-item py-3 px-3 mb-2 shadow-sm border rounded
    {% if not checkout.returned and checkout.due_date < now.date() %} border-danger-subtle border-start-danger border-start-3 {% elif not checkout.returned and (checkout.due_date - now.date()).days <= 2 %} border-warning-subtle border-start-warning border-start-3 {% elif checkout.returned %} border-success-subtle {% else %} border-light-subtle {% endif %}">
    <div class="d-flex w-100 justify-content-between mb-2">
        <h6 class="mb-1 font-heading">
            <i class="bi {{ 'bi-journal-bookmark-fill text-primary' if checkout.asset else 'bi-question-diamond-fill text-muted' }} me-2"></i>
            {{ checkout.asset.name | truncate(40) if checkout.asset else 'Unknown Book' }}
            <small class="text-muted fw-normal">(ID: {{ checkout.asset.id if checkout.asset else 'N/A' }})</small>
        </h6>
        <small class="text-muted" title="Checkout ID: {{ checkout.id }}">
            Checked Out: {{ checkout.checkout_date | dateformat }}
        </small>
    </div>

    <div class="row gx-3 gy-1 small align-items-center mb-2">
        <div class="col-md-auto">
            <strong class="text-dark">Borrower:</strong>
            <a href="{{ url_for('librarian_student_profile', user_id=checkout.user.id) if current_user.role.name == 'librarian' else '#' }}"
               class="text-decoration-none {% if current_user.role.name != 'librarian' %} pe-none text-dark {% endif %}">
                {{ checkout.user.full_name or checkout.user.username if checkout.user else 'N/A' }}
            </a>
            {% if checkout.user and checkout.user.grade and checkout.user.section %}
                <span class="text-muted"> (G:{{ checkout.user.grade }}-S:{{ checkout.user.section }})</span>
            {% endif %}
        </div>
        <div class="col-md-auto">
            <strong class="text-dark">Due Date:</strong>
            <span class="{{ 'text-danger fw-bold' if not checkout.returned and checkout.due_date < now.date() else ('text-warning fw-medium' if not checkout.returned and (checkout.due_date - now.date()).days <= 2 else 'text-muted') }}">
                {{ checkout.due_date | dateformat }}
            </span>
        </div>
        <div class="col-md-auto">
            <strong class="text-dark">Status:</strong>
            {% if checkout.returned %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">
                    <i class="bi bi-check-lg me-1"></i>Returned on {{ checkout.return_date | dateformat }}
                </span>
            {% elif checkout.due_date < now.date() %}
                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">
                    <i class="bi bi-hourglass-split me-1"></i>Overdue
                </span>
            {% else %}
                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">
                    <i class="bi bi-clock-fill me-1"></i>Checked Out
                </span>
            {% endif %}
        </div>
    </div>

    {# Action button for Librarian to mark as returned #}
    {% if current_user.role.name == 'librarian' and not checkout.returned %}
        <div class="mt-2 text-end">
            <form action="{{ url_for('return_book', checkout_id=checkout.id) }}" method="POST" class="d-inline">
                {{ csrf_token() if csrf_token else '' }}
                <button type="submit" class="btn btn-sm btn-success">
                    <i class="bi bi-check2-square me-1"></i> Mark as Returned
                </button>
            </form>
        </div>
    {% endif %}
</div>-e 

===== templates/partials/_notification_item.html =====
{# templates/partials/_notification_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase D.1 #}
{#
    Reusable item for displaying a single notification.
    Expects a `notification` object in the context.
    Can be used in dropdowns or full notification lists.
    - notification.sender (User object)
    - notification.content
    - notification.timestamp
    - notification.is_read (boolean)
    - notification.link_url (optional)
    - notification.notification_type (optional, for specific icons/styling)
#}

{% set item_class = "list-group-item-light" if notification.is_read else "list-group-item-primary bg-primary-subtle border-primary-subtle" %}
{% set icon_class = 'bi-envelope-fill' %} {# Default icon #}
{% set icon_color_class = 'text-primary' %}

{# Determine icon based on notification_type #}
{% if notification.notification_type == 'chat' %}
    {% set icon_class = 'bi-chat-dots-fill' %}
    {% set icon_color_class = 'text-success' %}
{% elif notification.notification_type == 'task_assigned' or notification.notification_type == 'task_status_update' or notification.notification_type == 'task_review_result' %}
    {% set icon_class = 'bi-list-task' %}
    {% set icon_color_class = 'text-info' %}
{% elif notification.notification_type == 'request_submitted' or notification.notification_type == 'request_status_update' or notification.notification_type == 'request_forwarded' %}
    {% set icon_class = 'bi-file-earmark-medical-fill' %}
    {% set icon_color_class = 'text-warning' %}
{% elif notification.notification_type and notification.notification_type.startswith('tc_') %}
    {% set icon_class = 'bi-trophy-fill' %}
    {% set icon_color_class = 'text-danger' %}
{% elif notification.notification_type == 'asset_new' or notification.notification_type == 'asset_report' or notification.notification_type == 'asset_status_change' %}
    {% set icon_class = 'bi-archive-fill' %}
    {% set icon_color_class = 'text-secondary' %}
{% endif %}

<a href="{{ notification.link_url if notification.link_url else '#' }}"
   class="list-group-item list-group-item-action notification-item {{ item_class }} {% if not notification.is_read %} unread-notification {% endif %}"
   data-notification-id="{{ notification.id }}"
   aria-current="{{ 'true' if not notification.is_read else 'false' }}">
    <div class="d-flex w-100">
        <div class="notification-icon me-3 pt-1">
            <span class="badge bg-{{ icon_color_class.split('-')[-1] if icon_color_class else 'primary' }}-subtle p-2 rounded-circle">
                 <i class="bi {{ icon_class }} fs-5 {{ icon_color_class }}"></i>
            </span>
        </div>
        <div class="notification-content flex-grow-1">
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1 notification-title font-heading">
                    {% if notification.sender %}
                        From: {{ notification.sender.full_name or notification.sender.username }}
                    {% else %}
                        System Notification
                    {% endif %}
                </h6>
                <small class="text-muted notification-timestamp" title="{{ notification.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
                    {{ notification.timestamp | humanize_time_diff }} {# Requires a custom filter or JS formatting #}
                </small>
            </div>
            <p class="mb-1 notification-text text-dark-emphasis">
                {{ notification.content | truncate(150, True) }}
            </p>
            {% if not notification.is_read %}
                <small class="text-primary fw-bold">New</small>
            {% endif %}
        </div>
        {# Optional: Action button within the notification item itself (e.g., "Mark as Read" if not auto-marked on view) #}
        {# {% if not notification.is_read %}
        <button class="btn btn-sm btn-outline-secondary mark-notification-read-btn ms-2 align-self-start" data-notification-id="{{ notification.id }}">
            <i class="bi bi-check2-square"></i>
        </button>
        {% endif %} #}
    </div>
</a>-e 

===== templates/partials/_dashboard_stat_card.html =====
{# templates/partials/_dashboard_stat_card.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase B.0 #}
{#
    Reusable dashboard statistic card.
    Expects the following variables to be passed in the context:
    - card_title: (String) The title/label for the statistic (e.g., "Total Students")
    - card_value: (String or Number) The statistic value to display.
    - card_icon: (String) Bootstrap Icon class (e.g., "bi-people-fill").
    - card_color_class: (String, optional) Bootstrap text color class for the icon (e.g., "text-primary", "text-success"). Defaults to "text-primary".
    - card_url: (String, optional) URL for the "View Details" link.
    - card_url_text: (String, optional) Text for the "View Details" link (e.g., "Manage Students"). Defaults to "View Details".
    - card_extra_class: (String, optional) Extra CSS classes for the card.
    - card_id: (String, optional) ID for the card element.
#}
{% set color_class = card_color_class | default('text-primary') %}
{% set url_text = card_url_text | default('View Details') %}

<div class="col"> {# Bootstrap column class should be applied by the parent template #}
    <div class="card dashboard-stat-card h-100 shadow-sm {{ card_extra_class | default('') }}" {% if card_id %}id="{{ card_id }}"{% endif %}>
        <div class="card-body d-flex align-items-center">
            <div class="stat-icon display-4 me-3 {{ color_class }}">
                <i class="bi {{ card_icon | default('bi-bar-chart-line-fill') }}"></i>
            </div>
            <div class="stat-content">
                <h6 class="card-subtitle mb-1 text-muted text-uppercase font-body" style="font-size: 0.8rem;">{{ card_title | default('Statistic') }}</h6>
                <p class="card-text display-6 fw-bold mb-0 font-heading">{{ card_value | default('N/A') }}</p>
            </div>
        </div>
        {% if card_url %}
        <a href="{{ card_url }}" class="card-footer text-decoration-none text-muted bg-light-subtle hover-bg-light">
            <small>{{ url_text }} <i class="bi bi-arrow-right-short ms-1"></i></small>
        </a>
        {% else %}
        {# Optionally, a non-clickable footer or no footer if no URL #}
        {# <div class="card-footer bg-light-subtle text-muted">
            <small> </small> {# Placeholder for consistent height if needed #}
        {# </div> #}
        {% endif %}
    </div>
</div>-e 

===== templates/partials/_request_list_item.html =====
{# templates/partials/_request_list_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase H.1 #}
{#
    Reusable item for displaying a request summary in a list.
    Expects a `request_obj` (Request instance) in the context.
    - request_obj.title, .request_type, .urgency, .status, .last_updated_at, .current_handler
#}

{% set status_badge_class = 'bg-secondary-subtle text-secondary-emphasis' %}
{% if request_obj.status == 'Pending' %}
    {% set status_badge_class = 'bg-warning-subtle text-warning-emphasis' %}
{% elif request_obj.status == 'Approved' or request_obj.status == 'On Progress' %}
    {% set status_badge_class = 'bg-primary-subtle text-primary-emphasis' %}
{% elif request_obj.status == 'Resolved' %}
    {% set status_badge_class = 'bg-success-subtle text-success-emphasis' %}
{% elif request_obj.status == 'Denied' %}
    {% set status_badge_class = 'bg-danger-subtle text-danger-emphasis' %}
{% endif %}

<a href="{{ url_for('view_request_detail', request_id=request_obj.id) }}" class="list-group-item list-group-item-action request-list-item flex-column align-items-start py-3 px-3 mb-2 shadow-sm border rounded
    {% if request_obj.status == 'Pending' and request_obj.current_handler_id == current_user.id %} border-warning-subtle border-start-warning border-start-3 {# Highlight for handler's inbox #}
    {% elif request_obj.status == 'Denied' %} border-danger-subtle border-start-danger border-start-3
    {% elif request_obj.status == 'Resolved' %} border-success-subtle border-start-success border-start-3
    {% else %} border-light-subtle {% endif %}">

    <div class="d-flex w-100 justify-content-between mb-1">
        <h6 class="mb-1 font-heading request-title">
            <i class="bi bi-file-earmark-text-fill me-1 {{ status_badge_class.split(' ')[1] | replace('text-', 'text-') }}"></i>
            {{ request_obj.title | truncate(70) }} <small class="text-muted fw-normal">(ID: {{ request_obj.id }})</small>
        </h6>
        <small class="text-muted request-last-updated" title="Last Updated">
             <i class="bi bi-clock-history me-1"></i>{{ request_obj.last_updated_at | humanize_time_diff }}
        </small>
    </div>

    <div class="d-flex w-100 justify-content-between align-items-center small mb-1">
        <div class="request-meta">
            <span class="me-3" title="Type">
                <strong>Type:</strong>
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">{{ request_obj.request_type }}</span>
            </span>
            <span class="me-3" title="Urgency">
                <strong>Urgency:</strong>
                {% if request_obj.urgency == 'Critical' %}<span class="badge bg-danger text-white rounded-pill px-2">{{ request_obj.urgency }}</span>
                {% elif request_obj.urgency == 'High' %}<span class="badge bg-warning text-dark rounded-pill px-2">{{ request_obj.urgency }}</span>
                {% elif request_obj.urgency == 'Medium' %}<span class="badge bg-info text-white rounded-pill px-2">{{ request_obj.urgency }}</span>
                {% else %}<span class="badge bg-light text-dark border rounded-pill px-2">{{ request_obj.urgency }}</span>
                {% endif %}
            </span>
            <span title="Current Tier">
                <strong>Tier:</strong>
                <span class="badge bg-dark-subtle text-dark-emphasis rounded-pill px-2">{{ request_obj.tier }}</span>
            </span>
        </div>
        <div class="request-status">
            <strong>Status:</strong>
            <span class="badge fs-08rem px-2 py-1 rounded-pill {{ status_badge_class }}">
                {{ request_obj.status }}
            </span>
        </div>
    </div>

    <p class="mb-1 text-muted small request-description d-none d-md-block">
        {{ request_obj.description | truncate(150) }}
    </p>

    <div class="mt-1 small text-muted">
        {% if request_obj.status == 'Pending' and request_obj.current_handler %}
            Awaiting review by: <strong>{{ request_obj.current_handler.full_name or request_obj.current_handler.username }}</strong>
            ({{ request_obj.current_handler.role.name.replace('_',' ') | title if request_obj.current_handler.role else 'N/A' }})
        {% elif request_obj.status == 'On Progress' and request_obj.current_handler %}
            In progress with: <strong>{{ request_obj.current_handler.full_name or request_obj.current_handler.username }}</strong>
        {% elif request_obj.requester_id == current_user.id and request_obj.status not in ['Resolved', 'Denied'] %}
            <span class="text-primary-emphasis">You submitted this request.</span>
        {% endif %}
    </div>
</a>-e 

===== templates/partials/_tc_feed_post_item.html =====
{# templates/partials/_tc_feed_post_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase F.2 #}
{#
    Reusable item for displaying a single Talent Club feed post.
    Expects a `post` object (TalentClubFeedPost instance) and `current_user` in the context.
    Also expects `club` (the TalentClub instance the feed belongs to).
    - post.author (User object)
    - post.content (text content)
    - post.file (File object, optional)
    - post.timestamp
    - post.id
    - post.comments (relationship to TalentClubFeedComment)
    - post.reactions (relationship to TalentClubFeedReaction)
    - club.feed (TalentClubFeed object, to check allow_comments/reactions settings)
#}

{% set author_name = post.author.full_name or post.author.username if post.author else "Anonymous" %}
{% set author_avatar = url_for('static', filename=(post.author.profile_photo_url if post.author and post.author.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}

<div class="card shadow-sm tc-feed-post-item mb-4" id="tc_feed_post-{{ post.id }}">
    <div class="card-header bg-transparent border-bottom-0 pt-3 pb-2">
        <div class="d-flex align-items-center">
            <a href="#" class="text-decoration-none"> {# Link to author's TC profile or general profile #}
                <img src="{{ author_avatar }}" alt="{{ author_name }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
            </a>
            <div>
                <a href="#" class="text-decoration-none">
                    <h6 class="mb-0 font-heading text-dark">{{ author_name }}</h6>
                </a>
                <small class="text-muted" title="{{ post.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
                    {{ post.timestamp | humanize_time_diff }}
                    {% if post.is_edited %} <span class="fst-italic">(edited)</span>{% endif %}
                </small>
            </div>
            {# Post Actions Dropdown (Edit, Delete - for author or club owner/admin) #}
            {% set user_is_post_author = post.author_id == current_user.id %}
            {% set user_is_club_owner_or_admin = (club and club.owner_id == current_user.id) or (current_user.get_tc_club_membership_role(club) == 'admin') %} {# get_tc_club_membership_role is hypothetical helper #}

            {% if user_is_post_author or user_is_club_owner_or_admin %}
            <div class="ms-auto">
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% if user_is_post_author %}
                        <li><a class="dropdown-item edit-tc-feed-post-btn" href="#" data-post-id="{{ post.id }}"><i class="bi bi-pencil-square me-2"></i>Edit Post</a></li>
                        {% endif %}
                        <li>
                            <button class="dropdown-item text-danger delete-tc-feed-post-btn" data-post-id="{{ post.id }}">
                                <i class="bi bi-trash-fill me-2"></i>Delete Post
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card-body pt-2">
        {% if post.content %}
            <p class="card-text post-content-text mb-2" id="tc-post-content-{{ post.id }}">{{ post.content | nl2br | safe }}</p>
        {% endif %}

        {% if post.file %}
            <div class="post-attachment mt-2 mb-2 p-2 border rounded bg-light-subtle">
                {# File display logic similar to _social_post_item.html #}
                {% if post.file.mimetype and post.file.mimetype.startswith('image/') %}
                    <a href="{{ url_for('download_social_file', file_id=post.file.id) }}" data-bs-toggle="lightbox" data-gallery="tc-post-{{post.id}}-gallery">
                        <img src="{{ url_for('download_social_file', file_id=post.file.id) }}" class="img-fluid rounded" alt="{{ post.file.original_filename }}" style="max-height: 400px;">
                    </a>
                {% elif post.file.mimetype and post.file.mimetype.startswith('video/') %}
                    <video controls class="img-fluid rounded" style="max-height: 400px;">
                        <source src="{{ url_for('download_social_file', file_id=post.file.id) }}" type="{{ post.file.mimetype }}">
                        Your browser does not support the video tag.
                    </video>
                {% elif post.file.mimetype and post.file.mimetype.startswith('audio/') %}
                     <audio controls class="w-100 mt-2">
                        <source src="{{ url_for('download_social_file', file_id=post.file.id) }}" type="{{ post.file.mimetype }}">
                        Your browser does not support the audio element.
                    </audio>
                {% else %}
                    <div class="d-flex align-items-center p-2">
                        <i class="bi bi-file-earmark-text-fill fs-2 text-secondary me-2"></i>
                        <div>
                            <a href="{{ url_for('download_social_file', file_id=post.file.id) }}" class="fw-medium text-decoration-none stretched-link" download="{{ post.file.original_filename }}">
                                {{ post.file.original_filename }}
                            </a>
                            <small class="d-block text-muted">({{ (post.file.size / 1024 / 1024) | round(2) if post.file.size else '0' }} MB)</small>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="card-footer bg-transparent pt-2 pb-2">
        <div class="d-flex justify-content-start align-items-center post-actions">
            {% if club.feed and club.feed.allow_reactions %}
                <button class="btn btn-sm btn-outline-secondary tc-reaction-btn me-2" data-post-id="{{ post.id }}" data-reaction-emoji="👍" title="Like">
                    <i class="bi bi-hand-thumbs-up"></i> <span class="reaction-count" data-emoji="👍">{{ post.reactions.filter_by(emoji="👍").count() }}</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary tc-reaction-btn me-2" data-post-id="{{ post.id }}" data-reaction-emoji="❤️" title="Love">
                    <i class="bi bi-heart"></i> <span class="reaction-count" data-emoji="❤️">{{ post.reactions.filter_by(emoji="❤️").count() }}</span>
                </button>
                {# Add more reaction buttons if desired #}
            {% endif %}

            {% if club.feed and club.feed.allow_comments %}
            <button class="btn btn-sm btn-outline-secondary comment-toggle-btn ms-auto" data-bs-toggle="collapse" href="#tcCommentsCollapse-{{ post.id }}" role="button" aria-expanded="false" aria-controls="tcCommentsCollapse-{{ post.id }}">
                <i class="bi bi-chat-square-text me-1"></i> Comments <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ post.comments | length if post.comments else 0 }}</span>
            </button>
            {% endif %}
        </div>
    </div>

    {# Collapsible Comments Section for TC Feed Posts #}
    {% if club.feed and club.feed.allow_comments %}
    <div class="collapse comments-section border-top" id="tcCommentsCollapse-{{ post.id }}">
        <div class="p-3">
            <div class="existing-comments mb-3" id="tc-comments-list-{{ post.id }}" style="max-height: 300px; overflow-y: auto;">
                {% if post.comments and post.comments | length > 0 %}
                    {% for comment in post.comments | sort(attribute='timestamp') %}
                        {# Reusing _social_comment_item.html, ensure it adapts or create _tc_comment_item.html #}
                        {% include 'partials/_social_comment_item.html' with {'comment': comment, 'current_user': current_user, 'post': post, 'context_type': 'tc_feed'} %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted small text-center no-comments-yet">No comments yet. Be the first!</p>
                {% endif %}
            </div>
            <form class="tc-comment-form" data-post-id="{{ post.id }}" method="POST"> {# Action handled by JS #}
                <div class="input-group">
                    <textarea class="form-control form-control-sm comment-input" name="content" rows="1" placeholder="Write a comment..." aria-label="Write a comment"></textarea>
                    <button class="btn btn-sm btn-primary tc-comment-submit-btn" type="submit">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>-e 

===== templates/partials/_social_content_form.html =====
{# templates/partials/_social_content_form.html (Revised for Flexibility) #}
{#
    Context:
    - form: WTForm instance (e.g., PostContentForm)
    - submit_url: URL for form submission
    - placeholder_text
    - submit_button_text
    - form_id: Unique ID for the form element
    - textarea_id: Unique ID for the textarea
    - file_input_name: Name attribute for the file input (must match WTForm field name)
    - is_comment_form: (Boolean) True if this is for a compact comment input
    - allow_file_upload: (Boolean, default True for posts, False for comments initially)
#}
{% set allow_file_upload = allow_file_upload if allow_file_upload is defined else (not is_comment_form if is_comment_form is defined else true) %}
{% set is_comment_form_flag = is_comment_form if is_comment_form is defined else false %}

<div class="social-content-form-card card {{ 'mb-2 border-0 shadow-none p-0' if is_comment_form_flag else 'mb-3 shadow-sm' }}">
    <div class="card-body {{ 'p-0' if is_comment_form_flag else ('p-3' if not is_comment_form_flag else '') }}">
        <form method="POST" action="{{ submit_url }}" id="{{ form_id }}" class="social-content-submission-form" enctype="multipart/form-data" data-form-type="{{ 'global_post_create' if not is_comment_form_flag else 'global_comment_create' }}">
            {{ form.hidden_tag() }} {# Includes CSRF token #}
            <div class="d-flex align-items-start">
                <div class="flex-shrink-0 me-2">
                    <img src="{{ current_user.profile_photo_url or url_for('static', filename='img/placeholders/user_avatar_default.png') }}" 
                         alt="{{ current_user.full_name or current_user.username }}'s avatar" 
                         class="rounded-circle" 
                         width="{{ '32' if is_comment_form_flag else '40' }}" 
                         height="{{ '32' if is_comment_form_flag else '40' }}"
                         style="object-fit: cover;">
                </div>
                <div class="flex-grow-1">
                    {{ form.content(class="form-control post-content-textarea", placeholder=placeholder_text, rows="1" if is_comment_form_flag else "2", "aria-label"=placeholder_text, id=textarea_id, autocomplete="off") }}
                    {% if form.content.errors %}
                        {% for error in form.content.errors %}
                            <div class="invalid-feedback d-block small mt-1">{{ error }}</div>
                        {% endfor %}
                    {% endif %}

                    {% if allow_file_upload and form.attached_file %}
                    <div class="mt-2 post-attachment-area">
                        {# Ensure the name attribute here matches your WTForm FileField name #}
                        {{ form.attached_file(class="filepond-input", name=file_input_name, 
                                               data_max_file_size="16MB", 
                                               data_accepted_file_types='["image/*", "video/*", "application/pdf", ".doc", ".docx", ".txt", ".xls", ".xlsx", ".ppt", ".pptx"]'
                                             ) }}
                        {% if form.attached_file.errors %}
                            {% for error in form.attached_file.errors %}
                                <div class="text-danger small mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-end align-items-center mt-2">
                        <button type="submit" class="btn btn-primary post-submit-btn {{ 'btn-sm' if is_comment_form_flag else '' }}">
                            <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true"></span>
                            {{ submit_button_text }}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>-e 

===== templates/partials/_contact_list_item.html =====
{# templates/partials/_contact_list_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase D.2 #}
{#
    Reusable item for displaying a contact in a list.
    Expects a `contact` object (User instance) and `current_user_id` in the context.
    Optionally `unread_count` for this contact.
#}
{% set contact_avatar = url_for('static', filename=(contact.profile_photo_url if contact.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
{% set target_url = url_for(target_route | default('universal_chat'), target_user_id=contact.id) %} {# target_route can be 'universal_chat' or 'send_notification_to_user' #}

<a href="{{ target_url }}"
   class="list-group-item list-group-item-action contact-list-item-clickable p-3">
    <div class="d-flex align-items-center">
        <div class="position-relative me-3">
            <img src="{{ contact_avatar }}" alt="{{ contact.full_name or contact.username }}" class="rounded-circle shadow-sm" style="width: 50px; height: 50px; object-fit: cover;">
            {# Online status indicator (placeholder logic) - Future enhancement #}
            {# {% if contact.is_online %}
            <span class="position-absolute bottom-0 end-0 p-1 bg-success border border-light rounded-circle" title="Online">
                <span class="visually-hidden">Online</span>
            </span>
            {% endif %} #}
        </div>
        <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0 font-heading contact-name">{{ contact.full_name or contact.username }}</h6>
                {# Placeholder for last message timestamp - Future enhancement #}
                {# <small class="text-muted contact-last-active">10m ago</small> #}
            </div>
            <small class="text-muted d-block contact-role">
                {{ contact.role.name.replace('_', ' ') | title if contact.role else 'N/A' }}
                {% if contact.grade and contact.section %} (G:{{ contact.grade }}-S:{{ contact.section }}){% endif %}
            </small>
            {# Placeholder for last message snippet - Future enhancement #}
            {# <p class="text-muted small mb-0 contact-last-message-snippet text-truncate">
                You: Ok, see you then!
            </p> #}
        </div>
        {% if unread_count and unread_count > 0 %}
            <span class="badge bg-danger rounded-pill ms-2">{{ unread_count }}</span>
        {% endif %}
         <i class="bi {{ 'bi-chat-dots-fill' if target_route == 'universal_chat' else 'bi-send-plus-fill' }} fs-4 text-primary opacity-50 ms-2 contact-action-icon"></i>
    </div>
</a>-e 

===== templates/partials/_dashboard_quick_links.html =====
{# templates/partials/_dashboard_quick_links.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase B.1 #}
{#
    Reusable dashboard quick links section.
    Expects `quick_links` in the context: a list of dictionaries, where each dict has:
    - 'url': (String) The URL for the link.
    - 'text': (String) The display text for the link.
    - 'icon': (String) Bootstrap Icon class (e.g., "bi-calendar-event").
    - 'color_class': (String, optional) Bootstrap text color class for the icon (e.g., "text-success").
#}
{% if quick_links and quick_links | length > 0 %}
<div class="card shadow-sm dashboard-quick-links-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-lightning-charge-fill me-2"></i>Quick Actions</h5>
    </div>
    <div class="list-group list-group-flush">
        {% for link in quick_links %}
            <a href="{{ link.url | default('#') }}" class="list-group-item list-group-item-action d-flex align-items-center py-3">
                <i class="bi {{ link.icon | default('bi-link-45deg') }} fs-5 me-3 {{ link.color_class | default('text-primary') }}" style="min-width: 24px;"></i>
                <span class="fw-medium">{{ link.text | default('Link') }}</span>
                <i class="bi bi-chevron-right ms-auto text-muted small"></i>
            </a>
        {% endfor %}
    </div>
</div>
{% else %}
<!-- Optional: Placeholder if no quick links are provided -->
<!-- <p class="text-muted">No quick actions available at this time.</p> -->
{% endif %}-e 

===== templates/partials/_channel_card_item.html =====
{# templates/partials/_channel_card_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase E.2 #}
{#
    Reusable card for displaying a single channel in a list or discovery view.
    Expects a `channel` object (Channel instance) and `current_user` in the context.
    Optionally, `is_subscribed` and `is_owner` booleans can be passed for button states.
#}

{% set channel_avatar = url_for('static', filename=(channel.profile_photo_url if channel.profile_photo_url else 'img/placeholders/channel_default_avatar.png')) %}
{% set subscriber_count = channel.subscribers.count() if channel.subscribers else 0 %} {# Efficiently get count #}

<div class="col"> {# Bootstrap column class to be applied by parent template #}
    <div class="card channel-card h-100 shadow-sm">
        <a href="{{ url_for('view_social_channel', channel_id=channel.id) }}" class="text-decoration-none d-block channel-card-image-link">
            <div class="channel-card-img-placeholder bg-primary-subtle text-center d-flex align-items-center justify-content-center" style="height: 120px;">
                {% if channel.profile_photo_url %}
                    <img src="{{ channel_avatar }}" alt="{{ channel.name }} Cover" class="img-fluid" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                    <i class="bi {{ channel.social_category.icon_class if channel.social_category and channel.social_category.icon_class else 'bi-broadcast' }} display-3 text-primary opacity-75"></i>
                {% endif %}
            </div>
        </a>
        <div class="card-body d-flex flex-column">
            <h5 class="card-title font-heading mb-1">
                <a href="{{ url_for('view_social_channel', channel_id=channel.id) }}" class="text-decoration-none stretched-link text-dark">
                    {{ channel.name | truncate(40) }}
                </a>
            </h5>
            <small class="text-muted mb-2">
                <i class="bi bi-tag-fill me-1"></i>{{ channel.social_category.name if channel.social_category else 'Uncategorized' }}
                <span class="mx-1">•</span>
                <i class="bi bi-people-fill me-1"></i>{{ subscriber_count }} Subscriber{{ 's' if subscriber_count != 1 else '' }}
            </small>
            <p class="card-text text-muted small mb-2 flex-grow-1">
                {{ channel.bio | truncate(70) if channel.bio else 'No description available.' }}
            </p>
            <small class="text-muted">Type: {{ channel.type | title }}</small>
        </div>
        <div class="card-footer bg-light-subtle d-flex justify-content-between align-items-center">
            <small class="text-muted">
                Owner: {{ channel.owner.full_name or channel.owner.username if channel.owner else 'N/A' }}
            </small>
            <div>
                {# Subscription button logic - depends on whether this card is in 'discover' or 'my_channels' #}
                {% if is_subscribed is defined %} {# Check if the variable is passed #}
                    {% if is_subscribed %}
                         <button class="btn btn-sm btn-outline-secondary channel-action-btn" data-action="unsubscribe" data-channel-id="{{ channel.id }}">
                            <i class="bi bi-bell-slash-fill me-1"></i> Unsubscribe
                        </button>
                    {% elif channel.type == 'public' %}
                        <button class="btn btn-sm btn-primary channel-action-btn" data-action="subscribe" data-channel-id="{{ channel.id }}">
                            <i class="bi bi-bell-fill me-1"></i> Subscribe
                        </button>
                    {% elif channel.type == 'private' %}
                         <button class="btn btn-sm btn-outline-secondary channel-action-btn" disabled title="Private Channel">
                            <i class="bi bi-lock-fill me-1"></i> Private
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>-e 

===== templates/partials/_dashboard_recent_activity.html =====
{# templates/partials/_dashboard_recent_activity.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase B.1 (Placeholder) #}
{#
    Reusable dashboard recent activity feed.
    Expects `recent_activities` in the context: a list of activity items.
    Each item could be a dictionary with keys like 'icon', 'text', 'timestamp', 'url'.
#}

<div class="card shadow-sm recent-activity-card">
    <div class="card-header">
        <h5 class="mb-0 font-heading"><i class="bi bi-clock-history me-2"></i>Recent Activity</h5>
    </div>
    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
        {% if recent_activities and recent_activities | length > 0 %}
            <ul class="list-unstyled">
                {% for activity in recent_activities %}
                    <li class="d-flex align-items-start mb-3 pb-3 border-bottom">
                        <div class="activity-icon me-3">
                            <span class="badge bg-{{ activity.badge_color | default('secondary') }} p-2 rounded-circle">
                                <i class="bi {{ activity.icon | default('bi-bell') }} fs-5 text-white"></i>
                            </span>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1 text-dark">{{ activity.text | safe }}</p> {# Use safe if text contains HTML like links #}
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>
                                {{ activity.timestamp | datetimeformat('%b %d, %Y %I:%M %p') if activity.timestamp else 'Just now' }}
                            </small>
                            {% if activity.url %}
                                <a href="{{ activity.url }}" class="ms-2 small text-decoration-none">View <i class="bi bi-arrow-up-right-square"></i></a>
                            {% endif %}
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="text-center text-muted p-3">
                <i class="bi bi-moon-stars fs-1 mb-2"></i>
                <p>No recent activity to display.</p>
            </div>
        {% endif %}
    </div>
    {% if recent_activities and recent_activities | length > 5 %} {# Example: Show 'View All' if more than 5 #}
    <a href="{{ url_for('view_notifications') }}" class="card-footer text-center text-decoration-none text-muted bg-light-subtle hover-bg-light">
        <small>View All Activity <i class="bi bi-arrow-right-short ms-1"></i></small>
    </a>
    {% endif %}
</div>

{# SCSS for .recent-activity-card can be added to style.scss #}-e 

===== templates/partials/_tc_proposal_item.html =====
{# templates/partials/_tc_proposal_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase F.3 #}
{#
    Reusable item for displaying a Talent Club proposal in a list.
    Expects a `proposal` object (TalentClubProposal instance) and `current_user`.
    Optionally `accepted_count` for this proposal.
#}

<div class="list-group-item list-group-item-action flex-column align-items-start tc-proposal-item py-3 px-3 mb-2 shadow-sm border rounded
    {% if proposal.status == 'pending_leader_review' %} border-info-subtle border-start-info border-start-3
    {% elif proposal.status == 'pending_members_accept' %} border-warning-subtle border-start-warning border-start-3
    {% elif proposal.status == 'accepted' %} border-success-subtle border-start-success border-start-3
    {% elif proposal.status == 'rejected' %} border-danger-subtle border-start-danger border-start-3
    {% else %} border-light-subtle {% endif %}">

    <div class="d-flex w-100 justify-content-between mb-2">
        <h6 class="mb-1 font-heading">
            <i class="bi {{ 'bi-lightbulb-fill text-primary' if proposal.status.startswith('pending') else ('bi-check-circle-fill text-success' if proposal.status == 'accepted' else 'bi-x-circle-fill text-danger') }} me-2"></i>
            Proposal: {{ proposal.name | truncate(50) }}
            {% if current_user.id == proposal.creator_id %}
                <a href="{{ url_for('view_tc_proposal', proposal_id=proposal.id) }}" class="btn btn-sm btn-outline-secondary p-0 px-1 ms-2" style="font-size: 0.7rem;">View/Edit</a>
            {% elif current_user.is_tc_leader %}
                 <a href="{{ url_for('review_tc_proposal', proposal_id=proposal.id) }}" class="btn btn-sm btn-outline-primary p-0 px-1 ms-2" style="font-size: 0.7rem;">Review</a>
            {% endif %}
        </h6>
        <small class="text-muted" title="{{ proposal.created_at | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
            {{ proposal.created_at | humanize_time_diff }}
        </small>
    </div>

    <p class="mb-2 text-muted- GGGGGGGGGGG">
        <strong class="text-dark">Category:</strong> {{ proposal.social_category.name if proposal.social_category else 'N/A' }}
    </p>
    <p class="mb-2 text-muted- GGGGGGGGGGG small">
        {{ proposal.description | truncate(150) }}
    </p>

    <div class="row gx-3 gy-1 small text-muted align-items-center">
        <div class="col-auto">
            <strong>Status:</strong>
            {% if proposal.status == 'pending_leader_review' %}
                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">Pending Leader Review</span>
            {% elif proposal.status == 'pending_members_accept' %}
                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">Pending Member Acceptance ({{ accepted_count | default(0) }}/5)</span>
            {% elif proposal.status == 'accepted' %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">Accepted & Club Created</span>
            {% elif proposal.status == 'rejected' %}
                 <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">Rejected</span>
            {% else %}
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ proposal.status | title }}</span>
            {% endif %}
        </div>
        <div class="col-auto">
            <strong>Creator:</strong> {{ proposal.creator.full_name or proposal.creator.username if proposal.creator else 'N/A' }}
        </div>
        {% if proposal.reviewed_by %}
        <div class="col-auto">
            <strong>Reviewed By:</strong> {{ proposal.reviewed_by.full_name or proposal.reviewed_by.username }}
        </div>
         {% if proposal.reviewed_at %}
            <div class="col-auto"><strong>On:</strong> {{ proposal.reviewed_at | dateformat }}</div>
        {% endif %}
        {% endif %}
    </div>

    {% if proposal.leader_review_notes and (current_user.id == proposal.creator_id or current_user.is_tc_leader) %}
        <div class="mt-2 p-2 bg-light-subtle border rounded small">
            <strong class="d-block mb-1">Leader's Review Notes:</strong>
            <p class="mb-0 fst-italic">{{ proposal.leader_review_notes }}</p>
        </div>
    {% endif %}
</div>-e 

===== templates/partials/_asset_report_item.html =====
{# templates/partials/_asset_report_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase C.2 #}
{#
    Reusable item for displaying an asset report in a list.
    Expects a `report` object (AssetReport instance) in the context.
    - report.asset (related Asset object, can be None for general reports)
    - report.reporter (User object)
    - report.resolver (User object, can be None)
#}
<div class="list-group-item list-group-item-action flex-column align-items-start asset-report-item py-3 px-3 mb-2 shadow-sm border rounded">
    <div class="d-flex w-100 justify-content-between mb-2">
        <h6 class="mb-1 font-heading">
            <i class="bi {{ 'bi-tools text-danger' if report.status in ['Pending', 'In Progress'] else ('bi-check2-circle text-success' if report.status == 'Resolved' else 'bi-slash-circle text-secondary') }} me-2"></i>
            Report ID: {{ report.id }}
            {% if report.asset %}
                - For Asset: <a href="{{ url_for('edit_asset', asset_id=report.asset.id) if current_user.role.name in ['hr_ceo', 'system_admin'] else '#' }}"
                                class="text-decoration-none {% if not (current_user.role.name in ['hr_ceo', 'system_admin']) %} pe-none text-dark {% endif %}">
                                {{ report.asset.name }} (ID: {{ report.asset.id }})
                              </a>
            {% else %}
                <span class="fst-italic text-muted">- General Report</span>
            {% endif %}
        </h6>
        <small class="text-muted" title="{{ report.report_date | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
            {{ report.report_date | datetimeformat('%b %d, %Y') }}
        </small>
    </div>

    <p class="mb-2 text-muted- GGGGGGGGGGG">
        <strong class="text-dark">Issue:</strong> {{ report.damage_description | truncate(200) }}
    </p>

    <div class="row gx-3 gy-2 small text-muted align-items-center">
        <div class="col-auto">
            <strong>Status:</strong>
            {% if report.status == 'Pending' %}
                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
            {% elif report.status == 'In Progress' %}
                <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
            {% elif report.status == 'Resolved' %}
                <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
            {% elif report.status == 'Rejected' %}
                <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
            {% else %}
                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2 py-1">{{ report.status }}</span>
            {% endif %}
        </div>
        <div class="col-auto">
            <strong>Reported by:</strong> {{ report.reporter.full_name or report.reporter.username if report.reporter else 'N/A' }}
        </div>
        {% if report.date_of_damage %}
        <div class="col-auto">
            <strong>Damage Date:</strong> {{ report.date_of_damage | dateformat }}
        </div>
        {% endif %}
        <div class="col-auto">
            <strong>Qty Damaged:</strong> {{ report.quantity_damaged }}
        </div>
        {% if report.status == 'Resolved' or report.status == 'Rejected' %}
            {% if report.resolver %}
            <div class="col-auto">
                <strong>{{ report.status }} by:</strong> {{ report.resolver.full_name or report.resolver.username }}
            </div>
            {% endif %}
            {% if report.resolved_date %}
            <div class="col-auto">
                 <strong>{{ report.status }} on:</strong> {{ report.resolved_date | dateformat }}
            </div>
            {% endif %}
        {% endif %}
    </div>

    {% if report.resolution_notes and (report.status == 'Resolved' or report.status == 'Rejected') %}
        <div class="mt-2 p-2 bg-light-subtle border rounded small">
            <strong class="d-block mb-1">Resolution Notes:</strong>
            <p class="mb-0 fst-italic">{{ report.resolution_notes }}</p>
        </div>
    {% endif %}

    {# Action button for HR/CEO to resolve/view details #}
    {% if current_user.role.name in ['hr_ceo', 'system_admin'] and report.status not in ['Resolved', 'Rejected'] %}
        <div class="mt-3">
            <a href="{{ url_for('resolve_asset_report', report_id=report.id) }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-pencil-fill me-1"></i> Review/Resolve Report
            </a>
        </div>
    {% elif current_user.role.name in ['hr_ceo', 'system_admin'] %}
         <div class="mt-3">
            <a href="{{ url_for('resolve_asset_report', report_id=report.id) }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-eye-fill me-1"></i> View Resolved Details
            </a>
        </div>
    {% endif %}
</div>-e 

===== templates/partials/report_asset_general.html =====
{% extends "layout/base.html" %}

{% block page_title %}Report General Issue{% endblock %}

{% block content_header %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="page-title font-heading mb-0">
            <i class="bi bi-tools text-danger me-2"></i>Report General Asset Issue
        </h1>
        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> Cancel & Go Back
        </a>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-sm">
                 <div class="card-header bg-danger-subtle text-danger-emphasis">
                    <h5 class="mb-0 font-heading">General Issue Report Form</h5>
                </div>
                <div class="card-body p-4">
                    <p class="text-muted">
                        Use this form if you are reporting an issue that isn't tied to a specific asset in the inventory,
                        or if you cannot find the asset. Please be as descriptive as possible.
                    </p>

                    {% include 'layout/_flash_messages.html' %}

                    <form method="POST" action="{{ url_for('report_asset_general') }}" novalidate>
                        {{ form.hidden_tag() if form.hidden_tag }} {# CSRF Token #}

                        {# Optional: Add a field for user to describe the asset if known #}
                        <div class="mb-3">
                            <label for="assetNameDescription" class="form-label fw-medium">Asset Name/Identifier (if known)</label>
                            <input type="text" id="assetNameDescription" name="asset_name_description" class="form-control" placeholder="e.g., 'Broken chair in Room 102', 'Projector in main hall not working'">
                            <small class="form-text text-muted">Help us identify the item or location if this is not a cataloged asset.</small>
                        </div>

                        <div class="mb-3">
                            {{ form.damage_description.label(class="form-label fw-medium") }}
                            {{ form.damage_description(class="form-control" + (" is-invalid" if form.damage_description.errors else ""), rows="5", placeholder="Describe the issue in detail...") }}
                            {% if form.damage_description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.damage_description.errors %}<span>{{ error }}</span>{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.date_of_damage.label(class="form-label fw-medium") }}
                                {{ form.date_of_damage(class="form-control flatpickr-date" + (" is-invalid" if form.date_of_damage.errors else ""), placeholder="YYYY-MM-DD (Optional)") }}
                                {% if form.date_of_damage.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.date_of_damage.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.quantity_damaged.label(class="form-label fw-medium") }}
                                {{ form.quantity_damaged(class="form-control" + (" is-invalid" if form.quantity_damaged.errors else ""), type="number", min="1") }}
                                 <small class="form-text text-muted">Quantity of items affected.</small>
                                {% if form.quantity_damaged.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.quantity_damaged.errors %}<span>{{ error }}</span>{% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end">
                            <a href="javascript:history.back()" class="btn btn-outline-secondary me-2">Cancel</a>
                            {{ form.submit(class="btn btn-danger px-4", value="Submit General Report") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}-e 

===== templates/partials/_comment_item.html =====
{# templates/partials/_comment_item.html (Unified & Enhanced) #}
{#
    Context:
    - comment: The comment object (e.g., GlobalComment, ChannelComment)
               Expected attributes: id, content, timestamp, is_edited,
                                  author (User object with id, full_name, username, profile_photo_url),
                                  post_id (or parent_post_id if more generic)
    - current_user: The logged-in user.
    - post_type: 'global', 'channel', 'tc_feed' etc. (used for data attributes)
    - parent_post_author_id: ID of the author of the parent post
    - can_current_user_manage_parent_content: Boolean (e.g., is channel owner/admin)
#}
{% set post_type = post_type | default('global') %}
{% set commenter_name = comment.author.full_name or comment.author.username if comment.author else "Anonymous" %}
{% set commenter_avatar = comment.author.profile_photo_url or url_for('static', filename='img/placeholders/user_avatar_default.png') if comment.author else url_for('static', filename='img/placeholders/user_avatar_default.png') %}
{% set comment_dom_id = "comment-" ~ post_type ~ "-" ~ comment.id %}

<div class="social-comment-item d-flex mb-2 pt-2 {% if not loop or not loop.last %}pb-2 border-bottom border-light-subtle{% endif %}" id="{{ comment_dom_id }}" data-comment-id="{{ comment.id }}">
    <a href="{{ url_for('user_profile_view', user_id=comment.author.id) if comment.author else '#' }}" class="me-2 flex-shrink-0" aria-label="{{ commenter_name }}'s profile">
        <img src="{{ commenter_avatar }}" alt="{{ commenter_name }}" class="rounded-circle" width="32" height="32" style="object-fit: cover;">
    </a>
    <div class="flex-grow-1">
        <div class="comment-bubble bg-light-subtle p-2 rounded-3"> {# Added rounded-3 #}
            <div class="d-flex justify-content-between align-items-center mb-1">
                <a href="{{ url_for('user_profile_view', user_id=comment.author.id) if comment.author else '#' }}" class="text-decoration-none">
                    <small class="fw-bold text-dark font-heading">{{ commenter_name }}</small>
                </a>
                {# Comment Actions: Edit/Delete. Permissions refined. #}
                {% set can_edit = comment.author and comment.author.id == current_user.id %}
                {% set can_delete_own = can_edit %}
                {% set can_admin_delete = (parent_post_author_id and parent_post_author_id == current_user.id) or 
                                          can_current_user_manage_parent_content or 
                                          (current_user.role and current_user.role.name in ['system_admin', 'hr_ceo']) %}
                
                {% if can_edit or can_delete_own or can_admin_delete %}
                <div class="dropdown comment-actions ms-auto">
                    <button class="btn btn-sm btn-link text-muted py-0 px-1" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Comment options">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        {% if can_edit %}
                        <li><a class="dropdown-item edit-comment-btn" href="#" data-comment-id="{{ comment.id }}" data-post-id="{{ comment.post_id }}" data-post-type="{{ post_type }}"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                        {% endif %}
                        {% if can_delete_own or can_admin_delete %}
                        <li>
                            <button class="dropdown-item text-danger delete-comment-btn" data-comment-id="{{ comment.id }}" data-post-id="{{ comment.post_id }}" data-post-type="{{ post_type }}">
                                <i class="bi bi-trash me-2"></i>Delete
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
            <p class="mb-0 comment-content-text text-dark-emphasis small" id="comment-content-{{ comment_dom_id }}">{{ comment.content | nl2br | safe }}</p>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-1">
            <small class="text-muted ms-1 comment-timestamp" title="{{ comment.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
                {{ comment.timestamp | humanize_time_diff }}
                {% if comment.is_edited %} <span class="fst-italic ms-1">(edited)</span>{% endif %}
            </small>
            <div>
                {# Save Comment Button (Phase 2) #}
                <button class="btn btn-sm btn-link text-muted p-0 save-item-btn d-none" {# Hidden until Phase 2 #}
                        data-item-id="{{ comment.id }}" 
                        data-item-type="{{ post_type }}_comment" 
                        aria-label="Save comment">
                    <i class="bi bi-bookmark small"></i>
                </button>
                {# Reply to Comment (Future) #}
                {# <button class="btn btn-sm btn-link text-muted p-0 ms-2 reply-to-comment-btn" data-comment-id="{{ comment.id }}">
                    <i class="bi bi-reply small"></i> Reply
                </button> #}
            </div>
        </div>
    </div>
</div>-e 

===== templates/partials/_request_history_log_item.html =====
{# templates/partials/_request_history_log_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase H.1 #}
{#
    Reusable item for displaying a single request history entry.
    Expects a `history_item` object (RequestHistory instance) in the context.
    - history_item.changed_by (User object)
    - history_item.timestamp
    - history_item.action
    - history_item.old_status
    - history_item.new_status
    - history_item.notes
#}
<li class="list-group-item request-history-item py-2 px-3">
    <div class="d-flex w-100 justify-content-between">
        <small class="text-muted history-timestamp" title="{{ history_item.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
            <i class="bi bi-stopwatch-fill me-1"></i>{{ history_item.timestamp | humanize_time_diff }}
        </small>
        <small class="text-muted history-actor">
            By: {{ history_item.changed_by.full_name or history_item.changed_by.username if history_item.changed_by else 'System' }}
        </small>
    </div>
    <p class="mb-1 history-action- GGGGGGGGGGG">
        <strong class="font-heading">{{ history_item.action | title }}:</strong>
        {% if history_item.action == 'Submitted' %}
            Request submitted and status set to <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-1">{{ history_item.new_status }}</span>.
        {% elif history_item.old_status %}
            Status changed from <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-1">{{ history_item.old_status }}</span>
            to <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-1">{{ history_item.new_status }}</span>.
        {% else %}
            Status set to <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-1">{{ history_item.new_status }}</span>.
        {% endif %}
    </p>
    {% if history_item.notes %}
        <small class="d-block text-muted fst-italic history-notes ps-3 border-start border-secondary border-2" style="white-space: pre-wrap;">
            <i class="bi bi-blockquote-left me-1"></i> {{ history_item.notes | safe }} {# Safe if notes can contain simple HTML for formatting #}
        </small>
    {% endif %}
</li>-e 

===== templates/partials/_task_list_item.html =====
{# templates/partials/_task_list_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase G.2 #}
{#
    Reusable item for displaying a task in a list (e.g., My Tasks, Tasks I Assigned).
    Expects a `user_task` object (UserTask instance) for 'My Tasks' view,
    OR a `task` object (Task instance) for 'Tasks I Assigned' view.
    Also `current_user`.
    If `user_task` is provided, it represents the current user's specific assignment.
    If only `task` is provided, it's a general view of the task itself (e.g., for a creator).
#}

{% set t = user_task.task if user_task else task %}
{% set assignment_status = user_task.status if user_task else 'N/A' %}
{% set user_task_id_for_link = user_task.id if user_task else None %}

{# Determine link: if user_task, link to user_task_detail. If task (creator view), link to my_assigned_tasks_detail. #}
{% set detail_url = url_for('view_user_task', user_task_id=user_task_id_for_link) if user_task_id_for_link else url_for('view_assigned_task_detail', task_id=t.id) %}

<a href="{{ detail_url }}" class="list-group-item list-group-item-action task-list-item flex-column align-items-start py-3 px-3 mb-2 shadow-sm border rounded
    {% if assignment_status == 'Open' %} border-info-subtle border-start-info border-start-3
    {% elif assignment_status == 'In Progress' %} border-primary-subtle border-start-primary border-start-3
    {% elif assignment_status in ['Completed (Pending Review)', 'Delayed (Pending Review)', 'Rejected (Pending Review)'] %} border-warning-subtle border-start-warning border-start-3
    {% elif assignment_status == 'Accepted' %} border-success-subtle border-start-success border-start-3
    {% elif assignment_status == 'Review Rejected' %} border-danger-subtle border-start-danger border-start-3
    {% else %} border-light-subtle {% endif %}">

    <div class="d-flex w-100 justify-content-between mb-1">
        <h6 class="mb-1 font-heading task-title">
            <i class="bi bi-check2-square me-1"></i> {{ t.title | truncate(60) }}
        </h6>
        <small class="text-muted task-due-date" title="Due Date">
            {% if t.due_date %}
                <i class="bi bi-calendar-event me-1"></i> {{ t.due_date | dateformat }}
                {% if t.due_date < now.date() and assignment_status not in ['Accepted', 'Resolved'] %}
                    <span class="badge bg-danger-subtle text-danger-emphasis ms-1 rounded-pill">OVERDUE</span>
                {% elif (t.due_date - now.date()).days <= 2 and assignment_status not in ['Accepted', 'Resolved'] %}
                     <span class="badge bg-warning-subtle text-warning-emphasis ms-1 rounded-pill">DUE SOON</span>
                {% endif %}
            {% else %}
                No Due Date
            {% endif %}
        </small>
    </div>

    <p class="mb-2 text-muted- GGGGGGGGGGG small task-description">
        {{ t.description | truncate(120) }}
    </p>

    <div class="d-flex w-100 justify-content-between align-items-center small">
        <div>
            <span class="me-3" title="Urgency">
                <strong>Urgency:</strong>
                {% if t.urgency == 'Critical' %}<span class="badge bg-danger text-white rounded-pill px-2">{{ t.urgency }}</span>
                {% elif t.urgency == 'High' %}<span class="badge bg-warning text-dark rounded-pill px-2">{{ t.urgency }}</span>
                {% elif t.urgency == 'Medium' %}<span class="badge bg-info text-white rounded-pill px-2">{{ t.urgency }}</span>
                {% else %}<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">{{ t.urgency }}</span>
                {% endif %}
            </span>
            {% if user_task %} {# Display current user's assignment status #}
            <span title="Your Status">
                <strong>My Status:</strong>
                {% if assignment_status == 'Open' %} <span class="badge bg-info-subtle text-info-emphasis rounded-pill px-2">{{ assignment_status }}</span>
                {% elif assignment_status == 'In Progress' %} <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill px-2">{{ assignment_status }}</span>
                {% elif assignment_status.endswith('(Pending Review)') %} <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill px-2">{{ assignment_status }}</span>
                {% elif assignment_status == 'Accepted' %} <span class="badge bg-success-subtle text-success-emphasis rounded-pill px-2">{{ assignment_status }}</span>
                {% elif assignment_status == 'Review Rejected' %} <span class="badge bg-danger-subtle text-danger-emphasis rounded-pill px-2">Rejected by Reviewer</span>
                {% else %} <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill px-2">{{ assignment_status }}</span>
                {% endif %}
            </span>
            {% endif %}
        </div>
        <small class="text-muted task-creator">
            Created by: {{ t.created_by.full_name or t.created_by.username if t.created_by else 'N/A' }}
        </small>
    </div>
</a>