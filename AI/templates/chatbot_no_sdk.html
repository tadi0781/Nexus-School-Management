<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* static/style.css content from previous example can go here or in a separate file */
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .chat-container-card { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 0.75rem; height: 85vh; display: flex; flex-direction: column; max-width:700px; margin: auto;}
        .chat-window-card { flex-grow: 1; display: flex; flex-direction: column; padding: 1rem;}
        .chat-window { flex-grow: 1; overflow-y: auto; background-color: #ffffff; border-radius: 0.5rem; padding: 1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);}
        .message { display: flex; margin-bottom: 12px; }
        .message .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .user-message { justify-content: flex-end; }
        .user-message .message-content p { background-color: #0d6efd; color: white; border-radius: 18px 18px 5px 18px; }
        .user-message .message-content { display: flex; flex-direction: row-reverse; align-items: flex-start; max-width: 80%;}
        .user-message .avatar { margin-left: 8px; }
        .bot-message { justify-content: flex-start; }
        .bot-message .message-content p { background-color: #e9ecef; color: #212529; border-radius: 18px 18px 18px 5px; }
        .bot-message .message-content { display: flex; align-items: flex-start; max-width: 80%;}
        .bot-message .avatar { margin-right: 8px; }
        .message p { padding: 10px 15px; margin-bottom: 0; line-height: 1.45; word-wrap: break-word; }
        .card-header h4 i { vertical-align: middle; }
        #message-input { border-top-right-radius: 0; border-bottom-right-radius: 0;}
        #send-button { border-top-left-radius: 0; border-bottom-left-radius: 0;}
        /* Basic placeholder avatars */
        .avatar-placeholder-user { background-color: #0d6efd; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;}
        .avatar-placeholder-bot { background-color: #6c757d; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;}
    </style>
</head>
<body>

<div class="container mt-3 mb-3">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <div class="card chat-container-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-chat-dots-fill me-2"></i>{{ title }}</h4>
                    <button class="btn btn-sm btn-light" id="clear-chat-btn-http" title="Clear Chat History">
                        <i class="bi bi-trash3-fill"></i> Clear
                    </button>
                </div>

                {% if not gemini_enabled %}
                <div class="card-body">
                    <div class="alert alert-warning text-center" role="alert">
                        Chatbot functionality is currently disabled.
                    </div>
                </div>
                {% else %}
                <div class="card-body chat-window-card">
                    <div id="chat-window-http" class="chat-window mb-3">
                        <!-- Initial Bot Message -->
                        <div class="message bot-message mb-2">
                            <div class="message-content">
                                <div class="avatar avatar-placeholder-bot">B</div>
                                <p class="mb-0 p-2 rounded"><strong>Bot:</strong> {{ initial_bot_message }}</p>
                            </div>
                        </div>
                    </div>
                    <form id="chat-form-http" class="mt-auto">
                        <div class="input-group">
                            <input type="text" id="message-input-http" class="form-control form-control-lg" placeholder="Type your message..." autocomplete="off">
                            <button class="btn btn-primary btn-lg" type="submit" id="send-button-http">
                                <span class="spinner-border spinner-border-sm d-none me-1" role="status" aria-hidden="true" id="send-spinner-http"></span>
                                <i class="bi bi-send-fill"></i>
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% if gemini_enabled %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form-http');
    const messageInput = document.getElementById('message-input-http');
    const chatWindow = document.getElementById('chat-window-http');
    const sendButton = document.getElementById('send-button-http');
    const sendSpinner = document.getElementById('send-spinner-http');
    const clearChatButton = document.getElementById('clear-chat-btn-http');

    // Function to add a message to the chat window
    function addMessageToWindow(message, sender, isBlocked = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', 'mb-2');

        const messageContentDiv = document.createElement('div');
        messageContentDiv.classList.add('message-content');
        
        const p = document.createElement('p');
        p.classList.add('mb-0', 'p-2', 'rounded');
        
        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('avatar');

        let senderPrefix = '';
        if (sender === 'user') {
            messageDiv.classList.add('user-message');
            senderPrefix = '<strong>You:</strong> ';
            avatarDiv.classList.add('avatar-placeholder-user');
            avatarDiv.textContent = 'U'; // Placeholder
            avatarDiv.style.marginLeft = '8px';
        } else { // bot
            messageDiv.classList.add('bot-message');
            senderPrefix = '<strong>Bot:</strong> ';
            avatarDiv.classList.add('avatar-placeholder-bot');
            avatarDiv.textContent = 'B'; // Placeholder
            avatarDiv.style.marginRight = '8px';
            if (isBlocked) {
                 p.style.border = '1px solid #dc3545'; // Red border for blocked messages
                 p.style.backgroundColor = '#f8d7da';
                 p.style.color = '#721c24';
            }
        }

        // Sanitize message using Text constructor to prevent XSS
        const textNode = document.createTextNode(message);
        const tempDiv = document.createElement('div'); // Use a temp div for sender prefix
        tempDiv.innerHTML = senderPrefix;
        p.appendChild(tempDiv.firstChild); // Append the strong tag
        p.appendChild(textNode); // Append the sanitized message text

        if (sender === 'user') {
            messageContentDiv.appendChild(p);
            messageContentDiv.appendChild(avatarDiv);
        } else {
            messageContentDiv.appendChild(avatarDiv);
            messageContentDiv.appendChild(p);
        }
        messageDiv.appendChild(messageContentDiv);
        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    if (chatForm) {
        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            addMessageToWindow(userMessage, 'user');
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            sendSpinner.classList.remove('d-none');

            try {
                const response = await fetch('/api/chat_with_gemini_http', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'X-CSRFToken': getCsrfToken() // Add if CSRF is globally enforced
                    },
                    body: JSON.stringify({ message: userMessage })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessageToWindow(data.reply, 'bot', data.blocked);
                } else {
                    addMessageToWindow(data.error || 'An error occurred.', 'bot', true);
                }
            } catch (error) {
                console.error('Chat API Error:', error);
                addMessageToWindow('Could not connect to the chat service.', 'bot', true);
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendSpinner.classList.add('d-none');
                messageInput.focus();
            }
        });
    }

    if (clearChatButton) {
        clearChatButton.addEventListener('click', async function() {
            if (!confirm("Are you sure you want to clear the chat history?")) {
                return;
            }
            try {
                const response = await fetch('/api/clear_chat_history_http', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'X-CSRFToken': getCsrfToken() // Add if CSRF is globally enforced
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    chatWindow.innerHTML = ''; // Clear visually
                                         addMessageToWindow({{ initial_bot_message|tojson|safe }}, 'bot'); // Add initial message back // Add initial message back
                    alert(data.message);
                } else {
                    alert('Error: ' + (data.error || 'Could not clear history.'));
                }
            } catch (error) {
                console.error('Clear Chat API Error:', error);
                alert('Failed to clear chat history.');
            }
        });
    }
});
</script>
{% endif %}
</body>
</html>
