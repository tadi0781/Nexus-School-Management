{# templates/partials/_social_post_item.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase E.1 #}
{#
    Reusable item for displaying a single social post (e.g., in a channel or TC feed).
    Expects a `post` object (e.g., ChannelPost or TalentClubFeedPost) and `current_user` in the context.
    - post.author (User object)
    - post.content (text content)
    - post.file (File object, optional)
    - post.timestamp
    - post.id
    - post.comments (relationship to comments)
    - post.reactions (relationship to reactions)
    - post.channel / post.feed.talent_club (for context if needed, e.g., for permissions to comment/react)
#}

{% set author_name = post.author.full_name or post.author.username if post.author else "Anonymous" %}
{% set author_avatar = url_for('static', filename=(post.author.profile_photo_url if post.author and post.author.profile_photo_url else 'img/placeholders/user_avatar_default.png')) %}
{% set post_type = 'channel_post' if post.channel_id else ('tc_feed_post' if post.feed_id else 'unknown_post') %} {# Helps differentiate if needed #}

<div class="card shadow-sm social-post-item mb-4" id="{{ post_type }}-{{ post.id }}">
    <div class="card-header bg-transparent border-bottom-0 pt-3 pb-2">
        <div class="d-flex align-items-center">
            <a href="#" class="text-decoration-none"> {# Link to author's profile - placeholder #}
                <img src="{{ author_avatar }}" alt="{{ author_name }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
            </a>
            <div>
                <a href="#" class="text-decoration-none"> {# Link to author's profile - placeholder #}
                    <h6 class="mb-0 font-heading text-dark">{{ author_name }}</h6>
                </a>
                <small class="text-muted" title="{{ post.timestamp | datetimeformat('%Y-%m-%d %H:%M:%S UTC') }}">
                    {{ post.timestamp | humanize_time_diff }}
                    {% if post.is_edited %} (edited){% endif %}
                </small>
            </div>
            {# Post Actions Dropdown (Edit, Delete - for author or admins) #}
            {% if post.author_id == current_user.id or (post.channel and current_user.get_channel_role(post.channel) in ['owner', 'admin']) or (post.feed and post.feed.talent_club and post.feed.talent_club.owner_id == current_user.id) %}
            <div class="ms-auto">
                <div class="dropdown">
                    <button class="btn btn-sm btn-link text-muted" type="button" id="postActionsDropdown-{{ post.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postActionsDropdown-{{ post.id }}">
                        {% if post.author_id == current_user.id %}
                        <li><a class="dropdown-item edit-post-btn" href="#" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}"><i class="bi bi-pencil-square me-2"></i>Edit Post</a></li>
                        <li>
                            <button class="dropdown-item text-danger delete-post-btn" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}">
                                <i class="bi bi-trash-fill me-2"></i>Delete Post
                            </button>
                        </li>
                        {% elif (post.channel and current_user.get_channel_role(post.channel) in ['owner', 'admin']) or (post.feed and post.feed.talent_club and post.feed.talent_club.owner_id == current_user.id) %}
                         <li>
                            <button class="dropdown-item text-danger delete-post-btn" data-post-id="{{ post.id }}" data-post-type="{{ post_type }}">
                                <i class="bi bi-trash-fill me-2"></i>Delete Post (Admin)
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card-body pt-2">
        {% if post.content %}
            <p class="card-text post-content-text mb-2" id="post-content-{{ post.id }}">{{ post.content | nl2br | safe }}</p> {# nl2br for line breaks, safe if content is trusted #}
        {% endif %}

        {% if post.file %}
            <div class="post-attachment mt-2 mb-2 p-2 border rounded bg-light-subtle">
                {% if post.file.mimetype and post.file.mimetype.startswith('image/') %}
                    <a href="{{ url_for('download_social_file', file_id=post.file.id) }}" data-bs-toggle="lightbox" data-gallery="post-{{post.id}}-gallery">
                        <img src="{{ url_for('download_social_file', file_id=post.file.id) }}" class="img-fluid rounded" alt="{{ post.file.original_filename }}" style="max-height: 400px;">
                    </a>
                {% elif post.file.mimetype and post.file.mimetype.startswith('video/') %}
                    <video controls class="img-fluid rounded" style="max-height: 400px;">
                        <source src="{{ url_for('download_social_file', file_id=post.file.id) }}" type="{{ post.file.mimetype }}">
                        Your browser does not support the video tag.
                    </video>
                {% elif post.file.mimetype and post.file.mimetype.startswith('audio/') %}
                    <audio controls class="w-100 mt-2">
                        <source src="{{ url_for('download_social_file', file_id=post.file.id) }}" type="{{ post.file.mimetype }}">
                        Your browser does not support the audio element.
                    </audio>
                {% else %}
                    <div class="d-flex align-items-center p-2">
                        <i class="bi bi-file-earmark-text-fill fs-2 text-secondary me-2"></i>
                        <div>
                            <a href="{{ url_for('download_social_file', file_id=post.file.id) }}" class="fw-medium text-decoration-none stretched-link" download="{{ post.file.original_filename }}">
                                {{ post.file.original_filename }}
                            </a>
                            <small class="d-block text-muted">({{ (post.file.size / 1024 / 1024) | round(2) if post.file.size else '0' }} MB)</small>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="card-footer bg-transparent pt-2 pb-2">
        <div class="d-flex justify-content-start align-items-center post-actions">
            {# Reactions - Placeholder for dynamic reaction system #}
            <button class="btn btn-sm btn-outline-secondary reaction-btn me-2" data-post-id="{{ post.id }}" data-reaction-type="like" title="Like">
                <i class="bi bi-hand-thumbs-up"></i> <span class="reaction-count" data-count-type="like">{{ post.reactions.filter_by(emoji="üëç").count() if post.reactions else 0 }}</span>
            </button>
            <button class="btn btn-sm btn-outline-secondary reaction-btn me-2" data-post-id="{{ post.id }}" data-reaction-type="love" title="Love">
                <i class="bi bi-heart"></i> <span class="reaction-count" data-count-type="love">{{ post.reactions.filter_by(emoji="‚ù§Ô∏è").count() if post.reactions else 0 }}</span>
            </button>
            {# ... other reaction types ... #}

            <button class="btn btn-sm btn-outline-secondary comment-toggle-btn ms-auto" data-bs-toggle="collapse" href="#commentsCollapse-{{ post.id }}" role="button" aria-expanded="false" aria-controls="commentsCollapse-{{ post.id }}">
                <i class="bi bi-chat-square-text me-1"></i> Comments <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ post.comments | length if post.comments else 0 }}</span>
            </button>
             {# Share button placeholder #}
            {# <button class="btn btn-sm btn-outline-secondary ms-2 share-btn" data-share-url="{{ post.get_share_url() if post.get_share_url else '#' }}"><i class="bi bi-share-fill"></i></button> #}
        </div>
    </div>

    {# Collapsible Comments Section #}
    <div class="collapse comments-section border-top" id="commentsCollapse-{{ post.id }}">
        <div class="p-3">
            <div class="existing-comments mb-3" id="comments-list-{{ post.id }}" style="max-height: 300px; overflow-y: auto;">
                {% if post.comments and post.comments | length > 0 %}
                    {% for comment in post.comments | sort(attribute='timestamp') %} {# Oldest first for comments #}
                        {% include 'partials/_social_comment_item.html' %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted small text-center no-comments-yet">No comments yet. Be the first!</p>
                {% endif %}
            </div>
            {# Comment Form - only if comments are allowed by channel/feed settings #}
            {% set allow_comments = (post.channel and post.channel.allow_comments) or (post.feed and post.feed.allow_comments) or True %} {# Default to True if not in channel/feed context #}
            {% if allow_comments %}
            <form class="comment-form" data-post-id="{{ post.id }}" method="POST"> {# Action handled by JS #}
                <div class="input-group">
                    <textarea class="form-control form-control-sm comment-input" name="content" rows="1" placeholder="Write a comment..." aria-label="Write a comment"></textarea>
                    <button class="btn btn-sm btn-primary comment-submit-btn" type="submit">
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </form>
            {% else %}
            <p class="text-muted small fst-italic">Comments are disabled for this post.</p>
            {% endif %}
        </div>
    </div>
</div>