{# templates/layout/_sidebar.html - Nexus School Management System #}
{# Gemini 3 Pro Preview - Phase A.2 #}
{# MODIFIED FOR COLLAPSIBLE SIDEBAR #}
{# This is a base sidebar structure. Content will be dynamically generated by the backend #}
{# or a more specific _sidebar_[role].html partial can be included by base.html based on current_user.role #}

<nav id="sidebarMenu" class="nexus-sidebar"> {# <<<< ID ADDED HERE #}
    <div class="sidebar-sticky pt-3">
        {# <<<< CLOSE BUTTON ADDED HERE >>>> #}
        <button type="button" class="btn-close float-end mb-2 me-2" id="sidebarCloseButton" aria-label="Close sidebar"></button>
        <div style="clear:both;"></div> {# Ensure content after floated button is cleared #}

        {% if current_user.is_authenticated %}
            {# Profile Info Mini #}
            <div class="px-3 mb-3 text-center">
                 {% if current_user.profile_photo_url %}
                    <img src="{{ url_for('static', filename=current_user.profile_photo_url) }}" alt="{{ current_user.username }}" class="rounded-circle mb-2" style="width: 80px; height: 80px; object-fit: cover; border: 2px solid var(--nexus-border-color);">
                {% else %}
                    <i class="bi bi-person-circle text-secondary" style="font-size: 80px;"></i>
                {% endif %}
                <h6 class="mb-0 mt-2 font-heading">{{ current_user.full_name or current_user.username }}</h6>
                <small class="text-muted">{{ current_user.role.name.replace('_', ' ') | title if current_user.role else 'N/A' }}</small>
            </div>
            <hr class="mx-3 my-2">

            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.endpoint == 'role_redirect' or request.endpoint.endswith('_dashboard') else '' }}" href="{{ url_for('role_redirect') }}">
                        <i class="bi bi-speedometer2"></i>
                        Dashboard
                    </a>
                </li>

                {# --- Common Links for most roles --- #}
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.endpoint == 'contacts_list' or request.endpoint == 'universal_chat' else '' }}" href="{{ url_for('contacts_list') }}">
                        <i class="bi bi-chat-dots-fill"></i>
                        Chat / Contacts
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if request.endpoint == 'view_notifications' else '' }}" href="{{ url_for('view_notifications') }}">
                        <i class="bi bi-bell-fill"></i>
                        Notifications
                        {% if unread_notifications_count and unread_notifications_count > 0 %}
                            <span class="badge bg-danger rounded-pill ms-auto">{{ unread_notifications_count }}</span>
                        {% endif %}
                    </a>
                </li>

                {# --- Role Specific Sections --- #}
                {# Student Specific #}
                {% if current_user.role.name == 'student' %}
                    <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>My Academics</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'view_library' else '' }}" href="{{ url_for('view_library') }}">
                            <i class="bi bi-book-half"></i> My Borrowed Books
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'view_student_behavior_records' and request.view_args.get('user_id') == current_user.id else '' }}" href="{{ url_for('view_student_behavior_records', user_id=current_user.id) }}">
                            <i class="bi bi-clipboard2-check-fill"></i> My Behavior Records
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_tasks' else '' }}" href="{{ url_for('my_tasks') }}">
                            <i class="bi bi-list-task"></i> My Tasks
                        </a>
                    </li>

                    {# Social Media & Talent Club for Students #}
                     <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Social & Clubs</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint.startswith('social_channel_') else '' }}" href="{{ url_for('social_channel_list') }}">
                            <i class="bi bi-broadcast-pin"></i> Channels
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint.startswith('social_group_') else '' }}" href="{{ url_for('social_group_list') }}">
                            <i class="bi bi-people-fill"></i> Groups
                        </a>
                    </li>
                    {% if current_user.is_tc_member %}
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint.startswith('talent_club_') or request.endpoint == 'talent_club_dashboard' else '' }}" href="{{ url_for('talent_club_dashboard') }}">
                            <i class="bi bi-trophy-fill"></i> Talent Club
                        </a>
                    </li>
                    {% endif %}
                {% endif %}

                {# Teacher Specific #}
                {% if current_user.role.name == 'teacher' %}
                     <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Teaching Tools</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'enter_marks' else '' }}" href="{{ url_for('enter_marks') }}">
                            <i class="bi bi-pencil-square"></i> Enter Marks
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'mark_attendance' else '' }}" href="{{ url_for('mark_attendance') }}">
                            <i class="bi bi-calendar-check-fill"></i> Mark Attendance
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'teacher_lab_equipment' else '' }}" href="{{ url_for('teacher_lab_equipment') }}">
                            <i class="bi bi-binoculars-fill"></i> My Lab Equipment
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'student_database_index' or request.endpoint == 'student_database_block' else '' }}" href="{{ url_for('student_database_index') }}"> {# Teachers can view their class lists #}
                            <i class="bi bi-person-lines-fill"></i> Student Database
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_tasks' else '' }}" href="{{ url_for('my_tasks') }}">
                            <i class="bi bi-list-task"></i> My Tasks
                        </a>
                    </li>
                {% endif %}

                {# Librarian Specific #}
                {% if current_user.role.name == 'librarian' %}
                     <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Library Management</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'checkout_book' else '' }}" href="{{ url_for('checkout_book') }}">
                            <i class="bi bi-journal-arrow-up"></i> Checkout Book
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_checkouts' else '' }}" href="{{ url_for('list_checkouts') }}">
                            <i class="bi bi-journals"></i> All Checkouts
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'librarian_attendance' else '' }}" href="{{ url_for('librarian_attendance') }}">
                            <i class="bi bi-calendar3-week-fill"></i> Student Attendance
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_tasks' else '' }}" href="{{ url_for('my_tasks') }}">
                            <i class="bi bi-list-task"></i> My Tasks
                        </a>
                    </li>
                {% endif %}

                {# HR/CEO Specific #}
                {% if current_user.role.name == 'hr_ceo' %}
                    <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Management</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_pending_assets' else '' }}" href="{{ url_for('list_pending_assets') }}">
                            <i class="bi bi-box-seam-fill"></i> Pending Assets
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_all_assets' else '' }}" href="{{ url_for('list_all_assets') }}">
                            <i class="bi bi-boxes"></i> All Assets
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_asset_reports' else '' }}" href="{{ url_for('list_asset_reports') }}">
                            <i class="bi bi-flag-fill"></i> Asset Reports
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'manage_asset_categories' else '' }}" href="{{ url_for('manage_asset_categories') }}">
                            <i class="bi bi-tags-fill"></i> Asset Categories
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'student_database_index' else '' }}" href="{{ url_for('student_database_index') }}">
                            <i class="bi bi-person-lines-fill"></i> Student Database
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'manage_student_leaders' else '' }}" href="{{ url_for('manage_student_leaders') }}">
                            <i class="bi bi-person-check-fill"></i> Student Leaders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'manage_system_tc_leader' else '' }}" href="{{ url_for('manage_system_tc_leader') }}">
                            <i class="bi bi-trophy-fill"></i> TC Leader Admin
                        </a>
                    </li>
                    <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Tasks & Requests</span>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'create_task' else '' }}" href="{{ url_for('create_task') }}">
                            <i class="bi bi-plus-square-dotted"></i> Create Task
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_assigned_tasks' else '' }}" href="{{ url_for('my_assigned_tasks') }}">
                            <i class="bi bi-card-list"></i> Assigned Tasks
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'requests_inbox' else '' }}" href="{{ url_for('requests_inbox') }}">
                            <i class="bi bi-envelope-paper-fill"></i> Requests Inbox
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'hr_ceo_initiate_request' else '' }}" href="{{ url_for('hr_ceo_initiate_request') }}">
                            <i class="bi bi-send-plus-fill"></i> Initiate Request
                        </a>
                    </li>
                     <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Analytics</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'attendance_analytics' else '' }}" href="#" onclick="fetchAnalyticsData('attendance', 'Attendance Overview'); return false;">
                            <i class="bi bi-graph-up"></i> Attendance Data
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'performance_analytics' else '' }}" href="#" onclick="fetchAnalyticsData('performance', 'Performance Overview'); return false;">
                            <i class="bi bi-bar-chart-line-fill"></i> Performance Data
                        </a>
                    </li>
                    {# More analytics links can be added here #}
                {% endif %}

                {# System Admin Specific (add more as needed) #}
                {% if current_user.role.name == 'system_admin' %}
                    <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>System Admin</span>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#"> {# Placeholder for User Management #}
                            <i class="bi bi-people-fill"></i> User Management
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link" href="#"> {# Placeholder for System Logs #}
                            <i class="bi bi-hdd-stack-fill"></i> System Logs
                        </a>
                    </li>
                    {# HR/CEO links are often relevant for SysAdmin too #}
                    {# Consider duplicating or creating a helper macro for shared links #}
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_pending_assets' else '' }}" href="{{ url_for('list_pending_assets') }}">
                            <i class="bi bi-box-seam-fill"></i> Pending Assets
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'list_all_assets' else '' }}" href="{{ url_for('list_all_assets') }}">
                            <i class="bi bi-boxes"></i> All Assets
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'manage_asset_categories' else '' }}" href="{{ url_for('manage_asset_categories') }}">
                            <i class="bi bi-tags-fill"></i> Asset Categories
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'create_task' else '' }}" href="{{ url_for('create_task') }}">
                            <i class="bi bi-plus-square-dotted"></i> Create Task
                        </a>
                    </li>
                {% endif %}

                {# Common for users who can submit things #}
                {% if current_user.role.name in ['student', 'teacher', 'librarian', 'talent_club'] %}
                    <li class="sidebar-heading px-3 mt-4 mb-1 text-muted text-uppercase">
                        <span>Submissions</span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_assets' else '' }}" href="{{ url_for('my_assets') }}">
                            <i class="bi bi-folder-symlink-fill"></i> My Added Assets
                        </a>
                    </li>
                     <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'report_asset_general' else '' }}" href="{{ url_for('report_asset_general') }}">
                            <i class="bi bi-exclamation-triangle-fill"></i> Report General Issue
                        </a>
                    </li>
                    {% if permissions and permissions.can_create_request %} {# Check from get_request_permissions #}
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'submit_request' else '' }}" href="{{ url_for('submit_request') }}">
                            <i class="bi bi-file-earmark-plus-fill"></i> Submit Request
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'my_requests' else '' }}" href="{{ url_for('my_requests') }}">
                            <i class="bi bi-folder-check"></i> My Requests
                        </a>
                    </li>
                    {% endif %}
                {% endif %}


                {# Global Settings Link #}
                <li class="nav-item mt-auto mb-2"> {# Pushes to bottom if sidebar is tall #}
                     <hr class="mx-3 my-2">
                    <a class="nav-link {{ 'active' if request.endpoint == 'settings' else '' }}" href="{{ url_for('settings') }}">
                        <i class="bi bi-gear-wide-connected"></i>
                        Settings
                    </a>
                </li>
                <li class="nav-item">
                    <form action="{{ url_for('logout') }}" method="GET" class="d-inline w-100">
                         <button type="submit" class="nav-link border-0 bg-transparent w-100 text-start">
                            <i class="bi bi-box-arrow-left"></i>
                            Logout
                        </button>
                    </form>
                </li>
            </ul>
        {% endif %}
    </div>
</nav>